<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f5f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .main-header { background: #2c3e50; color: white; padding: 2rem; border-radius: 10px; margin-bottom: 2rem; border-left: 5px solid #3498db; }
    .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 10px; }
    .card-header { background: #34495e; color: white; border-radius: 10px 10px 0 0 !important; border-bottom: 3px solid #3498db; }
    #adminTree { background: #fff; padding: 20px; border-radius: 10px; border: 2px solid #e1e8ed; min-height: 300px; }
    .group-badge { margin:2px; cursor:pointer; transition: all 0.3s; }
    .group-badge:hover { transform: scale(1.05); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }
    .node-edit-input { display:inline-block; width:80%; }
    .btn-action { transition: all 0.3s; }
    .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .nav-tabs { border-bottom: 2px solid #e1e8ed; }
    .nav-tabs .nav-link { border: none; color: #34495e; font-weight: 500; }
    .nav-tabs .nav-link.active { background: #34495e; color: white; border-radius: 10px 10px 0 0; border-bottom: 3px solid #3498db; }
    .feature-card { transition: all 0.3s; cursor: pointer; }
    .feature-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    
    /* Custom Tree Table Styles */
    .tree-table { width: 100%; }
    .tree-table td { vertical-align: middle; padding: 8px; border-bottom: 1px solid #e1e8ed; }
    .tree-table tr:hover { background-color: #f8f9fa; }
    .tree-table tr.selected { background-color: #e3f2fd !important; border-left: 4px solid #3498db; }
    .tree-table tr.selected:hover { background-color: #d0e7ff !important; }
    .tree-node-indent { display: inline-block; width: 20px; }
    .tree-node-name { font-weight: 500; cursor: pointer; }
    .tree-node-name:hover { color: #3498db; }
    .tree-node-name .bi-folder2 { 
      color: #3498db !important; 
    }
    .tree-node-badge { font-size: 0.75em; padding: 3px 8px; border-radius: 12px; }
    .tree-action-btn { padding: 4px 8px; font-size: 0.85em; margin: 0 2px; }
    .tree-status-icon { font-size: 1.2em; cursor: pointer; transition: all 0.2s; }
    .tree-status-icon:hover { transform: scale(1.2); }
    .tree-status-icon.active { color: #e74c3c; }
    .tree-status-icon.inactive { color: #95a5a6; }
    .tree-groups-count { font-size: 0.85em; color: #3498db; cursor: pointer; }
    .tree-groups-count:hover { text-decoration: underline; }
  </style>
</head>
<body>
<div class="container mt-4">
  <!-- Header -->
  <div class="main-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2 class="mb-1"><i class="bi bi-folder-fill text-info"></i> Project Folders Management</h2>
        <p class="mb-0 text-light">Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</p>
      </div>
      <div class="col-md-4 text-end">
        <div class="badge bg-light text-dark p-2">
          <i class="bi bi-person-circle"></i> <span id="meEmail">â€”</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#approvalTab" type="button">
        <i class="bi bi-envelope-paper"></i> Send Approval Request
      </button>
    </li>
    <li class="nav-item" id="adminTabBtn" style="display:none;">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminStructureTab" type="button">
        <i class="bi bi-diagram-3"></i> Folder Structure
      </button>
    </li>
    <li class="nav-item" id="groupsTabBtn" style="display:none;">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#groupsAccessTab" type="button">
        <i class="bi bi-people"></i> Groups & Members
      </button>
    </li>
    <li class="nav-item" id="fileRestrictionsTabBtn" style="display:none;">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#fileRestrictionsTab" type="button">
        <i class="bi bi-shield-exclamation"></i> File Restrictions
      </button>
    </li>
    <li class="nav-item" id="featureSelectorTabBtn" style="display:none;">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#featureSelectorTab" type="button">
        <i class="bi bi-list-check"></i> Feature Selector
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Approval Tab -->
    <div class="tab-pane fade show active" id="approvalTab">
      <div class="row">
        <!-- Main Content: Send Approval Request -->
        <div class="col-lg-8 col-md-12">
          <div class="card">
            <div class="card-header py-2">
              <h6 class="mb-0"><i class="bi bi-envelope-paper"></i> Send Approval Request</h6>
            </div>
            <div class="card-body p-3">
              <div class="alert alert-info mb-2 py-2" style="font-size: 0.9em;">
                <i class="bi bi-info-circle"></i> <strong>How it works:</strong> Select the phase and enter the project name. An email will be sent for approval to create the folders.
              </div>

              <div class="row g-2">
                <div class="col-md-12">
                  <label class="form-label fw-bold small"><i class="bi bi-diagram-2"></i> Phase</label>
                  <select id="phase" class="form-select form-select-sm" onchange="togglePhase()">
                    <option value="bidding">ğŸ“‹ Bidding (RFP) - Create New Project</option>
                    <option value="project_delivery">ğŸš€ Project Delivery - Upgrade Existing Project</option>
          </select>
        </div>

                <div class="col-md-12" id="biddingSection">
                  <label class="form-label fw-bold small"><i class="bi bi-folder-plus"></i> Project Name</label>
                  <input type="text" id="projectName" class="form-control form-control-sm" placeholder="Enter project name (e.g., Project-2024)">
                  <div class="form-text small">A new folder will be created with name: PRJ-XXX-ProjectName</div>
        </div>

                <div class="col-md-12" id="deliverySection" style="display:none;">
                  <label class="form-label fw-bold small"><i class="bi bi-arrow-up-circle"></i> Select Project to Upgrade</label>
                  <select id="existingProjects" class="form-select form-select-sm">
                    <option value="">Loading...</option>
                  </select>
                  <div class="form-text small">Projects shown are those without a Project Delivery folder</div>
        </div>

                <div class="col-md-12">
                  <button class="btn btn-primary btn-sm w-100 btn-action" onclick="sendApproval()" id="sendApprovalBtn">
                    <span class="btn-text"><i class="bi bi-send"></i> Send Approval Request</span>
                    <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Sending...</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Side Card: Approval Recipients Management -->
        <div class="col-lg-4 col-md-12">
          <div class="card" style="position: sticky; top: 20px;">
            <div class="card-header py-2">
              <h6 class="mb-0"><i class="bi bi-envelope-at"></i> Approval Email Recipients</h6>
            </div>
            <div class="card-body p-3">
              <div class="alert alert-info mb-2 py-2" style="font-size: 0.85em;">
                <i class="bi bi-info-circle"></i> <strong>Note:</strong> All approval requests will be sent to mo.abuomar@dtgsa.com in addition to the list below.
              </div>
              
              <div class="mb-2">
                <div class="input-group input-group-sm">
                  <input type="email" id="newRecipientEmail" class="form-control form-control-sm" placeholder="Enter email">
                  <button class="btn btn-success btn-sm" onclick="addApprovalRecipient()">
                    <i class="bi bi-plus-circle"></i> Add
                  </button>
                </div>
              </div>
              
              <div id="recipientsList" class="mb-2" style="max-height: 300px; overflow-y: auto;">
                <div class="text-center text-muted">
                  <button class="btn btn-primary btn-sm w-100" onclick="loadApprovalRecipients()">
                    <i class="bi bi-download"></i> Load Recipients
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin: Folder Structure -->
    <div class="tab-pane fade" id="adminStructureTab">
      <!-- Quick Actions -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-tools"></i> Folder Management</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-light border mb-3">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-info-circle text-primary me-2"></i>
              <strong>ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong>
            </div>
            <ul class="mb-0 small">
              <li>Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø¬Ø±Ø© Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¥Ø¯Ø§Ø±ØªÙ‡</li>
              <li>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª</li>
              <li>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù†Ù‚Ø± Ù…Ø±ØªÙŠÙ† Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØªÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø©</li>
            </ul>
      </div>

          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-success btn-action" onclick="addChildNode()" id="addChildBtn">
              <i class="bi bi-plus-circle"></i> Add Child Folder
            </button>
            <button class="btn btn-success btn-action" onclick="addSiblingNode()" id="addSiblingBtn">
              <i class="bi bi-node-plus"></i> Add Sibling Folder
            </button>
            <button class="btn btn-warning btn-action" onclick="renameNode()" id="renameBtn">
              <i class="bi bi-pencil-square"></i> Rename
            </button>
            <button class="btn btn-danger btn-action" onclick="deleteNode()" id="deleteBtn">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>

      <!-- Main Layout: Tree on left, Settings & Actions on right -->
      <div class="row g-4">
        <!-- Left Column: Folder Tree -->
        <div class="col-lg-8">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Folder Structure</h5>
            </div>
            <div class="card-body p-0">
              <div class="alert alert-light border m-3 mb-0">
                <div class="d-flex align-items-center">
                  <i class="bi bi-info-circle text-primary me-2"></i>
                  <div class="small">
                    <strong>ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong> 
                    <span class="ms-2"><i class="bi bi-shield-lock-fill text-danger"></i> = Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù„Ø©</span>
                    <span class="ms-2"><i class="bi bi-people-fill text-primary"></i> = Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</span>
                    <span class="ms-2">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªØ­ÙƒÙ…</span>
                  </div>
                </div>
              </div>
              
              <div class="table-responsive" style="max-height: calc(100vh - 300px); overflow-y: auto;">
                <table class="table tree-table table-hover mb-0">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th style="width: 40%;">Folder Name</th>
                      <th style="width: 15%;" class="text-center">Protection</th>
                      <th style="width: 15%;" class="text-center">Groups</th>
                      <th style="width: 30%;" class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="treeTableBody">
                    <tr><td colspan="4" class="text-center text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Keep old tree for reference (hidden) -->
              <div id="adminTree" style="display:none;"></div>
            </div>
          </div>
        </div>

        <!-- Right Column: Settings & Actions -->
        <div class="col-lg-4">
          <!-- Folder Settings -->
          <div class="card mb-4" id="folderSettingsCard" style="display:none;">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Folder Permissions Settings</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-light border mb-3">
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-info-circle text-primary me-2"></i>
                  <strong>ÙƒÙŠÙ ØªØ¹Ù…Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§ØªØŸ</strong>
                </div>
                <ul class="mb-0 small">
                  <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª <strong>Ù…Ø±Ø¦ÙŠØ© Ù„Ù„Ø¬Ù…ÙŠØ¹</strong> ÙÙŠ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù…Ø§ Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ©)</li>
                  <li>Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ "Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¬Ù„Ø¯"ØŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø³ÙŠÙƒÙˆÙ† <strong>Ù…Ø­Ù…ÙŠ</strong> ÙˆØºÙŠØ± Ù…Ø±Ø¦ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹</li>
                  <li>ÙÙ‚Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø£Ø¯Ù†Ø§Ù‡ ÙŠÙ…ÙƒÙ†Ù‡Ø§ Ø±Ø¤ÙŠØ© ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯</li>
                </ul>
              </div>

              <!-- Protection Toggle -->
              <div class="card border-primary mb-3">
                <div class="card-body">
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="limitedAccessToggle" onchange="toggleLimitedAccess()" style="transform: scale(1.5);">
                    <label class="form-check-label fw-bold" for="limitedAccessToggle" style="font-size: 1.2em;">
                      ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¬Ù„Ø¯
                    </label>
                  </div>
                  <div class="text-muted">
                    Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ¹ÙŠÙ„: Ø§Ù„Ù…Ø¬Ù„Ø¯ Ù…Ø­Ù…ÙŠ ÙˆØºÙŠØ± Ù…Ø±Ø¦ÙŠ Ù„Ù„Ø¬Ù…ÙŠØ¹ØŒ ÙÙ‚Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø£Ø¯Ù†Ø§Ù‡ ÙŠÙ…ÙƒÙ†Ù‡Ø§ Ø±Ø¤ÙŠØªÙ‡ ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡
                  </div>
                </div>
              </div>

              <!-- Groups Section -->
              <div id="groupsSection">
                <h6 class="mb-3"><i class="bi bi-people-fill"></i> Allowed Groups</h6>
                
                <div class="alert alert-warning mb-3" id="protectionWarning" style="display:none;">
                  <i class="bi bi-exclamation-triangle"></i> <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¢Ù†ØŒ Ù„ÙƒÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³ØªØ·Ø¨Ù‚ ÙÙ‚Ø· Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ "Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¬Ù„Ø¯" Ø£Ø¹Ù„Ø§Ù‡.
                </div>
                
                <div id="groupList" class="mb-3 p-3 bg-light rounded" style="min-height: 60px;"></div>
                
                <div class="row g-2">
                  <div class="col-md-5">
                    <label class="form-label small fw-bold">Select Group</label>
                    <select id="groupSelect" class="form-select">
                      <option value="">-- Loading groups... --</option>
          </select>
        </div>
                  <div class="col-md-4">
                    <label class="form-label small fw-bold">Role</label>
                    <select id="groupRoleSelect" class="form-select">
                      <option value="reader" title="View only">Viewer</option>
                      <option value="commenter" title="View and comment">Commenter</option>
                      <option value="writer" title="Add, edit, and share files">Contributor</option>
                      <option value="fileOrganizer" title="Add, edit, move, delete and share content">Content manager</option>
                      <option value="organizer" title="Manage content, people, and settings">Manager</option>
                    </select>
                    <small class="text-muted" id="roleDescription" style="display: block; margin-top: 4px; font-size: 0.75em;"></small>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label small fw-bold">&nbsp;</label>
                    <button class="btn btn-success w-100 btn-action" onclick="addGroupToNode()">
                      <i class="bi bi-plus-circle"></i> Add
                    </button>
                  </div>
      </div>

                <div class="alert alert-info mt-3 mb-2">
                  <i class="bi bi-lightbulb"></i> <strong>Ù†ØµÙŠØ­Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹ Ø£Ø¯ÙˆØ§Ø± Ù…Ø®ØªÙ„ÙØ©. Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø³ØªØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ "Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¬Ù„Ø¯" Ø£Ø¹Ù„Ø§Ù‡.
                </div>
                
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-primary btn-sm" onclick="applyPermissionsToFolder()" title="Apply permissions to this folder">
                    <i class="bi bi-arrow-clockwise"></i> Apply Permissions to Folder
                  </button>
                </div>
              </div>

              <!-- No folder selected -->
              <div id="noFolderSelected" class="text-center text-muted py-5">
                <i class="bi bi-folder-x" style="font-size: 4em; opacity: 0.3;"></i>
                <p class="mt-3">Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯Ø§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø¬Ø±Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡</p>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-gear"></i> Main Operations</h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <button class="btn btn-primary w-100 btn-action" onclick="adminSaveStructure()" id="saveBtn">
                  <span class="btn-text"><i class="bi bi-save"></i> Save Structure</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</span>
                </button>
                <button class="btn btn-warning w-100 btn-action" onclick="adminApplyAll()" id="applyBtn">
                  <span class="btn-text"><i class="bi bi-arrow-repeat"></i> Apply to All Projects</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</span>
                </button>
                <button class="btn btn-info w-100 btn-action" onclick="applyLimitedAccessToAll()" id="limitedAccessBtn">
                  <span class="btn-text"><i class="bi bi-shield-lock"></i> Apply Protection to All</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</span>
                </button>
                <button class="btn btn-info w-100 btn-action" onclick="scanDuplicates()" id="scanBtn">
                  <span class="btn-text"><i class="bi bi-search"></i> Scan for Duplicates</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</span>
                </button>
                <button class="btn btn-success w-100 btn-action" onclick="updateFolderNames()" id="updateBtn">
                  <span class="btn-text"><i class="bi bi-arrow-clockwise"></i> Update Folder Names</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...</span>
                </button>
                <button class="btn btn-secondary w-100 btn-action" onclick="testMapping()" id="testBtn">
                  <span class="btn-text"><i class="bi bi-bug"></i> Test Mapping</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</span>
                </button>
                <button class="btn btn-danger w-100 btn-action" onclick="adminResetTemplate()" id="resetBtn">
                  <span class="btn-text"><i class="bi bi-arrow-counterclockwise"></i> Reset to Default</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†...</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin: Groups & Access -->
    <div class="tab-pane fade" id="groupsAccessTab">
      <!-- All Users with Groups -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-people-fill"></i> All Domain Users & Group Management</h5>
          <button class="btn btn-sm btn-primary" onclick="loadAllUsersWithGroups()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div class="card-body">
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i> <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠØ¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙ†ØªÙ…ÙˆÙ† Ø¥Ù„ÙŠÙ‡Ø§. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©. ÙŠØªØ·Ù„Ø¨ ØªÙØ¹ÙŠÙ„ AdminDirectory API.
      </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <input type="text" id="usersSearchInput" class="form-control" placeholder="Search by email or name..." onkeyup="filterUsersTable()">
            </div>
            <div class="col-md-6">
              <select id="filterByGroup" class="form-select" onchange="filterUsersByGroup()">
                <option value="">All Groups</option>
              </select>
            </div>
          </div>
          
          <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-hover table-sm">
              <thead class="table-light sticky-top">
                <tr>
                  <th style="width: 25%;">User</th>
                  <th style="width: 50%;">Groups</th>
                  <th style="width: 25%;">Actions</th>
                </tr>
              </thead>
              <tbody id="allUsersTableBody">
                <tr>
                  <td colspan="3" class="text-center text-muted">
                    <button class="btn btn-primary" onclick="loadAllUsersWithGroups()">
                      <i class="bi bi-download"></i> Load Users
                    </button>
                  </td>
                </tr>
              </tbody>
          </table>
          </div>
          </div>
        </div>

      <!-- Group Roles -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-shield-check"></i> Group Roles (Default Permissions)</h5>
          <button class="btn btn-sm btn-primary" onclick="loadGroupsForRoles()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div class="card-body">
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i> <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø®Ø§ØµØ© Ù„ÙƒÙ„ Ù…Ø¬Ù„Ø¯ Ù…Ù† ØªØ¨ÙˆÙŠØ¨ "Folder Structure".
        </div>

          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-hover">
              <thead class="table-light sticky-top">
                <tr>
                  <th style="width: 35%;">Group Name</th>
                  <th style="width: 35%;">Email</th>
                  <th style="width: 30%;">Default Role</th>
                </tr>
              </thead>
              <tbody id="groupsTableBody">
                <tr>
                  <td colspan="3" class="text-center text-muted">
                    <button class="btn btn-primary" onclick="loadGroupsForRoles()">
                      <i class="bi bi-download"></i> Load Groups
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-3">
            <button class="btn btn-success btn-action" onclick="savePolicy()">
              <i class="bi bi-save"></i> Save Policy
            </button>
          </div>
        </div>
      </div>


      <!-- System Actions -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-tools"></i> System Operations</h5>
          </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <button class="btn btn-outline-primary w-100 btn-action" onclick="syncAllNewOnly()">
                <i class="bi bi-lightning"></i> Sync New Projects Only
              </button>
          </div>
            <div class="col-md-4">
              <button class="btn btn-outline-danger w-100 btn-action" onclick="syncAllAudit()">
                <i class="bi bi-shield-check"></i> Sync All Projects
              </button>
          </div>
            <div class="col-md-4">
              <button class="btn btn-outline-secondary w-100 btn-action" onclick="loadLogs()">
                <i class="bi bi-journal-text"></i> View Logs
              </button>
        </div>
          </div>

          <div class="mt-3" id="logsBox" style="display:none;">
            <div class="card bg-light">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Recent Logs</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadLogs()">
                  <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
              </div>
              <div class="card-body">
                <div id="logsContent" class="mono small" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85em;"></div>
              </div>
            </div>
          </div>
          
        <div class="mt-3">
            <div class="card bg-info bg-opacity-10">
              <div class="card-body">
                <h6><i class="bi bi-bug"></i> Test Folder Permissions</h6>
                <p class="small text-muted">Enter a folder ID from Google Drive to test its permissions</p>
                <div class="input-group mb-2">
                  <input type="text" class="form-control" id="testFolderId" placeholder="Folder ID (e.g., 1abc123def456)">
                  <button class="btn btn-outline-primary" onclick="testFolderPermissions()">
                    <i class="bi bi-search"></i> Test
                  </button>
        </div>
                <div id="testPermissionsResult" class="mt-2" style="display:none;"></div>
              </div>
            </div>
      </div>
        </div>
      </div>
    </div>

    <!-- File Restrictions Tab -->
    <div class="tab-pane fade" id="fileRestrictionsTab">
      <div class="row">
        <div class="col-md-6">
          <!-- Blocked File Types -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-shield-x"></i> Blocked File Types</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle"></i> <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø±ÙØ¹Ù‡Ø§ ÙÙŠ Shared Drive.
              </div>
              
              <div class="mb-3">
                <div class="input-group">
                  <input type="text" id="newBlockedExtension" class="form-control" placeholder="Enter file extension (e.g., exe, bat, reg)" maxlength="10">
                  <button class="btn btn-danger" onclick="addBlockedExtension()">
                    <i class="bi bi-plus-circle"></i> Add
                  </button>
                </div>
                <small class="text-muted">Enter extension without dot (e.g., "exe" not ".exe")</small>
              </div>
              
              <div id="blockedExtensionsList" class="mb-3">
                <div class="text-center text-muted">
                  <button class="btn btn-primary" onclick="loadFileRestrictions()">
                    <i class="bi bi-download"></i> Load Blocked Extensions
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <!-- Allowed File Types (Whitelist) -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-shield-check"></i> Allowed File Types (Optional Whitelist)</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle"></i> <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø¥Ø°Ø§ Ù‚Ù…Øª Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ø¨Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹. Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©).
              </div>
              
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="whitelistEnabled" onchange="toggleWhitelist()">
                <label class="form-check-label" for="whitelistEnabled">
                  <strong>Enable Whitelist Mode</strong>
                </label>
              </div>
              
              <div class="mb-3">
                <div class="input-group">
                  <input type="text" id="newAllowedExtension" class="form-control" placeholder="Enter file extension (e.g., pdf, docx, xlsx)" maxlength="10">
                  <button class="btn btn-success" onclick="addAllowedExtension()">
                    <i class="bi bi-plus-circle"></i> Add
                  </button>
                </div>
                <small class="text-muted">Enter extension without dot (e.g., "pdf" not ".pdf")</small>
              </div>
              
              <div id="allowedExtensionsList" class="mb-3">
                <div class="text-center text-muted">
                  <button class="btn btn-primary" onclick="loadFileRestrictions()">
                    <i class="bi bi-download"></i> Load Allowed Extensions
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- File Monitoring Status -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-activity"></i> File Monitoring Status</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> <strong>ÙƒÙŠÙ ÙŠØ¹Ù…Ù„:</strong> ÙŠØªÙ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© ÙÙŠ Shared Drive ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ ÙÙˆØ±Ø§Ù‹ØŒ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ Ø±ÙØ¹Ù‡Ø§.
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span><strong>Monitoring Status:</strong></span>
                <span id="monitoringStatus" class="badge bg-secondary">Checking...</span>
              </div>
              <button class="btn btn-primary" onclick="checkMonitoringStatus()">
                <i class="bi bi-arrow-clockwise"></i> Refresh Status
              </button>
            </div>
            <div class="col-md-6">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span><strong>Last Check:</strong></span>
                <span id="lastCheckTime" class="text-muted">â€”</span>
              </div>
              <button class="btn btn-success" onclick="setupFileMonitoring()">
                <i class="bi bi-play-circle"></i> Setup/Enable Monitoring
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feature Selector Tab -->
    <div class="tab-pane fade" id="featureSelectorTab">
      <?!= include('FeatureSelector_Embedded'); ?>
    </div>
  </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header" style="background: #34495e; color: white; border-bottom: 3px solid #3498db;">
        <h5 class="modal-title"><i class="bi bi-info-circle-fill"></i> Ø§Ù„Ù†ØªÙŠØ¬Ø©</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalMessage" style="white-space: pre-wrap;"></div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.js"></script>
<script>
let isAdminUser=false, adminTreeData=[], adminSelectedPath=[], adminTreeWidget=null, accessPolicy=null;

function showModal(msg){
  document.getElementById('modalMessage').innerText = msg;
  new bootstrap.Modal(document.getElementById('resultModal')).show();
}

function setButtonLoading(buttonId, isLoading) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;
  
  const textSpan = btn.querySelector('.btn-text');
  const loadingSpan = btn.querySelector('.btn-loading');
  
  if (isLoading) {
    btn.disabled = true;
    if (textSpan) textSpan.style.display = 'none';
    if (loadingSpan) loadingSpan.style.display = 'inline';
  } else {
    btn.disabled = false;
    if (textSpan) textSpan.style.display = 'inline';
    if (loadingSpan) loadingSpan.style.display = 'none';
  }
}

function togglePhase(){
  const phase = document.getElementById('phase').value;
  if(phase === "bidding"){
    document.getElementById('biddingSection').style.display = "block";
    document.getElementById('deliverySection').style.display = "none";
  } else {
    document.getElementById('biddingSection').style.display = "none";
    document.getElementById('deliverySection').style.display = "block";
    google.script.run.withSuccessHandler(function(projects){
      const select = document.getElementById('existingProjects');
      select.innerHTML = "";
      if(!projects.length){
        const opt = document.createElement('option'); 
        opt.text = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ØªØ§Ø­Ø©"; 
        opt.value = "";
        select.add(opt); 
        return;
      }
      projects.forEach(p=>{ 
        const opt = document.createElement('option'); 
        opt.text = p; 
        opt.value = p; 
        select.add(opt); 
      });
    }).getProjectsWithoutPD();
  }
}

function sendApproval(){
  const phase = document.getElementById('phase').value;
  let name = "";
  if(phase === "bidding"){
    name = document.getElementById('projectName').value.trim();
    if(!name){ showModal("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"); return; }
  } else {
    name = document.getElementById('existingProjects').value;
    if(!name){ showModal("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø´Ø±ÙˆØ¹"); return; }
  }
  setButtonLoading('sendApprovalBtn', true);
  google.script.run
    .withSuccessHandler(function(msg){
      setButtonLoading('sendApprovalBtn', false);
      showModal(msg);
    })
    .withFailureHandler(function(e){
      setButtonLoading('sendApprovalBtn', false);
      showModal("Ø®Ø·Ø£: " + e.message);
    })
    .requestApproval(name, phase);
}

// Auth + initial loads
google.script.run.withSuccessHandler(function(info){
  isAdminUser = info && info.isAdmin;
  try { document.getElementById('meEmail').textContent = (info && (info.userEmail || info.user)) || ''; } catch(e) {}
  if (isAdminUser) {
    document.getElementById('adminTabBtn').style.display = 'block';
    document.getElementById('groupsTabBtn').style.display = 'block';
    document.getElementById('fileRestrictionsTabBtn').style.display = 'block';
    document.getElementById('featureSelectorTabBtn').style.display = 'block';
    loadAdminTree(); 
    loadAccessPolicy(); 
    populateFolderGroupSelect(); // Load groups for folder permissions
  }
}).getAuthInfo();

/*************** Admin Tree ***************/
function loadAdminTree(){ 
  google.script.run.withSuccessHandler(function(serverTree){ 
    adminTreeData = serverTree; 
    renderAdminTree(); 
  }).getTemplateTree(); 
}

function buildAdminNodes(nodes, path=[]){
  return nodes.map((n, idx)=>{ 
    const p=[...path, idx];
    // Build node text with permission indicators
    let nodeText = n.text;
    if (n.limitedAccess) {
      nodeText += ' <span class="tree-node-badge bg-danger text-white" title="Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù„Ø©"><i class="bi bi-shield-lock-fill"></i></span>';
    }
    if (n.groups && n.groups.length > 0) {
      // Support both old format (string array) and new format (object array)
      const groupNames = n.groups.map(g => typeof g === 'string' ? g : (g.name || g));
      nodeText += ` <span class="tree-node-groups" title="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: ${groupNames.join(', ')}"><i class="bi bi-people-fill"></i> ${n.groups.length}</span>`;
    }
    
    const o = { 
      text: nodeText, 
      _path: p,
      html: true // Enable HTML in node text
    }; 
    if(n.nodes) o.nodes=buildAdminNodes(n.nodes,p); 
    return o; 
  });
}

function renderAdminTree(){
  // Render custom tree table
  renderTreeTable();
  
  // Also render old tree for compatibility (hidden)
  const nodes = buildAdminNodes(adminTreeData);
  $('#adminTree').treeview('remove');
  adminTreeWidget = $('#adminTree').treeview({
    data: nodes,
    levels: 8,
    expandIcon: 'bi bi-plus-square',
    collapseIcon: 'bi bi-dash-square',
    emptyIcon: 'bi bi-square',
    nodeIcon: 'bi bi-folder2',
    onNodeSelected: function(event, node){ 
      adminSelectedPath = node._path; 
      renderGroupList(); 
    }
  });
}

/* Render custom tree table */
function renderTreeTable() {
  const tbody = document.getElementById('treeTableBody');
  // Save current selection before clearing
  const currentSelection = adminSelectedPath ? JSON.stringify(adminSelectedPath) : null;
  tbody.innerHTML = '';
  
  if (!adminTreeData || adminTreeData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù„Ø¯Ø§Øª</td></tr>';
    return;
  }
  
  // Render nodes recursively
  adminTreeData.forEach((node, index) => {
    renderTreeTableRow(node, [index], 0, tbody);
  });
  
  // Restore selection highlight after rendering
  if (currentSelection) {
    setTimeout(function() {
      highlightSelectedRow(currentSelection);
    }, 50);
  }
}

/* Highlight selected row */
function highlightSelectedRow(pathStr) {
  // Remove previous selection
  document.querySelectorAll('tr[data-path]').forEach(function(row) {
    row.classList.remove('selected');
  });
  
  // Add selection to current row
  const selectedRow = document.querySelector(`tr[data-path='${pathStr}']`);
  if (selectedRow) {
    selectedRow.classList.add('selected');
    // Scroll into view if needed
    selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

/* Render a single tree table row */
function renderTreeTableRow(node, path, depth, tbody) {
  const tr = document.createElement('tr');
  tr.setAttribute('data-path', JSON.stringify(path));
  tr.setAttribute('data-depth', depth);
  
  // Indentation
  const indent = '<span class="tree-node-indent"></span>'.repeat(depth);
  
  // Folder name with expand/collapse
  const hasChildren = node.nodes && node.nodes.length > 0;
  const isExpanded = node._expanded !== false; // Default to expanded
  const expandIcon = hasChildren ? 
    `<i class="bi ${isExpanded ? 'bi-chevron-down' : 'bi-chevron-right'} text-muted me-1" style="cursor: pointer;"></i>` : 
    '<span style="width: 16px; display: inline-block;"></span>';
  
  const nameCell = `
    <td>
      ${indent}
      ${expandIcon}
      <span class="tree-node-name" onclick="selectNodeFromTable('${JSON.stringify(path)}')" style="cursor: pointer;">
        <i class="bi bi-folder2 me-1"></i>
        ${node.text}
      </span>
    </td>
  `;
  
  // Add click handler for expand icon
  if (hasChildren) {
    tr.setAttribute('data-has-children', 'true');
  }
  
  // Protection status
  const isProtected = !!(node.limitedAccess);
  const protectionCell = `
    <td class="text-center">
      <i class="bi ${isProtected ? 'bi-shield-lock-fill tree-status-icon active' : 'bi-shield tree-status-icon inactive'}" 
         onclick="toggleNodeProtectionFromTable('${JSON.stringify(path)}')"
         title="${isProtected ? 'Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù„Ø© - Ø§Ø¶ØºØ· Ù„Ø¥Ù„ØºØ§Ø¡' : 'Ø­Ù…Ø§ÙŠØ© Ù…Ø¹Ø·Ù„Ø© - Ø§Ø¶ØºØ· Ù„Ù„ØªÙØ¹ÙŠÙ„'}">
      </i>
    </td>
  `;
  
  // Groups count
  const groupsCount = (node.groups && node.groups.length) || 0;
  const groupsCell = `
    <td class="text-center">
      ${groupsCount > 0 ? 
        `<span class="tree-groups-count" onclick="manageNodeGroups('${JSON.stringify(path)}')" title="Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: ${node.groups.join(', ')}">
          <i class="bi bi-people-fill"></i> ${groupsCount}
        </span>` : 
        '<span class="text-muted">-</span>'
      }
    </td>
  `;
  
  // Actions
  const actionsCell = `
    <td class="text-center">
      <button class="btn btn-sm btn-success tree-action-btn" onclick="addChildNodeFromTable('${JSON.stringify(path)}')" title="Add Child Folder">
        <i class="bi bi-plus-circle"></i>
      </button>
      <button class="btn btn-sm btn-warning tree-action-btn" onclick="renameNodeFromTable('${JSON.stringify(path)}')" title="Rename">
        <i class="bi bi-pencil"></i>
      </button>
      <button class="btn btn-sm btn-info tree-action-btn" onclick="selectNodeFromTable('${JSON.stringify(path)}')" title="Manage Permissions">
        <i class="bi bi-gear"></i>
      </button>
      <button class="btn btn-sm btn-danger tree-action-btn" onclick="deleteNodeFromTable('${JSON.stringify(path)}')" title="Delete">
        <i class="bi bi-trash"></i>
      </button>
    </td>
  `;
  
  tr.innerHTML = nameCell + protectionCell + groupsCell + actionsCell;
  tbody.appendChild(tr);
  
  // Add click handler for expand icon after rendering
  if (hasChildren) {
    setTimeout(function() {
      const expandIconEl = tr.querySelector('.bi-chevron-down, .bi-chevron-right');
      if (expandIconEl) {
        expandIconEl.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleTreeNode(JSON.stringify(path));
        });
      }
    }, 0);
  }
  
  // Render children if expanded (we'll track expanded state)
  if (hasChildren && isExpanded) {
    node.nodes.forEach((child, idx) => {
      renderTreeTableRow(child, [...path, idx], depth + 1, tbody);
    });
  }
}

/* Toggle tree node expand/collapse */
function toggleTreeNode(pathStr) {
  const path = JSON.parse(pathStr);
  const node = getNodeByPath(path);
  if (!node) return;
  
  // Toggle expanded state
  if (node._expanded === undefined) {
    node._expanded = false; // Collapse if was default expanded
  } else {
    node._expanded = !node._expanded;
  }
  
  // Re-render table (will restore selection automatically)
  renderTreeTable();
}

/* Toggle protection from table */
function toggleNodeProtectionFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  const node = getNodeByPath(path);
  if (!node) return;
  
  node.limitedAccess = !node.limitedAccess;
  
  google.script.run
    .withSuccessHandler(function(msg) {
      renderTreeTable();
      if (adminSelectedPath && JSON.stringify(adminSelectedPath) === pathStr) {
        renderGroupList();
      }
    })
    .withFailureHandler(function(e) {
      showModal("Ø®Ø·Ø£: " + (e && e.message ? e.message : e));
      node.limitedAccess = !node.limitedAccess;
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

/* Manage groups from table */
function manageNodeGroups(pathStr) {
  const path = JSON.parse(pathStr);
  selectNodeFromTable(pathStr);
}

/* Select node from table */
function selectNodeFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  adminSelectedPath = path;
  renderGroupList();
  
  // Highlight selected row
  highlightSelectedRow(pathStr);
  
  // Show settings card
  document.getElementById('folderSettingsCard').style.display = 'block';
}

/* Add child node from table */
function addChildNodeFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  adminSelectedPath = path;
  addChildNode();
}

/* Rename node from table */
function renameNodeFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  adminSelectedPath = path;
  renameNode();
}

/* Delete node from table */
function deleteNodeFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  adminSelectedPath = path;
  deleteNode();
}


function getNodeByPath(path){
  let cur = adminTreeData;
  for (let i=0;i<path.length;i++){ 
    cur = cur[path[i]]; 
    if (!cur) return null; 
    if (i < path.length-1) cur = cur.nodes; 
  }
  return cur || null;
}

function addChildNode(){ 
  const node=getNodeByPath(adminSelectedPath); 
  if(!node){
    showModal("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  } 
  const folderName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
  if(!folderName) return;
  
  node.nodes=node.nodes||[]; 
  node.nodes.push({text:folderName,nodes:[]}); 
  
  const folderType = (adminSelectedPath && adminSelectedPath.length && adminSelectedPath[0] === 0) ? 'RFP' : 'PD';
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree(); // Reload to refresh table
    })
    .withFailureHandler(function(err){
      showModal("Ø®Ø·Ø£: " + err.message);
    })
    .addFolderToTemplateFromUI(adminSelectedPath, folderName, folderType);
}

function addSiblingNode(){
  if (!adminSelectedPath.length){ 
    showModal("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ Ø£ÙˆÙ„Ø§Ù‹"); 
    return; 
  }
  const folderName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
  if(!folderName) return;
  
  let parent = adminTreeData;
  for (let i=0;i<adminSelectedPath.length-1;i++){ 
    parent = parent[adminSelectedPath[i]].nodes; 
  }
  parent.splice(adminSelectedPath[adminSelectedPath.length-1]+1,0,{text:folderName,nodes:[]}); 
  
  const folderType = (adminSelectedPath && adminSelectedPath.length && adminSelectedPath[0] === 0) ? 'RFP' : 'PD';
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree(); // Reload to refresh table
    })
    .withFailureHandler(function(err){
      showModal("Ø®Ø·Ø£: " + err.message);
    })
    .addFolderToTemplateFromUI(adminSelectedPath.slice(0, -1), folderName, folderType);
}

function renameNode(){ 
  const node=getNodeByPath(adminSelectedPath); 
  if(!node){
    showModal("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  } 
  const nv=prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:",node.text); 
  if(!nv)return; 
  
  const oldName = node.text;
  node.text=nv; 
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree(); // Reload to refresh table
    })
    .withFailureHandler(function(err){
      showModal("Ø®Ø·Ø£: " + err.message);
      node.text = oldName;
      loadAdminTree();
    })
    .renameFolderInTemplateFromUI(adminSelectedPath, nv);
}

function deleteNode(){
  if (!adminSelectedPath.length){ 
    showModal("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù„Ø¯ Ø£ÙˆÙ„Ø§Ù‹"); 
    return; 
  }
  
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ù…Ù† Ø§Ù„Ù‚Ø§Ù„Ø¨ØŸ (Ù„Ù† ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©)")) return;
  
  let parent = adminTreeData;
  for (let i=0;i<adminSelectedPath.length-1;i++){ 
    parent = parent[adminSelectedPath[i]].nodes; 
  }
  parent.splice(adminSelectedPath[adminSelectedPath.length-1],1); 
  adminSelectedPath=[]; 
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree(); // Reload to refresh table
      adminSelectedPath = [];
      renderGroupList();
    })
    .withFailureHandler(function(err){
      showModal("Ø®Ø·Ø£: " + err.message);
      loadAdminTree();
    })
    .removeFolderFromTemplateFromUI(adminSelectedPath);
}

/* Inline rename (double-click) - Deprecated, using table now */
function enableInlineRename() {
  // This function is no longer used with the new table design
  return;
  $('#adminTree').off('dblclick');
  
  $('#adminTree').on('dblclick', function(e) {
    e.stopPropagation();
    
    let $target = $(e.target);
    let $row = $target.closest('.list-group-item[data-nodeid]');
    
    if (!$row.length) {
      $row = $target.closest('[data-nodeid]');
    }
    if (!$row.length) {
      $row = $target.parents('.list-group-item').first();
    }
    
    if (!$row.length) return;
    
    let nodeId = $row.attr('data-nodeid') || $row.data('nodeid');
    if (!nodeId) return;
    
    nodeId = parseInt(nodeId);
    if (isNaN(nodeId)) return;
    
    const node = $('#adminTree').treeview('getNode', nodeId);
    if (!node || !Array.isArray(node._path)) return;
    
    let $textSpan = $row.find('.list-group-item-text').first();
    if (!$textSpan.length) {
      $textSpan = $row.find('span:not(.expand-icon):not(.node-icon):not(.check-icon):not(.bi)').first();
    }
    if (!$textSpan.length) {
      $textSpan = $row.find('.node-text').first();
    }
    if (!$textSpan.length || !$textSpan.text().trim()) {
      const nodeText = node.text || '';
      if (nodeText) {
        $textSpan = $row;
      } else {
        $textSpan = $row;
      }
    }
    
    const oldVal = ($textSpan.text().trim() || node.text || '').trim();
    if (!oldVal) return;
    
    if ($('#adminTree').find('input.node-edit-input').length) return;
    
    const $input = $('<input type="text" class="form-control form-control-sm node-edit-input" style="width:100%;padding:2px 5px;" />').val(oldVal);
    $textSpan.css('visibility','hidden'); 
    $textSpan.after($input); 
    $input.trigger('focus').select();
    
    const commit = () => {
      const newVal = ($input.val() || '').trim();
      $input.remove(); 
      $textSpan.css('visibility','');
      if (!newVal || newVal === oldVal) return;
      
      const target = getNodeByPath(node._path); 
      if (!target) return;
      
      const oldName = target.text;
      target.text = newVal;
      const keepPath = node._path.slice(); 
      
      google.script.run
        .withSuccessHandler(function(result){
          showModal(result);
          renderAdminTree();
      try {
        const selNode = findNodeByPathInWidget(keepPath);
            if (selNode) { 
              $('#adminTree').treeview('selectNode', [selNode.nodeId, { silent: true }]); 
              adminSelectedPath = keepPath; 
            }
      } catch(_) {}
        })
        .withFailureHandler(function(err){
          showModal('Ø®Ø·Ø£: ' + (err && err.message ? err.message : err));
          target.text = oldName;
          renderAdminTree();
        })
        .renameFolderInTemplateFromUI(keepPath, newVal);
    };
    
    const cancel = () => { 
      $input.remove(); 
      $textSpan.css('visibility',''); 
    };
    
    $input.on('keydown', function (ev) { 
      if (ev.key === 'Enter') { 
        ev.preventDefault(); 
        ev.stopPropagation();
        commit(); 
      } else if (ev.key === 'Escape') { 
        ev.preventDefault(); 
        ev.stopPropagation();
        cancel(); 
      }
    });
    $input.on('blur', commit);
  });
}

function findNodeByPathInWidget(pathArr) {
  const nodes = $('#adminTree').treeview('getEnabled');
  for (const n of nodes) {
    if (Array.isArray(n._path) && n._path.length === pathArr.length) {
      let same = true;
      for (let i = 0; i < pathArr.length; i++) { 
        if (n._path[i] !== pathArr[i]) { 
          same = false; 
          break; 
        } 
      }
      if (same) return n;
    }
  }
  return null;
}

/* Groups per node */
function renderGroupList(){
  const node = getNodeByPath(adminSelectedPath);
  const container = document.getElementById('groupList');
  const folderSettingsCard = document.getElementById('folderSettingsCard');
  const noFolderSelected = document.getElementById('noFolderSelected');
  const groupsSection = document.getElementById('groupsSection');
  
  if (!node){ 
    folderSettingsCard.style.display = 'none';
    return; 
  }
  
  folderSettingsCard.style.display = 'block';
  if (noFolderSelected) noFolderSelected.style.display = 'none';
  
  const toggle = document.getElementById('limitedAccessToggle');
  toggle.disabled = false;
  toggle.checked = !!(node.limitedAccess);
  
  // Always show groups section, but show warning if protection is not enabled
  groupsSection.style.display = 'block';
  const protectionWarning = document.getElementById('protectionWarning');
  if (protectionWarning) {
    if (node.limitedAccess) {
      protectionWarning.style.display = 'none';
    } else {
      protectionWarning.style.display = 'block';
    }
  }
  
  // Allow adding groups even if protection is not enabled
  // Groups will be applied when protection is enabled
  const groupSelect = document.getElementById('groupSelect');
  const roleSelect = document.getElementById('groupRoleSelect');
  if (groupSelect) {
    groupSelect.disabled = false; // Always enabled
  }
  if (roleSelect) {
    roleSelect.disabled = false; // Always enabled
  }
  
  node.groups = node.groups || [];
  if (node.groups.length === 0) {
    container.innerHTML = '<div class="text-muted text-center py-3"><i class="bi bi-inbox"></i> Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø­Ø¯Ø¯Ø©</div>';
  } else {
    container.innerHTML = '';
    node.groups.forEach((g, idx) => {
      // Support both old format (string) and new format (object)
      const groupName = typeof g === 'string' ? g : (g.name || g);
      const groupRole = typeof g === 'object' && g.role ? g.role : 'reader';
      
      const badge = document.createElement('span');
      badge.className = 'badge bg-primary me-2 mb-2 p-2 d-inline-flex align-items-center';
      badge.style.fontSize = '0.95em';
      badge.style.cursor = 'pointer';
      
      const roleBadge = getRoleBadgeColor(groupRole);
      badge.innerHTML = `
        <i class="bi bi-people me-1"></i> 
        <strong>${groupName}</strong>
        <span class="badge ${roleBadge} ms-2" style="font-size: 0.75em;">${getRoleLabel(groupRole)}</span>
        <i class="bi bi-x-circle ms-2" onclick="event.stopPropagation(); removeGroupFromNode('${groupName}');"></i>
      `;
      badge.onclick = () => removeGroupFromNode(groupName);
      container.appendChild(badge);
    });
  }
}

function getRoleBadgeColor(role) {
  const colors = {
    'reader': 'bg-secondary',
    'commenter': 'bg-info',
    'writer': 'bg-warning',
    'fileOrganizer': 'bg-primary',
    'organizer': 'bg-danger',
    'owner': 'bg-danger' // For backward compatibility
  };
  return colors[role] || 'bg-secondary';
}

function getRoleLabel(role) {
  const labels = {
    'reader': 'Viewer',
    'commenter': 'Commenter',
    'writer': 'Contributor',
    'fileOrganizer': 'Content manager',
    'organizer': 'Manager',
    'owner': 'Manager' // For backward compatibility, owner maps to Manager
  };
  return labels[role] || role;
}

function toggleLimitedAccess(){
  const node = getNodeByPath(adminSelectedPath);
  if (!node){ 
    showModal("Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"); 
    return; 
  }
  
  const isEnabled = document.getElementById('limitedAccessToggle').checked;
  node.limitedAccess = isEnabled;
  
  const groupsSection = document.getElementById('groupsSection');
  groupsSection.style.display = 'block';
  
  const protectionWarning = document.getElementById('protectionWarning');
  const groupSelect = document.getElementById('groupSelect');
  const roleSelect = document.getElementById('groupRoleSelect');
  
  if (isEnabled) {
    if (protectionWarning) protectionWarning.style.display = 'none';
    // Groups can always be added, but they only apply when protection is enabled
    if (groupSelect) groupSelect.disabled = false;
    if (roleSelect) roleSelect.disabled = false;
  } else {
    if (protectionWarning) protectionWarning.style.display = 'block';
    // Keep groups enabled even when protection is off - user can prepare groups in advance
    if (groupSelect) groupSelect.disabled = false;
    if (roleSelect) roleSelect.disabled = false;
    if (!isEnabled && node.groups && node.groups.length > 0) {
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ©ØŸ')) {
        node.groups = [];
      }
    }
  }
  
  renderGroupList();
  
  google.script.run
    .withSuccessHandler(msg=>{
      renderTreeTable(); // Re-render table to update icons
    })
    .withFailureHandler(e=>{
      showModal("Ø®Ø·Ø£: "+(e&&e.message?e.message:e));
      node.limitedAccess = !isEnabled;
      renderGroupList();
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

function addGroupToNode(){
  const node = getNodeByPath(adminSelectedPath);
  if (!node){ 
    showModal("Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"); 
    return; 
  }
  
  const groupSelect = document.getElementById('groupSelect');
  const roleSelect = document.getElementById('groupRoleSelect');
  const g = groupSelect.value;
  const role = roleSelect.value || 'reader';
  
  if (!g) {
    showModal("Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©");
    return;
  }
  
  node.groups = node.groups || [];
  
  // Check if group already exists (support both old and new format)
  const exists = node.groups.some(grp => {
    const name = typeof grp === 'string' ? grp : (grp.name || grp);
    return name === g;
  });
  
  if (exists) {
    showModal("Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„");
    return;
  }
  
  // Add group with role (new format: object)
  node.groups.push({ name: g, role: role });
  groupSelect.value = '';
  roleSelect.value = 'reader';
  renderGroupList();
  
  google.script.run
    .withSuccessHandler(msg => {
      renderTreeTable(); // Re-render table to update icons
    })
    .withFailureHandler(e => {
      showModal("Ø®Ø·Ø£: " + (e && e.message ? e.message : e));
      node.groups = node.groups.filter(grp => {
        const name = typeof grp === 'string' ? grp : (grp.name || grp);
        return name !== g;
      });
      renderGroupList();
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

function removeGroupFromNode(g){
  const node = getNodeByPath(adminSelectedPath);
  if (!node) return;
  
  if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© "${g}" Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯ØŸ`)) {
    return;
  }
  
  // Remove group (support both old and new format)
  node.groups = (node.groups || []).filter(grp => {
    const name = typeof grp === 'string' ? grp : (grp.name || grp);
    return name !== g;
  });
  renderGroupList();
  
  google.script.run
    .withSuccessHandler(msg => {
      renderTreeTable(); // Re-render table to update icons
    })
    .withFailureHandler(e => {
      showModal("Ø®Ø·Ø£: " + (e && e.message ? e.message : e));
      // Restore group (add back with default role)
      node.groups.push({ name: g, role: 'reader' });
      renderGroupList();
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

/* Apply permissions to selected folder */
function applyPermissionsToFolder(){
  const node = getNodeByPath(adminSelectedPath);
  if (!node){ 
    showModal("Ø§Ø®ØªØ± Ù…Ø¬Ù„Ø¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹"); 
    return; 
  }
  
  if (!node.limitedAccess) {
    showModal("ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ 'Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¬Ù„Ø¯' Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù„Ø¯");
    return;
  }
  
  if (!node.groups || node.groups.length === 0) {
    showModal("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø­Ø¯Ø¯Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯. Ø£Ø¶Ù Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }
  
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ØŸ\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø¹Ø¯Ø© Ø¯Ù‚Ø§Ø¦Ù‚. ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ù…Ù† Ø®Ù„Ø§Ù„ ØªØ¨ÙˆÙŠØ¨ "Groups & Members" â†’ "Recent Logs".')) {
    return;
  }
  
  // Show processing message
  showModal('Processing... This may take several minutes. Please wait...\n\nYou can check the logs in "Groups & Members" tab to see progress.');
  
  google.script.run
    .withSuccessHandler(msg => {
      showModal('âœ… ' + msg + '\n\nCheck the logs in "Groups & Members" tab for detailed information.');
    })
    .withFailureHandler(e => {
      let errorMsg = e.message || e;
      if (errorMsg.includes('timeout') || errorMsg.includes('exceeded')) {
        errorMsg = 'The operation timed out. Some projects may have been processed. Check the logs for details.';
      }
      showModal("âŒ Error: " + errorMsg + '\n\nCheck the logs in "Groups & Members" tab for more details.');
    })
    .applyPermissionsToFolder(adminSelectedPath);
}

/* Save / Apply / Reset */
function adminSaveStructure(){ 
  setButtonLoading('saveBtn', true);
  google.script.run
    .withSuccessHandler(function(msg){
      setButtonLoading('saveBtn', false);
      showModal(msg);
    })
    .withFailureHandler(function(e){
      setButtonLoading('saveBtn', false);
      showModal("Ø®Ø·Ø£: "+e.message);
    })
    .saveConfig(adminTreeData); 
}

function adminApplyAll(){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ØŸ Ø³ÙŠØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ù…Ø¹ domain ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.")) return;
  setButtonLoading('applyBtn', true);
  google.script.run
    .withSuccessHandler(function(msg){
      setButtonLoading('applyBtn', false);
      showModal(msg);
    })
    .withFailureHandler(function(e){
      setButtonLoading('applyBtn', false);
      showModal("Ø®Ø·Ø£: "+e.message);
    })
    .applyConfigToAllProjectsSharedDrive();
}

function applyLimitedAccessToAll(){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙÙŠÙ‡Ø§.\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø¹Ø¯Ø© Ø¯Ù‚Ø§Ø¦Ù‚ Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹.")) return;
  setButtonLoading('limitedAccessBtn', true);
  
  // Show progress message
  showModal('Processing... This may take several minutes. Please wait...\n\nYou can check the logs in "Groups & Members" tab to see progress.');
  
  google.script.run
    .withSuccessHandler(function(msg){
      setButtonLoading('limitedAccessBtn', false);
      showModal('âœ… ' + msg + '\n\nCheck the logs in "Groups & Members" tab for detailed information.');
    })
    .withFailureHandler(function(e){
      setButtonLoading('limitedAccessBtn', false);
      let errorMsg = e.message || e;
      if (errorMsg.includes('timeout') || errorMsg.includes('exceeded')) {
        errorMsg = 'âš ï¸ Operation timed out. This may happen if there are many projects.\n\n' +
          'The process may have partially completed. Please check the logs in "Groups & Members" tab.\n\n' +
          'You can try running the operation again - it will continue from where it left off.';
      }
      showModal("âŒ Ø®Ø·Ø£: " + errorMsg);
    })
    .applyLimitedAccessToAllProjects();
}

function adminResetTemplate(){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ù„Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØŸ")) return;
  setButtonLoading('resetBtn', true);
  google.script.run
    .withSuccessHandler(function(msg){ 
      setButtonLoading('resetBtn', false);
      showModal(msg); 
      loadAdminTree(); 
    })
    .withFailureHandler(function(e){
      setButtonLoading('resetBtn', false);
      showModal("Ø®Ø·Ø£: "+e.message);
    })
    .resetTemplateConfig();
}

function scanDuplicates(){
  setButtonLoading('scanBtn', true);
  google.script.run
    .withSuccessHandler(function(result){
      setButtonLoading('scanBtn', false);
      let message = result.summary + '\n\n';
      if(result.duplicates.length > 0){
        message += 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ù…ÙƒØ±Ø±Ø©:\n';
        result.duplicates.forEach(dup => {
          message += `\nâ€¢ ${dup.projectName}:\n`;
          dup.projects.forEach(proj => {
            message += `  - ${proj.title} (PRJ-${proj.pr})\n`;
          });
        });
      } else {
        message += 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ÙƒØ±Ø±Ø©!';
      }
      showModal(message);
    })
    .withFailureHandler(function(e){
      setButtonLoading('scanBtn', false);
      showModal("Ø®Ø·Ø£: "+e.message);
    })
    .scanForDuplicateProjects();
}

function updateFolderNames(){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„ØµÙŠØºØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŸ")) return;
  setButtonLoading('updateBtn', true);
  google.script.run
    .withSuccessHandler(function(result){
      setButtonLoading('updateBtn', false);
      showModal(result.summary);
    })
    .withFailureHandler(function(e){
      setButtonLoading('updateBtn', false);
      showModal("Ø®Ø·Ø£: "+e.message);
    })
    .updateExistingProjectFolderNames();
}

function testMapping(){
  const folderName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù„Ø¯ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ù…Ø«Ø§Ù„: 'Technical'):");
  if(!folderName) return;
  
  const nodePath = adminSelectedPath || [0, 0];
  setButtonLoading('testBtn', true);
  
  google.script.run
    .withSuccessHandler(function(results){
      setButtonLoading('testBtn', false);
      let message = `ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù€ '${folderName}':\n\n`;
      results.forEach(result => {
        if(result.error) {
          message += `âŒ ${result.project}: ${result.error}\n\n`;
        } else {
          message += `âœ… ${result.project} (PRJ-${result.pr}):\n`;
          message += `   ğŸ” Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø­Ø«: ${result.searchMethod}\n`;
          message += `   ğŸ“ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰: ${result.foundFolders.length} Ù…Ø¬Ù„Ø¯\n`;
          if(result.foundFolders.length > 0) {
            message += `   ğŸ“‚ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª: ${result.foundFolders.join(', ')}\n`;
          }
          message += `\n`;
        }
      });
      showModal(message);
    })
    .withFailureHandler(function(e){
      setButtonLoading('testBtn', false);
      showModal("Ø®Ø·Ø£: "+e.message);
    })
    .testTreeToDriveMapping(nodePath, folderName);
}

/*************** Access policy & logs ***************/
function loadAccessPolicy(){ 
  google.script.run
    .withSuccessHandler(function(policy){ 
      accessPolicy=policy; 
      renderAccessPolicy(); 
    })
    .getAccessPolicy(); 
}

function renderAccessPolicy(){
  const tbody=document.getElementById('groupsTableBody'); 
  tbody.innerHTML=''; 
  const groups=accessPolicy.groups||{};
  
  if (Object.keys(groups).length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø­Ø¯Ø¯Ø©</td></tr>';
    return;
  }
  
  Object.keys(groups).forEach(g=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${g}</td>
      <td>${groups[g].email || g}</td>
      <td>
        <select class="form-select form-select-sm role-select" data-group="${g}">
          <option value="reader" ${groups[g].role==='reader'?'selected':''} title="View only">Viewer</option>
          <option value="commenter" ${groups[g].role==='commenter'?'selected':''} title="View and comment">Commenter</option>
          <option value="writer" ${groups[g].role==='writer'?'selected':''} title="Add, edit, and share files">Contributor</option>
          <option value="fileOrganizer" ${groups[g].role==='fileOrganizer'?'selected':''} title="Add, edit, move, delete and share content">Content manager</option>
          <option value="organizer" ${groups[g].role==='organizer' || groups[g].role==='owner'?'selected':''} title="Manage content, people, and settings">Manager</option>
        </select>
      </td>`;
    tbody.appendChild(tr);
  });
  
  document.getElementById('protCopy').checked = !!(accessPolicy.protection && accessPolicy.protection.viewersCanCopyContent);
  document.getElementById('protWriterCopy').checked = !!(accessPolicy.protection && accessPolicy.protection.copyRequiresWriterPermission);
}

/* Load all groups from Google Workspace and display them with their roles */
function loadGroupsForRoles(){
  const tbody = document.getElementById('groupsTableBody');
  tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Loading groups...</td></tr>';
  
  // Load access policy first to get saved roles
  google.script.run
    .withSuccessHandler(function(policy){
      accessPolicy = policy || { groups: {}, protection: {} };
      const savedGroups = accessPolicy.groups || {};
      
      // Then load all groups from Google Workspace
      google.script.run
        .withSuccessHandler(function(groupsMap){
          const entries = Object.entries(groupsMap || {});
          
          if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No groups found</td></tr>';
            return;
          }
          
          tbody.innerHTML = '';
          
          // Sort by group name
          entries.sort((a, b) => a[0].localeCompare(b[0]));
          
          entries.forEach(([groupName, groupEmail]) => {
            const tr = document.createElement('tr');
            const savedGroup = savedGroups[groupName] || {};
            const savedRole = savedGroup.role || 'reader';
            
            tr.innerHTML = `
              <td>${groupName}</td>
              <td>${groupEmail}</td>
              <td>
                <select class="form-select form-select-sm role-select" data-group="${groupName}">
                  <option value="reader" ${savedRole==='reader'?'selected':''} title="View only">Viewer</option>
                  <option value="commenter" ${savedRole==='commenter'?'selected':''} title="View and comment">Commenter</option>
                  <option value="writer" ${savedRole==='writer'?'selected':''} title="Add, edit, and share files">Contributor</option>
                  <option value="fileOrganizer" ${savedRole==='fileOrganizer'?'selected':''} title="Add, edit, move, delete and share content">Content manager</option>
                  <option value="organizer" ${savedRole==='organizer' || savedRole==='owner'?'selected':''} title="Manage content, people, and settings">Manager</option>
                </select>
              </td>`;
            tbody.appendChild(tr);
          });
        })
        .withFailureHandler(function(err){
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading groups: ' + (err.message || err) + '</td></tr>';
        })
        .getGroupsMap();
    })
    .withFailureHandler(function(err){
      // If policy load fails, still try to load groups
      google.script.run
        .withSuccessHandler(function(groupsMap){
          const entries = Object.entries(groupsMap || {});
          if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No groups found</td></tr>';
            return;
          }
          tbody.innerHTML = '';
          entries.sort((a, b) => a[0].localeCompare(b[0]));
          entries.forEach(([groupName, groupEmail]) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${groupName}</td>
              <td>${groupEmail}</td>
              <td>
                <select class="form-select form-select-sm role-select" data-group="${groupName}">
                  <option value="reader" selected title="View only">Viewer</option>
                  <option value="commenter" title="View and comment">Commenter</option>
                  <option value="writer" title="Add, edit, and share files">Contributor</option>
                  <option value="fileOrganizer" title="Add, edit, move, delete and share content">Content manager</option>
                  <option value="organizer" title="Manage content, people, and settings">Manager</option>
                </select>
              </td>`;
            tbody.appendChild(tr);
          });
        })
        .getGroupsMap();
    })
    .getAccessPolicy();
}

/* Load all users with their groups */
function loadAllUsersWithGroups(){
  const tbody = document.getElementById('allUsersTableBody');
  tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Loading users...</td></tr>';
  
  // Also load groups for the filter dropdown
  google.script.run
    .withSuccessHandler(function(groupsMap){
      const groupSelect = document.getElementById('filterByGroup');
      if (groupSelect) {
        // Clear existing options except "All Groups"
        groupSelect.innerHTML = '<option value="">All Groups</option>';
        const entries = Object.entries(groupsMap || {});
        entries.sort((a, b) => a[0].localeCompare(b[0]));
        entries.forEach(([name, email]) => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          groupSelect.appendChild(opt);
        });
      }
    })
    .getGroupsMap();
  
  google.script.run
    .withSuccessHandler(function(users){
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No users found</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-email', user.email.toLowerCase());
        tr.setAttribute('data-name', (user.name || '').toLowerCase());
        tr.setAttribute('data-fullname', (user.fullName || '').toLowerCase());
        tr.setAttribute('data-groups', (user.groups || []).join(',').toLowerCase());
        
        const userDisplay = user.fullName 
          ? `${user.fullName} <br><small class="text-muted">${user.email}</small>`
          : user.email;
        
        const suspendedBadge = user.suspended 
          ? '<span class="badge bg-warning ms-1">Suspended</span>' 
          : '';
        
        const groupsHtml = user.groups && user.groups.length > 0 
          ? user.groups.map(g => `
              <span class="badge bg-primary me-1 mb-1" style="display: inline-block;">
                ${g}
                <button class="btn-close btn-close-white ms-1" style="font-size: 0.6em; vertical-align: middle;" onclick="removeUserFromGroup('${user.email}', '${g}')" title="Remove from group"></button>
              </span>
            `).join('')
          : '<span class="text-muted">No groups</span>';
        
        tr.innerHTML = `
          <td>
            ${userDisplay}
            ${suspendedBadge}
          </td>
          <td>${groupsHtml}</td>
          <td>
            <button class="btn btn-sm btn-success" onclick="showAddGroupModal('${user.email}')" title="Add to Group">
              <i class="bi bi-plus-circle"></i> Add to Group
            </button>
          </td>`;
        tbody.appendChild(tr);
      });
    })
    .withFailureHandler(function(err){
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading users: ' + (err.message || err) + '</td></tr>';
    })
    .getAllUsersWithGroups();
}

/* Filter users table by search input */
function filterUsersTable(){
  const searchInput = document.getElementById('usersSearchInput');
  const filter = searchInput.value.toLowerCase();
  const groupFilter = document.getElementById('filterByGroup') ? document.getElementById('filterByGroup').value : '';
  const rows = document.querySelectorAll('#allUsersTableBody tr');
  
  rows.forEach(row => {
    const email = row.getAttribute('data-email') || '';
    const name = row.getAttribute('data-name') || '';
    const fullname = row.getAttribute('data-fullname') || '';
    const groups = row.getAttribute('data-groups') || '';
    
    const matchesSearch = !filter || email.includes(filter) || name.includes(filter) || fullname.includes(filter);
    const matchesGroup = !groupFilter || groups.includes(groupFilter.toLowerCase());
    
    if (matchesSearch && matchesGroup) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

/* Filter users by group */
function filterUsersByGroup(){
  filterUsersTable();
}

/* Show modal to add user to group */
function showAddGroupModal(userEmail){
  // Store current user email
  window.currentUserForGroup = userEmail;
  
  // Load groups into modal select
  google.script.run
    .withSuccessHandler(function(groupsMap){
      const select = document.getElementById('addGroupSelect');
      if (!select) {
        // Create modal if it doesn't exist
        createAddGroupModal();
        const newSelect = document.getElementById('addGroupSelect');
        populateGroupSelect(newSelect, groupsMap, userEmail);
      } else {
        populateGroupSelect(select, groupsMap, userEmail);
      }
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addGroupModal'));
      modal.show();
    })
    .withFailureHandler(function(err){
      showModal('Error loading groups: ' + (err.message || err));
    })
    .getGroupsMap();
}

/* Populate group select in modal */
function populateGroupSelect(select, groupsMap, userEmail){
  select.innerHTML = '<option value="">-- Select Group --</option>';
  const entries = Object.entries(groupsMap || {});
  entries.sort((a, b) => a[0].localeCompare(b[0]));
  
  entries.forEach(([name, email]) => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = `${name} (${email})`;
    opt.setAttribute('data-email', email);
    select.appendChild(opt);
  });
  
  // Set user email in modal
  const userEmailInput = document.getElementById('addGroupUserEmail');
  if (userEmailInput) {
    userEmailInput.value = userEmail;
  }
}

/* Create add group modal if it doesn't exist */
function createAddGroupModal(){
  const modalHtml = `
    <div class="modal fade" id="addGroupModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add User to Group</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">User Email</label>
              <input type="text" id="addGroupUserEmail" class="form-control" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Select Group</label>
              <select id="addGroupSelect" class="form-select"></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Role in Group</label>
              <select id="addGroupRole" class="form-select">
                <option value="MEMBER">Member</option>
                <option value="MANAGER">Manager</option>
                <option value="OWNER">Owner</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="addUserToGroupFromModal()">Add to Group</button>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

/* Add user to group from modal */
function addUserToGroupFromModal(){
  const userEmail = window.currentUserForGroup;
  const groupSelect = document.getElementById('addGroupSelect');
  const roleSelect = document.getElementById('addGroupRole');
  
  if (!userEmail || !groupSelect || !groupSelect.value) {
    showModal('Please select a group');
    return;
  }
  
  const groupName = groupSelect.value;
  const role = roleSelect ? roleSelect.value : 'MEMBER';
  
  google.script.run
    .withSuccessHandler(function(msg){
      showModal('User added to group successfully');
      bootstrap.Modal.getInstance(document.getElementById('addGroupModal')).hide();
      // Refresh users list
      loadAllUsersWithGroups();
    })
    .withFailureHandler(function(err){
      showModal('Error: ' + (err.message || err));
    })
    .addGroupMember(groupName, userEmail, role);
}

/* Remove user from group */
function removeUserFromGroup(userEmail, groupName){
  if (!confirm(`Are you sure you want to remove ${userEmail} from group "${groupName}"?`)) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(msg){
      showModal('User removed from group successfully');
      // Refresh users list
      loadAllUsersWithGroups();
    })
    .withFailureHandler(function(err){
      showModal('Error: ' + (err.message || err));
    })
    .removeGroupMember(groupName, userEmail);
}

function savePolicy(){
  // Ensure accessPolicy exists
  if (!accessPolicy) {
    accessPolicy = { groups: {}, protection: {} };
  }
  
  const selects=document.querySelectorAll('#groupsTableBody select');
  selects.forEach(sel=>{ 
    const g=sel.getAttribute('data-group'); 
    if (!accessPolicy.groups) accessPolicy.groups = {};
    accessPolicy.groups[g] = accessPolicy.groups[g] || {}; 
    accessPolicy.groups[g].role = sel.value;
    
    // Also store group email if available from the table
    const row = sel.closest('tr');
    if (row) {
      const emailCell = row.querySelector('td:nth-child(2)');
      if (emailCell) {
        accessPolicy.groups[g].email = emailCell.textContent.trim();
      }
    }
  });
  
  accessPolicy.protection = {
    viewersCanCopyContent: document.getElementById('protCopy') ? document.getElementById('protCopy').checked : false,
    copyRequiresWriterPermission: document.getElementById('protWriterCopy') ? document.getElementById('protWriterCopy').checked : false,
    disableLinkSharing: false
  };
  
  google.script.run
    .withSuccessHandler(function(msg){
      showModal("Policy saved successfully");
    })
    .withFailureHandler(e=>showModal("Error: "+e.message))
    .saveAccessPolicy(accessPolicy);
}

function syncAllNewOnly(){ 
  google.script.run
    .withSuccessHandler(function(msg){
      showModal(msg);
    })
    .withFailureHandler(e=>showModal("Ø®Ø·Ø£: "+e.message))
    .cronSyncRecent(); 
}

function syncAllAudit(){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§ØªØŸ")) return;
  google.script.run
    .withSuccessHandler(function(msg){
      showModal(msg);
    })
    .withFailureHandler(e=>showModal("Ø®Ø·Ø£: "+e.message))
    .cronAuditAll();
}

function loadLogs(){
  const box = document.getElementById('logsBox'); 
  const logContent = document.getElementById('logsContent');
  if (!logContent) return;
  
  box.style.display='block';
  logContent.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Loading logs...</div>';
  
  google.script.run
    .withSuccessHandler(function(rows){
      if(!rows || !rows.length){
        logContent.innerHTML = '<div class="text-muted text-center p-3"><i class="bi bi-info-circle"></i> No logs found. Logs will appear here once operations are performed.</div>';
        return;
      }
      
      // Check if there's an error message
      if(rows.length === 1 && rows[0].error){
        logContent.innerHTML = `<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> ${rows[0].error}</div>`;
        return;
      }
      
      const logHtml = rows.map(r => {
        const levelClass = r.level === 'ERROR' ? 'text-danger' : 
                          r.level === 'WARN' ? 'text-warning' : 
                          r.level === 'INFO' ? 'text-info' : 'text-secondary';
        const timestamp = r.timestamp ? new Date(r.timestamp).toLocaleString('en-US', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit',
          hour12: false 
        }) : 'N/A';
        return `<div class="mb-1">
          <span class="text-muted">[${timestamp}]</span> 
          <span class="${levelClass} fw-bold">${r.level}</span> 
          <span class="text-primary">${r.action || ''}</span> :: 
          <span>${r.message || ''}</span>
          ${r.meta ? `<span class="text-muted">- ${r.meta}</span>` : ''}
        </div>`;
      }).join('');
      
      logContent.innerHTML = logHtml;
    })
    .withFailureHandler(e => {
      logContent.innerHTML = `<div class="text-danger">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${e.message || e}</div>`;
    })
    .getLogs(100);
}

function testFolderPermissions(){
  const folderId = document.getElementById('testFolderId').value.trim();
  if (!folderId) {
    showModal('Please enter a folder ID');
    return;
  }
  
  const resultDiv = document.getElementById('testPermissionsResult');
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Testing permissions...</div>';
  
  google.script.run
    .withSuccessHandler(function(result){
      if (result.error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${result.error}</div>`;
        return;
      }
      
      const summary = result.summary || {};
      const perms = result.permissions || [];
      
      let html = `<div class="alert alert-info">
        <h6><i class="bi bi-folder"></i> Folder: <strong>${result.folderName || 'Unknown'}</strong></h6>
        <p class="mb-1 small"><code>${result.folderId}</code></p>
        <p class="mb-2"><strong>Summary:</strong></p>
        <div class="row">
          <div class="col-md-6">
            <ul class="mb-0 small">
              <li><strong>Total Permissions:</strong> ${summary.total || 0}</li>
              <li><strong>Domain:</strong> ${summary.domain || 0}</li>
              <li><strong>Anyone:</strong> ${summary.anyone || 0}</li>
              <li><strong>Groups:</strong> ${summary.groups || 0}</li>
              <li><strong>Users:</strong> ${summary.users || 0}</li>
            </ul>
          </div>
          <div class="col-md-6">
            <ul class="mb-0 small">
              <li><strong>File Organizer/Manager:</strong> ${summary.fileOrganizer || 0}</li>
              <li><strong>Writer/Contributor:</strong> ${summary.writer || 0}</li>
              <li><strong>Commenter:</strong> ${summary.commenter || 0}</li>
              <li><strong>Reader/Viewer:</strong> ${summary.reader || 0}</li>
            </ul>
          </div>
        </div>
      </div>`;
      
      if (perms.length > 0) {
        html += `<div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead>
              <tr>
                <th>Type</th>
                <th>Role</th>
                <th>Email/Name/Domain</th>
                <th>Permission ID</th>
              </tr>
            </thead>
            <tbody>`;
        
        perms.forEach(p => {
          // Color code the role badges
          let roleBadgeClass = 'bg-secondary';
          if (p.role === 'organizer' || p.role === 'fileOrganizer') roleBadgeClass = 'bg-danger';
          else if (p.role === 'writer') roleBadgeClass = 'bg-warning';
          else if (p.role === 'commenter') roleBadgeClass = 'bg-info';
          else if (p.role === 'reader') roleBadgeClass = 'bg-success';
          
          // Color code the type badges
          let typeBadgeClass = 'bg-secondary';
          if (p.type === 'domain') typeBadgeClass = 'bg-primary';
          else if (p.type === 'group') typeBadgeClass = 'bg-info';
          else if (p.type === 'user') typeBadgeClass = 'bg-success';
          else if (p.type === 'anyone') typeBadgeClass = 'bg-warning';
          
          html += `<tr>
            <td><span class="badge ${typeBadgeClass}">${p.type || 'N/A'}</span></td>
            <td><span class="badge ${roleBadgeClass}">${p.role || 'N/A'}</span></td>
            <td>${p.name || p.emailAddress || p.displayName || p.domain || 'N/A'}</td>
            <td><small class="text-muted">${p.id || '-'}</small></td>
          </tr>`;
        });
        
        html += `</tbody></table></div>`;
      }
      
      resultDiv.innerHTML = html;
    })
    .withFailureHandler(e => {
      resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message || e}</div>`;
    })
    .testFolderPermissions(folderId);
}

/* Populate groups dropdown for folder permissions */
function populateFolderGroupSelect(){
  const sel = document.getElementById('groupSelect');
  if (!sel) return;
  
  sel.innerHTML = '<option value="">-- Loading groups... --</option>';
  
  google.script.run
    .withSuccessHandler(function(map){
      const entries = Object.entries(map || {});
      sel.innerHTML = '<option value="">-- Select Group --</option>';
      
      if (!entries.length){
        const opt = document.createElement('option'); 
        opt.value = ''; 
        opt.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ØªØ§Ø­Ø©';
        opt.disabled = true;
        sel.appendChild(opt);
        return;
      }
      
      // Sort by group name (display name)
      entries.sort((a,b) => {
        const nameA = a[0] || '';
        const nameB = b[0] || '';
        return nameA.localeCompare(nameB);
      });
      
      entries.forEach(([name, email]) => {
        const opt = document.createElement('option');
        opt.value = name; // Use display name as value
        opt.textContent = `${name} (${email})`;
        opt.setAttribute('data-email', email); // Store email in data attribute
        sel.appendChild(opt);
      });
    })
    .withFailureHandler(function(err){
      sel.innerHTML = '<option value="">-- Error loading groups --</option>';
      console.error('Failed to load groups:', err);
    })
    .getGroupsMap();
}

/* Load approval recipients list */
function loadApprovalRecipients(){
  const container = document.getElementById('recipientsList');
  container.innerHTML = '<div class="text-center text-muted">Loading recipients...</div>';
  
  google.script.run
    .withSuccessHandler(function(recipients){
      if (!recipients || recipients.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">No recipients found. mo.abuomar@dtgsa.com will be used by default.</div>';
        return;
      }
      
      container.innerHTML = '';
      
      recipients.forEach((email, index) => {
        const isDefault = email === 'mo.abuomar@dtgsa.com';
        const badge = document.createElement('div');
        badge.className = 'd-inline-block me-2 mb-2';
        badge.innerHTML = `
          <span class="badge ${isDefault ? 'bg-primary' : 'bg-secondary'} p-2" style="font-size: 0.9em;">
            ${email}
            ${isDefault ? '<span class="ms-2"><i class="bi bi-star-fill"></i> Default</span>' : ''}
            ${!isDefault ? `<button class="btn-close btn-close-white ms-2" onclick="removeApprovalRecipient('${email}')" style="font-size: 0.7em;" title="Remove"></button>` : ''}
          </span>
        `;
        container.appendChild(badge);
      });
    })
    .withFailureHandler(function(err){
      container.innerHTML = '<div class="text-center text-danger">Error loading recipients: ' + (err.message || err) + '</div>';
    })
    .getApprovalRecipients();
}

/* Add approval recipient */
function addApprovalRecipient(){
  const emailInput = document.getElementById('newRecipientEmail');
  const email = emailInput.value.trim();
  
  if (!email) {
    showModal('Please enter an email address');
    return;
  }
  
  if (!email.includes('@')) {
    showModal('Please enter a valid email address');
    return;
  }
  
  // Load current recipients
  google.script.run
    .withSuccessHandler(function(currentRecipients){
      // Check if email already exists
      if (currentRecipients.includes(email.toLowerCase())) {
        showModal('This email is already in the recipients list');
        return;
      }
      
      // Add new recipient
      currentRecipients.push(email.toLowerCase());
      
      // Save updated list
      google.script.run
        .withSuccessHandler(function(msg){
          showModal('Recipient added successfully');
          emailInput.value = '';
          loadApprovalRecipients();
        })
        .withFailureHandler(function(err){
          showModal('Error: ' + (err.message || err));
        })
        .saveApprovalRecipients(currentRecipients);
    })
    .withFailureHandler(function(err){
      showModal('Error: ' + (err.message || err));
    })
    .getApprovalRecipients();
}

/* Remove approval recipient */
function removeApprovalRecipient(email){
  if (email === 'mo.abuomar@dtgsa.com') {
    showModal('Cannot remove the default recipient (mo.abuomar@dtgsa.com)');
    return;
  }
  
  if (!confirm(`Are you sure you want to remove ${email} from the recipients list?`)) {
    return;
  }
  
  // Load current recipients
  google.script.run
    .withSuccessHandler(function(currentRecipients){
      // Remove the email
      const updated = currentRecipients.filter(e => e.toLowerCase() !== email.toLowerCase());
      
      // Save updated list
      google.script.run
        .withSuccessHandler(function(msg){
          showModal('Recipient removed successfully');
          loadApprovalRecipients();
        })
        .withFailureHandler(function(err){
          showModal('Error: ' + (err.message || err));
        })
        .saveApprovalRecipients(updated);
    })
    .withFailureHandler(function(err){
      showModal('Error: ' + (err.message || err));
    })
    .getApprovalRecipients();
}

function init(){ 
  togglePhase(); 
  
  // Load approval recipients on page load
  if (document.getElementById('recipientsList')) {
    loadApprovalRecipients();
  }
  
  // Setup role description display
  setupRoleDescription();
  
  // Load data when Groups & Members tab is shown
  const groupsTab = document.querySelector('[data-bs-target="#groupsAccessTab"]');
  if (groupsTab) {
    groupsTab.addEventListener('shown.bs.tab', function() {
      // Load groups for roles
      if (document.getElementById('groupsTableBody')) {
        loadGroupsForRoles();
      }
    });
  }
  
  // Load data when File Restrictions tab is shown
  const fileRestrictionsTab = document.querySelector('[data-bs-target="#fileRestrictionsTab"]');
  if (fileRestrictionsTab) {
    fileRestrictionsTab.addEventListener('shown.bs.tab', function() {
      loadFileRestrictions();
      checkMonitoringStatus();
    });
  }
}

/* File Restrictions Management */
function loadFileRestrictions() {
  google.script.run
    .withSuccessHandler(function(data) {
      const blocked = data.blocked || [];
      const allowed = data.allowed || [];
      const whitelistEnabled = data.whitelistEnabled || false;
      
      // Update whitelist toggle
      document.getElementById('whitelistEnabled').checked = whitelistEnabled;
      
      // Display blocked extensions
      const blockedContainer = document.getElementById('blockedExtensionsList');
      if (blocked.length === 0) {
        blockedContainer.innerHTML = '<div class="text-center text-muted">No blocked extensions. Add some to start blocking files.</div>';
      } else {
        blockedContainer.innerHTML = '';
        blocked.forEach(ext => {
          const badge = document.createElement('div');
          badge.className = 'd-inline-block me-2 mb-2';
          badge.innerHTML = `
            <span class="badge bg-danger p-2" style="font-size: 0.9em;">
              .${ext}
              <button class="btn-close btn-close-white ms-2" onclick="removeBlockedExtension('${ext}')" style="font-size: 0.7em;" title="Remove"></button>
            </span>
          `;
          blockedContainer.appendChild(badge);
        });
      }
      
      // Display allowed extensions
      const allowedContainer = document.getElementById('allowedExtensionsList');
      if (allowed.length === 0) {
        allowedContainer.innerHTML = '<div class="text-center text-muted">No allowed extensions. All files (except blocked) will be allowed.</div>';
      } else {
        allowedContainer.innerHTML = '';
        allowed.forEach(ext => {
          const badge = document.createElement('div');
          badge.className = 'd-inline-block me-2 mb-2';
          badge.innerHTML = `
            <span class="badge bg-success p-2" style="font-size: 0.9em;">
              .${ext}
              <button class="btn-close btn-close-white ms-2" onclick="removeAllowedExtension('${ext}')" style="font-size: 0.7em;" title="Remove"></button>
            </span>
          `;
          allowedContainer.appendChild(badge);
        });
      }
    })
    .withFailureHandler(function(err) {
      showModal('Error loading file restrictions: ' + (err.message || err));
    })
    .getFileRestrictions();
}

function addBlockedExtension() {
  const ext = document.getElementById('newBlockedExtension').value.trim().toLowerCase();
  if (!ext) {
    showModal('Please enter a file extension');
    return;
  }
  
  // Remove dot if present
  const cleanExt = ext.replace(/^\./, '');
  
  google.script.run
    .withSuccessHandler(function(msg) {
      document.getElementById('newBlockedExtension').value = '';
      loadFileRestrictions();
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
    })
    .addBlockedExtension(cleanExt);
}

function removeBlockedExtension(ext) {
  if (!confirm(`Are you sure you want to remove .${ext} from blocked list?`)) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(msg) {
      loadFileRestrictions();
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
    })
    .removeBlockedExtension(ext);
}

function addAllowedExtension() {
  const ext = document.getElementById('newAllowedExtension').value.trim().toLowerCase();
  if (!ext) {
    showModal('Please enter a file extension');
    return;
  }
  
  // Remove dot if present
  const cleanExt = ext.replace(/^\./, '');
  
  google.script.run
    .withSuccessHandler(function(msg) {
      document.getElementById('newAllowedExtension').value = '';
      loadFileRestrictions();
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
    })
    .addAllowedExtension(cleanExt);
}

function removeAllowedExtension(ext) {
  if (!confirm(`Are you sure you want to remove .${ext} from allowed list?`)) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(msg) {
      loadFileRestrictions();
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
    })
    .removeAllowedExtension(ext);
}

function toggleWhitelist() {
  const enabled = document.getElementById('whitelistEnabled').checked;
  
  google.script.run
    .withSuccessHandler(function(msg) {
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
      document.getElementById('whitelistEnabled').checked = !enabled; // Revert
    })
    .setWhitelistEnabled(enabled);
}

function checkMonitoringStatus() {
  google.script.run
    .withSuccessHandler(function(data) {
      const status = data.enabled ? 'Enabled' : 'Disabled';
      const statusClass = data.enabled ? 'bg-success' : 'bg-secondary';
      document.getElementById('monitoringStatus').textContent = status;
      document.getElementById('monitoringStatus').className = 'badge ' + statusClass;
      document.getElementById('lastCheckTime').textContent = data.lastCheck || 'Never';
    })
    .withFailureHandler(function(err) {
      document.getElementById('monitoringStatus').textContent = 'Error';
      document.getElementById('monitoringStatus').className = 'badge bg-danger';
    })
    .getFileMonitoringStatus();
}

function setupFileMonitoring() {
  if (!confirm('This will set up automatic file monitoring. Files with blocked extensions will be deleted automatically. Continue?')) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(msg) {
      showModal(msg);
      checkMonitoringStatus();
    })
    .withFailureHandler(function(err) {
      let errorMsg = err.message || err;
      
      // Check if it's a permissions error
      if (errorMsg.includes('script.scriptapp') || errorMsg.includes('Permission denied')) {
        errorMsg = 'âš ï¸ Permission Required\n\n' +
          'The script needs additional permissions to set up file monitoring.\n\n' +
          'Please follow these steps:\n\n' +
          '1. Open Google Apps Script editor (script.google.com)\n' +
          '2. Find your project and open it\n' +
          '3. Click on "Review permissions" or run any function\n' +
          '4. Click "Advanced" â†’ "Go to [Project Name] (unsafe)"\n' +
          '5. Click "Allow" to grant the required permissions\n' +
          '6. Return here and try again\n\n' +
          'Required permission: Manage triggers for this script';
      }
      
      showModal('Error: ' + errorMsg);
    })
    .setupFileMonitoring();
}

function setupRoleDescription() {
  const roleSelect = document.getElementById('groupRoleSelect');
  const roleDescription = document.getElementById('roleDescription');
  
  if (roleSelect && roleDescription) {
    // Update description on change
    roleSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const description = selectedOption.getAttribute('title') || '';
      roleDescription.textContent = description;
    });
    
    // Set initial description
    if (roleSelect.selectedIndex >= 0) {
      const selectedOption = roleSelect.options[roleSelect.selectedIndex];
      const description = selectedOption.getAttribute('title') || '';
      roleDescription.textContent = description;
    }
  }
}

document.addEventListener('DOMContentLoaded', function(){ init(); });
</script>
</body>
</html>
