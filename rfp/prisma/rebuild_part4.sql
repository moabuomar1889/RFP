-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- COMPLETE TEMPLATE AND PERMISSIONS RPCs
-- Run this ENTIRE script in Supabase SQL Editor
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- 1. Create template_versions table if not exists
CREATE TABLE IF NOT EXISTS rfp.template_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    version_number INTEGER UNIQUE NOT NULL,
    template_json JSONB NOT NULL,
    created_by TEXT DEFAULT 'system',
    is_active BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. Get active template
DROP FUNCTION IF EXISTS public.get_active_template();
CREATE OR REPLACE FUNCTION public.get_active_template()
RETURNS TABLE (
    id UUID,
    version_number INTEGER,
    template_json JSONB,
    created_by TEXT,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        t.id,
        t.version_number,
        t.template_json,
        t.created_by,
        t.created_at
    FROM rfp.template_versions t
    WHERE t.is_active = true
    LIMIT 1;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.get_active_template() TO anon, authenticated, service_role;

-- 3. Save template (creates new version)
DROP FUNCTION IF EXISTS public.save_template(JSONB, TEXT);
CREATE OR REPLACE FUNCTION public.save_template(
    p_template_json JSONB,
    p_created_by TEXT
)
RETURNS INTEGER AS $$
DECLARE
    v_version INTEGER;
BEGIN
    -- Get next version number
    SELECT COALESCE(MAX(version_number), 0) + 1 INTO v_version FROM rfp.template_versions;
    
    -- Deactivate all existing templates
    UPDATE rfp.template_versions SET is_active = false WHERE is_active = true;
    
    -- Insert new template
    INSERT INTO rfp.template_versions (version_number, template_json, created_by, is_active)
    VALUES (v_version, p_template_json, p_created_by, true);
    
    RETURN v_version;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.save_template(JSONB, TEXT) TO anon, authenticated, service_role;

-- 4. Insert default template if none exists
INSERT INTO rfp.template_versions (version_number, template_json, created_by, is_active)
SELECT 1, 
'{
  "exportDate": "2026-01-31T09:38:24.633Z",
  "exportVersion": "2.5",
  "template": [
    {
      "_expanded": true,
      "limitedAccess": false,
      "groups": [],
      "nodes": [
        {
          "limitedAccess": true,
          "groups": [
            {"name": "Admins", "role": "organizer"},
            {"name": "Technical Team", "role": "writer"},
            {"name": "Projects Managers", "role": "writer"},
            {"name": "Projects Control", "role": "writer"}
          ],
          "text": "SOW",
          "users": []
        },
        {
          "groups": [{"name": "Projects Managers", "role": "writer"}],
          "limitedAccess": true,
          "text": "Technical Proposal",
          "users": []
        },
        {
          "limitedAccess": true,
          "groups": [
            {"name": "Admins", "role": "organizer"},
            {"name": "Projects Managers", "role": "fileOrganizer"}
          ],
          "text": "Vendors Quotations",
          "users": []
        },
        {
          "groups": [{"name": "Projects Managers", "role": "writer"}],
          "limitedAccess": true,
          "text": "Commercial Proposal",
          "users": []
        }
      ],
      "text": "Bidding",
      "users": []
    },
    {
      "_expanded": true,
      "groups": [],
      "limitedAccess": false,
      "nodes": [
        {
          "limitedAccess": true,
          "groups": [
            {"name": "Document Control", "role": "fileOrganizer"},
            {"name": "Projects Managers", "role": "fileOrganizer"},
            {"name": "Admins", "role": "organizer"}
          ],
          "text": "Document Control",
          "users": []
        },
        {
          "limitedAccess": true,
          "groups": [
            {"name": "Quality Control", "role": "fileOrganizer"},
            {"name": "Projects Control", "role": "reader"},
            {"name": "Projects Managers", "role": "writer"}
          ],
          "text": "Quality Control",
          "users": []
        },
        {"limitedAccess": false, "text": "HSE"},
        {
          "groups": [
            {"name": "Projects Control", "role": "fileOrganizer"},
            {"name": "Admins", "role": "organizer"}
          ],
          "limitedAccess": true,
          "text": "Project Control",
          "users": []
        },
        {"limitedAccess": false, "text": "IFC Drawings"},
        {
          "limitedAccess": true,
          "groups": [
            {"name": "Technical Team", "role": "fileOrganizer"},
            {"name": "Projects Managers", "role": "fileOrganizer"}
          ],
          "text": "Engineering (EPC ONLY)",
          "users": []
        },
        {
          "groups": [
            {"name": "Projects Managers", "role": "fileOrganizer"},
            {"name": "Projects Control", "role": "fileOrganizer"}
          ],
          "limitedAccess": true,
          "text": "Quantity Survey",
          "users": []
        },
        {"limitedAccess": false, "text": "Operation"},
        {"limitedAccess": false, "text": "Survey"}
      ],
      "text": "Project Delivery"
    }
  ]
}'::jsonb,
'system',
true
WHERE NOT EXISTS (SELECT 1 FROM rfp.template_versions WHERE is_active = true);

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- END - Run this entire script in Supabase SQL Editor
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- SETTINGS TABLE AND RPCs
-- Run this ENTIRE script in Supabase SQL Editor
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- 1. Create settings table
CREATE TABLE IF NOT EXISTS rfp.system_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    setting_key TEXT UNIQUE NOT NULL,
    setting_value JSONB NOT NULL DEFAULT '{}'::jsonb,
    description TEXT,
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    updated_by TEXT DEFAULT 'system'
);

-- 2. Insert default settings if not exist
INSERT INTO rfp.system_settings (setting_key, setting_value, description) VALUES
('safe_test_mode', '{"enabled": true}'::jsonb, 'Safe test mode restricts bulk operations'),
('strict_mode', '{"enabled": true}'::jsonb, 'Strict mode enables permission enforcement'),
('bulk_approved', '{"approved": false}'::jsonb, 'Whether bulk operations have been approved'),
('protected_principals', '{"emails": ["mo.abuomar@dtgsa.com", "admins@dtgsa.com"]}'::jsonb, 'Protected email addresses that cannot be removed')
ON CONFLICT (setting_key) DO NOTHING;

-- 3. Get all settings
DROP FUNCTION IF EXISTS public.get_settings();
CREATE OR REPLACE FUNCTION public.get_settings()
RETURNS TABLE (
    setting_key TEXT,
    setting_value JSONB,
    description TEXT,
    updated_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        s.setting_key,
        s.setting_value,
        s.description,
        s.updated_at
    FROM rfp.system_settings s
    ORDER BY s.setting_key;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.get_settings() TO anon, authenticated, service_role;

-- 4. Update a setting
DROP FUNCTION IF EXISTS public.update_setting(TEXT, JSONB, TEXT);
CREATE OR REPLACE FUNCTION public.update_setting(
    p_key TEXT,
    p_value JSONB,
    p_updated_by TEXT DEFAULT 'admin'
)
RETURNS BOOLEAN AS $$
BEGIN
    UPDATE rfp.system_settings 
    SET 
        setting_value = p_value,
        updated_at = NOW(),
        updated_by = p_updated_by
    WHERE setting_key = p_key;
    
    IF NOT FOUND THEN
        INSERT INTO rfp.system_settings (setting_key, setting_value, updated_by)
        VALUES (p_key, p_value, p_updated_by);
    END IF;
    
    RETURN true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.update_setting(TEXT, JSONB, TEXT) TO anon, authenticated, service_role;

-- 5. Bulk update settings (for Save Settings button)
DROP FUNCTION IF EXISTS public.save_all_settings(JSONB);
CREATE OR REPLACE FUNCTION public.save_all_settings(
    p_settings JSONB
)
RETURNS BOOLEAN AS $$
DECLARE
    v_key TEXT;
    v_value JSONB;
BEGIN
    -- Loop through each key in the settings object
    FOR v_key, v_value IN SELECT * FROM jsonb_each(p_settings)
    LOOP
        UPDATE rfp.system_settings 
        SET 
            setting_value = v_value,
            updated_at = NOW(),
            updated_by = 'admin'
        WHERE setting_key = v_key;
        
        IF NOT FOUND THEN
            INSERT INTO rfp.system_settings (setting_key, setting_value, updated_by)
            VALUES (v_key, v_value, 'admin');
        END IF;
    END LOOP;
    
    RETURN true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.save_all_settings(JSONB) TO anon, authenticated, service_role;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- END - Run this entire script in Supabase SQL Editor
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- NEW DEFAULT TEMPLATE FROM PRJ-014 EXTRACTION
-- Generated: 2026-02-05
-- Run this ENTIRE script in Supabase SQL Editor
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Deactivate all existing templates
UPDATE rfp.template_versions SET is_active = false;

-- Get the next version number and insert the new template
DO $$
DECLARE
    v_version INTEGER;
BEGIN
    SELECT COALESCE(MAX(version_number), 0) + 1 INTO v_version FROM rfp.template_versions;
    
    INSERT INTO rfp.template_versions (version_number, template_json, created_by, is_active)
    VALUES (
        v_version,
        '[
  {
    "name": "Project Delivery",
    "limitedAccess": false,
    "groups": [
      {"email": "technical-team@dtgsa.com", "role": "reader"},
      {"email": "dc-team@dtgsa.com", "role": "reader"},
      {"email": "survey-team@dtgsa.com", "role": "reader"},
      {"email": "projects-control@dtgsa.com", "role": "reader"},
      {"email": "admin@dtgsa.com", "role": "organizer"},
      {"email": "quality-control@dtgsa.com", "role": "reader"},
      {"email": "projects-managers@dtgsa.com", "role": "reader"}
    ],
    "children": [
      {
        "name": "Quantity Survey",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "fileOrganizer"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
        ]
      },
      {
        "name": "Engineering (EPC ONLY)",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "fileOrganizer"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
        ]
      },
      {
        "name": "Project Control",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "fileOrganizer"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "reader"}
        ],
        "children": [
          {
            "name": "Commercial",
            "limitedAccess": true,
            "groups": [
              {"email": "projects-control@dtgsa.com", "role": "reader"},
              {"email": "admin@dtgsa.com", "role": "organizer"},
              {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
            ],
            "children": [
              {
                "name": "Invoices",
                "limitedAccess": true,
                "groups": [
                  {"email": "admin@dtgsa.com", "role": "organizer"},
                  {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
                ]
              },
              {
                "name": "Agreements",
                "limitedAccess": true,
                "groups": [
                  {"email": "admin@dtgsa.com", "role": "organizer"},
                  {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
                ],
                "children": [
                  {
                    "name": "Change Orders",
                    "limitedAccess": true,
                    "groups": [
                      {"email": "admin@dtgsa.com", "role": "organizer"},
                      {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
                    ]
                  },
                  {
                    "name": "Contract & PO",
                    "limitedAccess": true,
                    "groups": [
                      {"email": "admin@dtgsa.com", "role": "organizer"},
                      {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
                    ]
                  }
                ]
              }
            ]
          },
          {
            "name": "Planning",
            "limitedAccess": true,
            "groups": [
              {"email": "projects-control@dtgsa.com", "role": "fileOrganizer"},
              {"email": "admin@dtgsa.com", "role": "organizer"}
            ],
            "children": [
              {
                "name": "Planning Deliverables",
                "limitedAccess": true,
                "groups": [
                  {"email": "projects-control@dtgsa.com", "role": "fileOrganizer"},
                  {"email": "admin@dtgsa.com", "role": "organizer"}
                ]
              },
              {
                "name": "Reports",
                "limitedAccess": true,
                "groups": [
                  {"email": "projects-control@dtgsa.com", "role": "fileOrganizer"},
                  {"email": "admin@dtgsa.com", "role": "organizer"}
                ]
              }
            ]
          }
        ]
      },
      {
        "name": "Quality Control",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "fileOrganizer"},
          {"email": "projects-managers@dtgsa.com", "role": "writer"}
        ]
      },
      {
        "name": "Document Control",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
        ],
        "children": [
          {
            "name": "MDR",
            "limitedAccess": true,
            "groups": [
              {"email": "dc-team@dtgsa.com", "role": "reader"},
              {"email": "admin@dtgsa.com", "role": "organizer"},
              {"email": "projects-managers@dtgsa.com", "role": "reader"}
            ]
          },
          {
            "name": "Forms",
            "limitedAccess": true,
            "groups": [
              {"email": "dc-team@dtgsa.com", "role": "reader"},
              {"email": "admin@dtgsa.com", "role": "organizer"},
              {"email": "projects-managers@dtgsa.com", "role": "reader"}
            ]
          },
          {
            "name": "Transmittals",
            "limitedAccess": true,
            "groups": [
              {"email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
              {"email": "admin@dtgsa.com", "role": "organizer"},
              {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
            ],
            "children": [
              {
                "name": "Sent",
                "limitedAccess": true,
                "groups": [
                  {"email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
                  {"email": "admin@dtgsa.com", "role": "organizer"},
                  {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
                ]
              },
              {
                "name": "Received",
                "limitedAccess": true,
                "groups": [
                  {"email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
                  {"email": "admin@dtgsa.com", "role": "organizer"},
                  {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
                ]
              }
            ]
          },
          {
            "name": "Submittals",
            "limitedAccess": true,
            "groups": [
              {"email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
              {"email": "admin@dtgsa.com", "role": "organizer"},
              {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
            ],
            "children": [
              {
                "name": "Received",
                "limitedAccess": true,
                "groups": [
                  {"email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
                  {"email": "admin@dtgsa.com", "role": "organizer"},
                  {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
                ],
                "children": [
                  {"name": "SI & CCCOR", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Letters", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Quality Control", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Project Control", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Procurement", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Minutes of Meetings", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "EHS", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Construction", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]}
                ]
              },
              {
                "name": "Ongoing",
                "limitedAccess": true,
                "groups": [
                  {"email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
                  {"email": "admin@dtgsa.com", "role": "organizer"},
                  {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
                ],
                "children": [
                  {"name": "SI & CCCOR", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Letters", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Quality Control", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Project Control", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Procurement", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Minutes of Meetings", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "EHS", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
                  {"name": "Construction", "limitedAccess": true, "groups": [{"email": "dc-team@dtgsa.com", "role": "fileOrganizer"}, {"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]}
                ]
              }
            ]
          }
        ]
      },
      {
        "name": "Survey",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "reader"}
        ]
      },
      {
        "name": "Operation",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "reader"}
        ]
      },
      {
        "name": "IFC Drawings",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "reader"}
        ]
      },
      {
        "name": "HSE",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "reader"}
        ]
      }
    ]
  },
  {
    "name": "Bidding",
    "limitedAccess": false,
    "groups": [
      {"email": "technical-team@dtgsa.com", "role": "reader"},
      {"email": "dc-team@dtgsa.com", "role": "reader"},
      {"email": "survey-team@dtgsa.com", "role": "reader"},
      {"email": "projects-control@dtgsa.com", "role": "reader"},
      {"email": "admin@dtgsa.com", "role": "organizer"},
      {"email": "quality-control@dtgsa.com", "role": "reader"},
      {"email": "projects-managers@dtgsa.com", "role": "reader"}
    ],
    "children": [
      {
        "name": "Commercial Proposal",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "writer"}
        ],
        "children": [
          {
            "name": "Admin Only",
            "limitedAccess": true,
            "groups": [
              {"email": "admin@dtgsa.com", "role": "organizer"},
              {"email": "projects-managers@dtgsa.com", "role": "reader"}
            ]
          }
        ]
      },
      {
        "name": "Vendors Quotations",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}
        ],
        "children": [
          {"name": "Civil and Finishes", "limitedAccess": true, "groups": [{"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
          {"name": "IT", "limitedAccess": true, "groups": [{"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
          {"name": "E&I", "limitedAccess": true, "groups": [{"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]},
          {"name": "Mechanical", "limitedAccess": true, "groups": [{"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "fileOrganizer"}]}
        ]
      },
      {
        "name": "Technical Proposal",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "reader"},
          {"email": "dc-team@dtgsa.com", "role": "reader"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "reader"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "writer"}
        ],
        "children": [
          {"name": "TBE", "limitedAccess": true, "groups": [{"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "writer"}]},
          {"name": "Technical Proposal", "limitedAccess": true, "groups": [{"email": "admin@dtgsa.com", "role": "organizer"}, {"email": "projects-managers@dtgsa.com", "role": "writer"}]}
        ]
      },
      {
        "name": "SOW",
        "limitedAccess": false,
        "groups": [
          {"email": "technical-team@dtgsa.com", "role": "writer"},
          {"email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
          {"email": "survey-team@dtgsa.com", "role": "reader"},
          {"email": "projects-control@dtgsa.com", "role": "writer"},
          {"email": "admin@dtgsa.com", "role": "organizer"},
          {"email": "quality-control@dtgsa.com", "role": "reader"},
          {"email": "projects-managers@dtgsa.com", "role": "writer"}
        ]
      }
    ]
  }
]'::jsonb,
        'system_extracted_prj014',
        true
    );
    
    RAISE NOTICE 'New template version % created successfully', v_version;
END $$;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- VERIFICATION: Check the new active template
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
SELECT 
    version_number,
    created_by,
    is_active,
    created_at,
    jsonb_array_length(template_json) as phase_count
FROM rfp.template_versions
WHERE is_active = true;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- END - Run this entire script in Supabase SQL Editor
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- Public RPC for updating job progress
-- Run this in Supabase SQL Editor
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Drop existing function if exists with wrong signature
DROP FUNCTION IF EXISTS public.update_job_progress(uuid, int, int, int, text);

-- Create public wrapper for updating job progress
CREATE OR REPLACE FUNCTION public.update_job_progress(
    p_job_id UUID,
    p_progress INT DEFAULT 0,
    p_completed_tasks INT DEFAULT 0,
    p_total_tasks INT DEFAULT 0,
    p_status TEXT DEFAULT NULL
)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, rfp
AS $$
BEGIN
    UPDATE rfp.sync_jobs
    SET 
        progress_percent = p_progress,
        completed_tasks = p_completed_tasks,
        total_tasks = p_total_tasks,
        status = COALESCE(p_status, status),
        started_at = CASE 
            WHEN p_status = 'running' AND started_at IS NULL THEN NOW()
            ELSE started_at
        END,
        completed_at = CASE 
            WHEN p_status IN ('completed', 'failed', 'cancelled') THEN NOW()
            ELSE completed_at
        END
    WHERE id = p_job_id;
END;
$$;

-- Grant execute to service role
GRANT EXECUTE ON FUNCTION public.update_job_progress(UUID, INT, INT, INT, TEXT) TO anon, authenticated, service_role;

-- Also create a clear_jobs function
CREATE OR REPLACE FUNCTION public.clear_old_jobs(
    p_keep_recent_hours INT DEFAULT 24
)
RETURNS INT
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, rfp
AS $$
DECLARE
    deleted_count INT;
BEGIN
    DELETE FROM rfp.sync_jobs
    WHERE status IN ('completed', 'failed', 'cancelled')
    AND created_at < NOW() - (p_keep_recent_hours || ' hours')::INTERVAL;
    
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$;

GRANT EXECUTE ON FUNCTION public.clear_old_jobs(INT) TO anon, authenticated, service_role;

-- Create clear_all_jobs function
CREATE OR REPLACE FUNCTION public.clear_all_jobs()
RETURNS INT
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, rfp
AS $$
DECLARE
    deleted_count INT;
BEGIN
    DELETE FROM rfp.sync_jobs
    WHERE status IN ('completed', 'failed', 'cancelled');
    
    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$;

GRANT EXECUTE ON FUNCTION public.clear_all_jobs() TO anon, authenticated, service_role;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- Upsert folder index entry
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Drop old function first to allow signature change
DROP FUNCTION IF EXISTS public.upsert_folder_index(UUID, TEXT, TEXT, TEXT);

CREATE OR REPLACE FUNCTION public.upsert_folder_index(
    p_project_id UUID,
    p_template_path TEXT,
    p_drive_folder_id TEXT,
    p_drive_folder_name TEXT,
    p_normalized_path TEXT DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, rfp
AS $$
DECLARE
    v_id UUID;
BEGIN
    INSERT INTO rfp.folder_index (project_id, template_path, drive_folder_id, drive_folder_name, normalized_template_path, last_verified_at)
    VALUES (p_project_id, p_template_path, p_drive_folder_id, p_drive_folder_name, COALESCE(p_normalized_path, p_template_path), NOW())
    ON CONFLICT (project_id, template_path) 
    DO UPDATE SET 
        drive_folder_id = p_drive_folder_id,
        drive_folder_name = p_drive_folder_name,
        normalized_template_path = COALESCE(p_normalized_path, rfp.folder_index.normalized_template_path),
        last_verified_at = NOW()
    RETURNING id INTO v_id;
    
    RETURN v_id;
END;
$$;

GRANT EXECUTE ON FUNCTION public.upsert_folder_index(UUID, TEXT, TEXT, TEXT, TEXT) TO anon, authenticated, service_role;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- Insert job log (for writeJobLog function)
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

CREATE OR REPLACE FUNCTION public.insert_job_log(
    p_job_id UUID,
    p_project_id UUID DEFAULT NULL,
    p_project_name TEXT DEFAULT NULL,
    p_folder_path TEXT DEFAULT NULL,
    p_action TEXT DEFAULT 'info',
    p_status TEXT DEFAULT 'info',
    p_details JSONB DEFAULT '{}'
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, rfp
AS $$
DECLARE
    v_id UUID;
BEGIN
    INSERT INTO rfp.sync_tasks (
        job_id, 
        project_id, 
        task_type, 
        task_details, 
        status,
        completed_at
    )
    VALUES (
        p_job_id, 
        p_project_id, 
        p_action, 
        jsonb_build_object(
            'message', COALESCE(p_folder_path, ''),
            'project_name', COALESCE(p_project_name, ''),
            'details', p_details,
            'log_status', p_status
        ),
        CASE WHEN p_status = 'error' THEN 'failed' ELSE 'completed' END,
        NOW()
    )
    RETURNING id INTO v_id;
    
    RETURN v_id;
END;
$$;

GRANT EXECUTE ON FUNCTION public.insert_job_log(UUID, UUID, TEXT, TEXT, TEXT, TEXT, JSONB) TO anon, authenticated, service_role;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- Insert sync task (for detailed job logs)
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

CREATE OR REPLACE FUNCTION public.insert_sync_task(
    p_job_id UUID,
    p_project_id UUID DEFAULT NULL,
    p_task_type TEXT DEFAULT 'info',
    p_task_details JSONB DEFAULT '{}',
    p_status TEXT DEFAULT 'completed'
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, rfp
AS $$
DECLARE
    v_id UUID;
BEGIN
    INSERT INTO rfp.sync_tasks (
        job_id, 
        project_id, 
        task_type, 
        task_details, 
        status,
        completed_at
    )
    VALUES (
        p_job_id, 
        p_project_id, 
        p_task_type, 
        p_task_details, 
        p_status,
        CASE WHEN p_status IN ('completed', 'failed') THEN NOW() ELSE NULL END
    )
    RETURNING id INTO v_id;
    
    RETURN v_id;
END;
$$;

GRANT EXECUTE ON FUNCTION public.insert_sync_task(UUID, UUID, TEXT, JSONB, TEXT) TO anon, authenticated, service_role;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- List job logs (for Live Logs display)
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

CREATE OR REPLACE FUNCTION public.list_job_logs(
    p_job_id UUID,
    p_limit INT DEFAULT 200
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, rfp
AS $$
BEGIN
    RETURN (
        SELECT json_agg(row_to_json(t)) FROM (
            SELECT 
                st.id,
                st.job_id,
                st.project_id,
                p.pr_number as project_name,
                st.task_details->>'message' as folder_path,
                st.task_type as action,
                st.status,
                st.task_details as details,
                st.created_at
            FROM rfp.sync_tasks st
            LEFT JOIN rfp.projects p ON st.project_id = p.id
            WHERE st.job_id = p_job_id
            ORDER BY st.created_at DESC
            LIMIT p_limit
        ) t
    );
END;
$$;

GRANT EXECUTE ON FUNCTION public.list_job_logs(UUID, INT) TO anon, authenticated, service_role;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- List project folders (for enforce permissions)
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

DROP FUNCTION IF EXISTS public.list_project_folders(UUID);

CREATE OR REPLACE FUNCTION public.list_project_folders(
    p_project_id UUID
)
RETURNS SETOF rfp.folder_index
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, rfp
AS $$
BEGIN
    RETURN QUERY
    SELECT *
    FROM rfp.folder_index
    WHERE project_id = p_project_id
    ORDER BY template_path;
END;
$$;

GRANT EXECUTE ON FUNCTION public.list_project_folders(UUID) TO anon, authenticated, service_role;

-- Fix list_job_logs to extract nested details properly
-- The details are stored as task_details->'details' but UI expects flat structure

CREATE OR REPLACE FUNCTION public.list_job_logs(
    p_job_id UUID,
    p_limit INT DEFAULT 200
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public, rfp
AS $$
BEGIN
    RETURN (
        SELECT json_agg(row_to_json(t)) FROM (
            SELECT 
                st.id,
                st.job_id,
                st.project_id,
                p.pr_number as project_name,
                st.task_details->>'message' as folder_path,
                st.task_type as action,
                COALESCE(st.task_details->>'log_status', st.status) as status,
                -- Extract the nested 'details' object directly for the UI
                st.task_details->'details' as details,
                st.created_at
            FROM rfp.sync_tasks st
            LEFT JOIN rfp.projects p ON st.project_id = p.id
            WHERE st.job_id = p_job_id
            ORDER BY st.created_at DESC
            LIMIT p_limit
        ) t
    );
END;
$$;

GRANT EXECUTE ON FUNCTION public.list_job_logs(UUID, INT) TO anon, authenticated, service_role;

-- Create RPC to get bidding folders for cleanup
CREATE OR REPLACE FUNCTION public.get_bidding_folders()
RETURNS TABLE (
    id UUID,
    project_id UUID,
    drive_folder_id TEXT,
    template_path TEXT,
    physical_path TEXT
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    RETURN QUERY
    SELECT 
        fi.id,
        fi.project_id,
        fi.drive_folder_id,
        fi.template_path,
        fi.physical_path
    FROM rfp.folder_index fi
    WHERE fi.template_path ILIKE '%Bidding%'
      AND fi.drive_folder_id IS NOT NULL;
END;
$$;

