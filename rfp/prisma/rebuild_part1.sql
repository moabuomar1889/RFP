-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- RFP Schema - Database Migration
-- Run this in Supabase SQL Editor
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Create schema
CREATE SCHEMA IF NOT EXISTS rfp;

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- USER TOKENS (Encrypted OAuth tokens for background jobs)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.user_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email TEXT UNIQUE NOT NULL,
  access_token_encrypted TEXT NOT NULL,
  refresh_token_encrypted TEXT NOT NULL,
  token_expiry TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- APP SETTINGS (Configurable settings including protected principals)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.app_settings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  key TEXT UNIQUE NOT NULL,
  value JSONB NOT NULL,
  updated_by TEXT,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert default protected principals
INSERT INTO rfp.app_settings (key, value) VALUES 
  ('protected_principals', '["mo.abuomar@dtgsa.com", "admins@dtgsa.com"]'),
  ('strict_mode_enabled', 'true'),
  ('daily_enforcement_enabled', 'false'),
  ('daily_enforcement_time', '"02:00"');

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- TEMPLATE VERSIONS
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.template_versions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  version_number INTEGER NOT NULL UNIQUE,
  template_json JSONB NOT NULL,
  created_by TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  is_active BOOLEAN DEFAULT false
);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- TEMPLATE CHANGES (Diff/Delta between versions)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.template_changes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  from_version INTEGER REFERENCES rfp.template_versions(version_number),
  to_version INTEGER NOT NULL REFERENCES rfp.template_versions(version_number),
  change_type TEXT NOT NULL,
  affected_path TEXT NOT NULL,
  change_details JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_template_changes_version ON rfp.template_changes(to_version);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- PERMISSION ROLES (e.g., ADMIN, PM, QS, EXEC_TEAM)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.permission_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT UNIQUE NOT NULL,
  description TEXT,
  drive_role TEXT NOT NULL, -- organizer, fileOrganizer, writer, commenter, reader
  is_system BOOLEAN DEFAULT false, -- System roles cannot be deleted
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insert default roles
INSERT INTO rfp.permission_roles (name, description, drive_role, is_system) VALUES
  ('ADMIN', 'Full administrative access', 'organizer', true),
  ('PROJECT_MANAGER', 'Project manager access', 'fileOrganizer', false),
  ('QUANTITY_SURVEYOR', 'Quantity surveyor access', 'writer', false),
  ('TECHNICAL_TEAM', 'Technical team access', 'writer', false),
  ('EXECUTION_TEAM', 'Execution team access', 'writer', false),
  ('VIEWER', 'Read-only access', 'reader', false);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- ROLE PRINCIPALS (Maps roles to Google Groups or Users)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.role_principals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  role_id UUID NOT NULL REFERENCES rfp.permission_roles(id) ON DELETE CASCADE,
  principal_type TEXT NOT NULL, -- 'group' or 'user'
  principal_email TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(role_id, principal_email)
);

CREATE INDEX idx_role_principals_role ON rfp.role_principals(role_id);
CREATE INDEX idx_role_principals_email ON rfp.role_principals(principal_email);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- PROJECTS
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pr_number TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  status TEXT DEFAULT 'bidding',
  drive_folder_id TEXT NOT NULL,
  rfp_folder_id TEXT,
  pd_folder_id TEXT,
  synced_version INTEGER DEFAULT 0,
  last_synced_at TIMESTAMPTZ,
  last_enforced_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_projects_pr ON rfp.projects(pr_number);
CREATE INDEX idx_projects_status ON rfp.projects(status);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- FOLDER INDEX (Critical for performance - maps path to folder_id)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.folder_index (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES rfp.projects(id) ON DELETE CASCADE,
  template_path TEXT NOT NULL,
  drive_folder_id TEXT NOT NULL,
  drive_folder_name TEXT NOT NULL,
  limited_access_enabled BOOLEAN DEFAULT false,
  permissions_hash TEXT,
  last_verified_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(project_id, template_path)
);

CREATE INDEX idx_folder_index_path ON rfp.folder_index(template_path);
CREATE INDEX idx_folder_index_drive_id ON rfp.folder_index(drive_folder_id);
CREATE INDEX idx_folder_index_project ON rfp.folder_index(project_id);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- EXPECTED PERMISSIONS (What permissions each template path should have)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.expected_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_path TEXT NOT NULL,
  role_id UUID NOT NULL REFERENCES rfp.permission_roles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(template_path, role_id)
);

CREATE INDEX idx_expected_permissions_path ON rfp.expected_permissions(template_path);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- SYNC JOBS
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.sync_jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_type TEXT NOT NULL,
  target_version INTEGER,
  status TEXT DEFAULT 'pending',
  priority INTEGER DEFAULT 5,
  total_tasks INTEGER DEFAULT 0,
  completed_tasks INTEGER DEFAULT 0,
  failed_tasks INTEGER DEFAULT 0,
  progress_percent INTEGER DEFAULT 0,
  started_by TEXT,
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  error_summary TEXT,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_sync_jobs_status ON rfp.sync_jobs(status);
CREATE INDEX idx_sync_jobs_type ON rfp.sync_jobs(job_type);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- SYNC TASKS (Individual tasks within a job)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.sync_tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  job_id UUID NOT NULL REFERENCES rfp.sync_jobs(id) ON DELETE CASCADE,
  project_id UUID REFERENCES rfp.projects(id),
  folder_index_id UUID REFERENCES rfp.folder_index(id),
  task_type TEXT NOT NULL,
  task_details JSONB NOT NULL,
  status TEXT DEFAULT 'pending',
  attempts INTEGER DEFAULT 0,
  max_attempts INTEGER DEFAULT 3,
  last_error TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ
);

CREATE INDEX idx_sync_tasks_job ON rfp.sync_tasks(job_id);
CREATE INDEX idx_sync_tasks_status ON rfp.sync_tasks(status);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- PERMISSION VIOLATIONS (Detected unauthorized changes)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.permission_violations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  folder_index_id UUID REFERENCES rfp.folder_index(id),
  project_id UUID REFERENCES rfp.projects(id),
  violation_type TEXT NOT NULL,
  expected JSONB,
  actual JSONB,
  auto_reverted BOOLEAN DEFAULT false,
  detected_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ,
  resolved_by TEXT
);

CREATE INDEX idx_permission_violations_project ON rfp.permission_violations(project_id);
CREATE INDEX idx_permission_violations_detected ON rfp.permission_violations(detected_at DESC);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- FOLDER RECONCILIATION LOG (For drift detection)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.reconciliation_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  folder_index_id UUID REFERENCES rfp.folder_index(id),
  project_id UUID REFERENCES rfp.projects(id),
  issue_type TEXT NOT NULL, -- 'renamed', 'moved', 'deleted', 'orphaned'
  expected_path TEXT,
  expected_name TEXT,
  actual_path TEXT,
  actual_name TEXT,
  resolution TEXT, -- 'auto_fixed', 'flagged', 'ignored'
  resolved_at TIMESTAMPTZ,
  detected_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_reconciliation_project ON rfp.reconciliation_log(project_id);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- AUDIT LOG
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE rfp.audit_log (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  action TEXT NOT NULL,
  entity_type TEXT NOT NULL,
  entity_id TEXT,
  old_value JSONB,
  new_value JSONB,
  details JSONB,
  performed_by TEXT,
  ip_address TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_log_time ON rfp.audit_log(created_at DESC);
CREATE INDEX idx_audit_log_entity ON rfp.audit_log(entity_type, entity_id);
CREATE INDEX idx_audit_log_action ON rfp.audit_log(action);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- HELPER FUNCTIONS
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Function to get next template version number
CREATE OR REPLACE FUNCTION rfp.get_next_template_version()
RETURNS INTEGER AS $$
  SELECT COALESCE(MAX(version_number), 0) + 1 FROM rfp.template_versions;
$$ LANGUAGE SQL;

-- Function to update job progress
CREATE OR REPLACE FUNCTION rfp.update_job_progress(p_job_id UUID)
RETURNS VOID AS $$
BEGIN
  UPDATE rfp.sync_jobs
  SET 
    completed_tasks = (SELECT COUNT(*) FROM rfp.sync_tasks WHERE job_id = p_job_id AND status = 'completed'),
    failed_tasks = (SELECT COUNT(*) FROM rfp.sync_tasks WHERE job_id = p_job_id AND status = 'failed'),
    progress_percent = CASE 
      WHEN total_tasks = 0 THEN 0
      ELSE ((SELECT COUNT(*) FROM rfp.sync_tasks WHERE job_id = p_job_id AND status IN ('completed', 'failed', 'skipped')) * 100 / total_tasks)
    END
  WHERE id = p_job_id;
END;
$$ LANGUAGE plpgsql;

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- ROW LEVEL SECURITY (Optional - enable if needed)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Enable RLS on all tables (uncomment if needed)
-- ALTER TABLE rfp.user_tokens ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE rfp.projects ENABLE ROW LEVEL SECURITY;
-- etc.

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- END OF MIGRATION
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Add safe_test_mode setting to app_settings
-- Run this in Supabase SQL Editor

INSERT INTO rfp.app_settings (key, value, updated_by, updated_at) 
VALUES ('safe_test_mode', 'true', 'system', NOW())
ON CONFLICT (key) DO UPDATE SET value = 'true', updated_at = NOW();

-- Add test_project_id setting (single project for safe test mode)
INSERT INTO rfp.app_settings (key, value, updated_by, updated_at) 
VALUES ('test_project_id', 'null', 'system', NOW())
ON CONFLICT (key) DO NOTHING;

-- Add bulk_operations_approved setting
INSERT INTO rfp.app_settings (key, value, updated_by, updated_at) 
VALUES ('bulk_operations_approved', 'false', 'system', NOW())
ON CONFLICT (key) DO NOTHING;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- RFP Schema - User and Group Directory Tables + RPC Functions
-- Run this in Supabase SQL Editor
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- USER DIRECTORY (Cached from Google Workspace)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE IF NOT EXISTS rfp.user_directory (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  google_id TEXT UNIQUE,
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  given_name TEXT,
  family_name TEXT,
  photo_url TEXT,
  department TEXT,
  role TEXT DEFAULT 'User',
  status TEXT DEFAULT 'Active',
  last_login TIMESTAMPTZ,
  synced_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_user_directory_email ON rfp.user_directory(email);
CREATE INDEX IF NOT EXISTS idx_user_directory_status ON rfp.user_directory(status);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- GROUP DIRECTORY (Cached from Google Workspace)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
CREATE TABLE IF NOT EXISTS rfp.group_directory (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  google_id TEXT UNIQUE,
  email TEXT UNIQUE NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  member_count INTEGER DEFAULT 0,
  mapped_role TEXT,
  synced_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_group_directory_email ON rfp.group_directory(email);

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- RPC FUNCTIONS (in public schema, access rfp tables)
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Upsert user from Google Workspace
CREATE OR REPLACE FUNCTION public.upsert_user_directory(
    p_google_id TEXT,
    p_email TEXT,
    p_name TEXT,
    p_given_name TEXT DEFAULT NULL,
    p_family_name TEXT DEFAULT NULL,
    p_photo_url TEXT DEFAULT NULL,
    p_department TEXT DEFAULT NULL,
    p_role TEXT DEFAULT 'User',
    p_status TEXT DEFAULT 'Active',
    p_last_login TIMESTAMPTZ DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
    v_id UUID;
BEGIN
    INSERT INTO rfp.user_directory (
        google_id, email, name, given_name, family_name, 
        photo_url, department, role, status, last_login, synced_at
    )
    VALUES (
        p_google_id, p_email, p_name, p_given_name, p_family_name,
        p_photo_url, p_department, p_role, p_status, p_last_login, NOW()
    )
    ON CONFLICT (email) DO UPDATE SET
        google_id = COALESCE(EXCLUDED.google_id, rfp.user_directory.google_id),
        name = EXCLUDED.name,
        given_name = EXCLUDED.given_name,
        family_name = EXCLUDED.family_name,
        photo_url = EXCLUDED.photo_url,
        department = EXCLUDED.department,
        role = EXCLUDED.role,
        status = EXCLUDED.status,
        last_login = EXCLUDED.last_login,
        synced_at = NOW()
    RETURNING id INTO v_id;
    
    RETURN v_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Upsert group from Google Workspace
CREATE OR REPLACE FUNCTION public.upsert_group_directory(
    p_google_id TEXT,
    p_email TEXT,
    p_name TEXT,
    p_description TEXT DEFAULT NULL,
    p_member_count INTEGER DEFAULT 0
)
RETURNS UUID AS $$
DECLARE
    v_id UUID;
BEGIN
    INSERT INTO rfp.group_directory (
        google_id, email, name, description, member_count, synced_at
    )
    VALUES (
        p_google_id, p_email, p_name, p_description, p_member_count, NOW()
    )
    ON CONFLICT (email) DO UPDATE SET
        google_id = COALESCE(EXCLUDED.google_id, rfp.group_directory.google_id),
        name = EXCLUDED.name,
        description = EXCLUDED.description,
        member_count = EXCLUDED.member_count,
        synced_at = NOW()
    RETURNING id INTO v_id;
    
    RETURN v_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Get all users
CREATE OR REPLACE FUNCTION public.get_users()
RETURNS TABLE (
    id UUID,
    google_id TEXT,
    email TEXT,
    name TEXT,
    given_name TEXT,
    family_name TEXT,
    photo_url TEXT,
    department TEXT,
    role TEXT,
    status TEXT,
    last_login TIMESTAMPTZ,
    synced_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        u.id, u.google_id, u.email, u.name, u.given_name, u.family_name,
        u.photo_url, u.department, u.role, u.status, u.last_login, 
        u.synced_at, u.created_at
    FROM rfp.user_directory u
    ORDER BY u.name ASC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Get all groups
CREATE OR REPLACE FUNCTION public.get_groups()
RETURNS TABLE (
    id UUID,
    google_id TEXT,
    email TEXT,
    name TEXT,
    description TEXT,
    member_count INTEGER,
    mapped_role TEXT,
    synced_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        g.id, g.google_id, g.email, g.name, g.description,
        g.member_count, g.mapped_role, g.synced_at, g.created_at
    FROM rfp.group_directory g
    ORDER BY g.name ASC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Get user by ID
CREATE OR REPLACE FUNCTION public.get_user_by_id(p_id UUID)
RETURNS TABLE (
    id UUID,
    google_id TEXT,
    email TEXT,
    name TEXT,
    given_name TEXT,
    family_name TEXT,
    photo_url TEXT,
    department TEXT,
    role TEXT,
    status TEXT,
    last_login TIMESTAMPTZ,
    synced_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        u.id, u.google_id, u.email, u.name, u.given_name, u.family_name,
        u.photo_url, u.department, u.role, u.status, u.last_login, 
        u.synced_at, u.created_at
    FROM rfp.user_directory u
    WHERE u.id = p_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- GRANT PERMISSIONS
-- ???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
GRANT EXECUTE ON FUNCTION public.upsert_user_directory(TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TEXT, TIMESTAMPTZ) TO anon, authenticated, service_role;
GRANT EXECUTE ON FUNCTION public.upsert_group_directory(TEXT, TEXT, TEXT, TEXT, INTEGER) TO anon, authenticated, service_role;
GRANT EXECUTE ON FUNCTION public.get_users() TO anon, authenticated, service_role;
GRANT EXECUTE ON FUNCTION public.get_groups() TO anon, authenticated, service_role;
GRANT EXECUTE ON FUNCTION public.get_user_by_id(UUID) TO anon, authenticated, service_role;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- END OF MIGRATION
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Migration: Add project lifecycle workflow tables
-- Run this in Supabase SQL Editor

-- 1. Add phase column to projects table
ALTER TABLE rfp.projects 
ADD COLUMN IF NOT EXISTS phase TEXT DEFAULT 'bidding' 
CHECK (phase IN ('bidding', 'execution'));

-- 2. Create project_requests table for approval workflow
CREATE TABLE IF NOT EXISTS rfp.project_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    request_type TEXT NOT NULL CHECK (request_type IN ('new_project', 'upgrade_to_pd')),
    project_name TEXT NOT NULL,
    pr_number TEXT, -- Auto-generated for new projects
    project_id UUID REFERENCES rfp.projects(id), -- For upgrade requests
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
    requested_by TEXT NOT NULL,
    requested_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    reviewed_by TEXT,
    reviewed_at TIMESTAMP WITH TIME ZONE,
    rejection_reason TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Create index for faster queries
CREATE INDEX IF NOT EXISTS idx_project_requests_status ON rfp.project_requests(status);
CREATE INDEX IF NOT EXISTS idx_project_requests_requested_by ON rfp.project_requests(requested_by);

-- 4. Add allowed_requesters setting (roles that can request new projects)
INSERT INTO rfp.app_settings (key, value, updated_by, updated_at) 
VALUES ('allowed_requesters', '["ADMIN", "PROJECT_MANAGER"]', 'system', NOW())
ON CONFLICT (key) DO NOTHING;

-- 5. Create function to get next PR number
CREATE OR REPLACE FUNCTION rfp.get_next_pr_number()
RETURNS TEXT AS $$
DECLARE
    max_num INTEGER;
    next_num TEXT;
BEGIN
    -- Get the highest PR number from existing projects
    SELECT COALESCE(MAX(
        CAST(NULLIF(regexp_replace(pr_number, '[^0-9]', '', 'g'), '') AS INTEGER)
    ), 0) INTO max_num
    FROM rfp.projects;
    
    -- Also check pending requests
    SELECT GREATEST(max_num, COALESCE(MAX(
        CAST(NULLIF(regexp_replace(pr_number, '[^0-9]', '', 'g'), '') AS INTEGER)
    ), 0)) INTO max_num
    FROM rfp.project_requests
    WHERE status IN ('pending', 'approved');
    
    -- Format as PR-XXX with leading zeros
    next_num := 'PR-' || LPAD((max_num + 1)::TEXT, 3, '0');
    
    RETURN next_num;
END;
$$ LANGUAGE plpgsql;

-- 6. Grant permissions
GRANT ALL ON rfp.project_requests TO authenticated;
GRANT EXECUTE ON FUNCTION rfp.get_next_pr_number() TO authenticated;

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- RFP Schema - Default Template Migration
-- Insert the production folder template with Bidding and Project Delivery phases
-- Run this in Supabase SQL Editor AFTER 001, 002, 003 migrations
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- Insert default template as version 1
INSERT INTO rfp.template_versions (version_number, template_json, created_by, is_active)
VALUES (
  1,
  '{
    "exportDate": "2026-01-31T09:38:24.633Z",
    "exportVersion": "2.5",
    "template": [
      {
        "_expanded": true,
        "limitedAccess": false,
        "groups": [],
        "nodes": [
          {
            "limitedAccess": true,
            "groups": [
              {"name": "Admins", "role": "organizer"},
              {"name": "Technical Team", "role": "writer"},
              {"name": "Projects Managers", "role": "writer"},
              {"name": "Projects Control", "role": "writer"},
              {"name": "dc team", "email": "dc-team@dtgsa.com", "role": "fileOrganizer"}
            ],
            "text": "SOW",
            "users": []
          },
          {
            "_expanded": true,
            "groups": [{"name": "Projects Managers", "role": "writer"}],
            "limitedAccess": true,
            "nodes": [
              {"limitedAccess": false, "text": "TBE"},
              {"limitedAccess": false, "text": "Technical Proposal"}
            ],
            "text": "Technical Propsal",
            "users": [{"type": "user", "email": "Marwan@dtgsa.com", "role": "fileOrganizer"}]
          },
          {
            "_expanded": true,
            "limitedAccess": true,
            "groups": [
              {"name": "Admins", "role": "organizer"},
              {"name": "Projects Managers", "role": "fileOrganizer"}
            ],
            "nodes": [
              {"limitedAccess": false, "text": "Civil and Finishes"},
              {"limitedAccess": false, "text": "Mechanical"},
              {"limitedAccess": false, "text": "E&I"},
              {"limitedAccess": false, "text": "IT"}
            ],
            "text": "Vendors Quotations",
            "users": []
          },
          {
            "groups": [{"name": "Projects Managers", "role": "writer"}],
            "limitedAccess": true,
            "text": "Commercial Propsal",
            "users": []
          }
        ],
        "text": "Bidding",
        "users": []
      },
      {
        "_expanded": true,
        "groups": [],
        "limitedAccess": false,
        "nodes": [
          {
            "_expanded": true,
            "groups": [
              {"name": "Document Control", "email": "dc-team@dtgsa.com", "role": "fileOrganizer"},
              {"name": "Projects Managers", "email": "projects-managers@dtgsa.com", "role": "fileOrganizer"},
              {"name": "Admins", "email": "admin@dtgsa.com", "role": "organizer"}
            ],
            "limitedAccess": true,
            "nodes": [
              {"groups": [], "limitedAccess": true, "nodes": [], "text": "Forms", "folderType": "PD", "users": []},
              {"groups": [], "limitedAccess": true, "nodes": [], "text": "MDR", "folderType": "PD", "users": []},
              {
                "nodes": [
                  {
                    "nodes": [
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Construction", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "EHS", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Minutes of Meetings", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Procurment", "folderType": "PD", "users": []},
                      {"limitedAccess": false, "groups": [], "nodes": [], "text": "Project Control", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Quality Control", "folderType": "PD", "users": []},
                      {"limitedAccess": false, "groups": [], "nodes": [], "text": "Letters", "folderType": "PD", "users": []},
                      {"limitedAccess": false, "groups": [], "nodes": [], "text": "SI & CCCOR", "folderType": "PD", "users": []}
                    ],
                    "_expanded": true,
                    "limitedAccess": false,
                    "groups": [],
                    "text": "Ongoing",
                    "folderType": "PD",
                    "users": []
                  },
                  {
                    "nodes": [
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Construction", "folderType": "PD", "users": []},
                      {"limitedAccess": false, "groups": [], "nodes": [], "text": "EHS", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Minutes of Meetings", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Procurment", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Project Control", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Quality Control", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "Letters", "folderType": "PD", "users": []},
                      {"groups": [], "limitedAccess": false, "nodes": [], "text": "SI & CCCOR", "folderType": "PD", "users": []}
                    ],
                    "_expanded": true,
                    "limitedAccess": false,
                    "groups": [],
                    "text": "Received",
                    "folderType": "PD",
                    "users": []
                  }
                ],
                "_expanded": true,
                "groups": [],
                "limitedAccess": false,
                "text": "Submittals",
                "folderType": "PD",
                "users": []
              },
              {
                "limitedAccess": false,
                "groups": [],
                "nodes": [
                  {"limitedAccess": false, "groups": [], "nodes": [], "text": "Received", "folderType": "PD", "users": []},
                  {"limitedAccess": false, "groups": [], "nodes": [], "text": "Sent", "folderType": "PD", "users": []}
                ],
                "text": "Transmittals",
                "folderType": "PD",
                "users": []
              }
            ],
            "text": "Document Control",
            "users": []
          },
          {
            "limitedAccess": true,
            "groups": [
              {"name": "Quality Control", "role": "fileOrganizer"},
              {"name": "Projects Control", "role": "reader"},
              {"name": "Projects Managers", "role": "writer"},
              {"name": "dc team", "email": "dc-team@dtgsa.com", "role": "fileOrganizer"}
            ],
            "text": "Quality Control",
            "users": []
          },
          {"limitedAccess": false, "text": "HSE"},
          {
            "_expanded": true,
            "groups": [
              {"name": "Projects Control", "role": "fileOrganizer"},
              {"name": "Admins", "role": "organizer"}
            ],
            "limitedAccess": true,
            "nodes": [
              {
                "groups": [],
                "limitedAccess": false,
                "nodes": [
                  {"limitedAccess": false, "nodes": [], "text": "Reports", "folderType": "PD"},
                  {"limitedAccess": false, "nodes": [], "text": "Planning Deliverables", "folderType": "PD"}
                ],
                "text": "Planning",
                "folderType": "PD",
                "users": []
              },
              {
                "nodes": [
                  {
                    "_expanded": true,
                    "limitedAccess": false,
                    "nodes": [
                      {"limitedAccess": false, "nodes": [], "text": "Contract & PO", "folderType": "PD"},
                      {"limitedAccess": false, "nodes": [], "text": "Change Orders", "folderType": "PD"}
                    ],
                    "text": "Agreements",
                    "folderType": "PD"
                  },
                  {"limitedAccess": false, "nodes": [], "text": "Invoices", "folderType": "PD"}
                ],
                "_expanded": true,
                "groups": [
                  {"name": "Projects Managers", "role": "fileOrganizer"},
                  {"name": "Admins", "role": "organizer"}
                ],
                "limitedAccess": true,
                "text": "Commercial",
                "folderType": "PD",
                "users": []
              }
            ],
            "text": "Project Control",
            "users": []
          },
          {"limitedAccess": false, "text": "IFC Drawings"},
          {
            "limitedAccess": true,
            "groups": [
              {"name": "Technical Team", "role": "fileOrganizer"},
              {"name": "Projects Managers", "role": "fileOrganizer"}
            ],
            "text": "Engineering (EPC ONLY)",
            "users": []
          },
          {
            "groups": [
              {"name": "Projects Managers", "role": "fileOrganizer"},
              {"name": "Projects Control", "role": "fileOrganizer"}
            ],
            "limitedAccess": true,
            "nodes": [],
            "text": "Quantity Survuy",
            "folderType": "PD",
            "users": []
          },
          {"limitedAccess": false, "nodes": [], "text": "Operation", "folderType": "PD"},
          {
            "groups": [{"name": "survey team", "email": "survey-team@dtgsa.com", "role": "fileOrganizer"}],
            "limitedAccess": false,
            "nodes": [],
            "text": "Survey",
            "folderType": "PD"
          }
        ],
        "text": "Project Delivery"
      }
    ]
  }'::jsonb,
  'system',
  true
)
ON CONFLICT (version_number) 
DO UPDATE SET 
  template_json = EXCLUDED.template_json,
  is_active = true;

-- Log the template insertion
INSERT INTO rfp.audit_log (action, entity_type, entity_id, details, performed_by)
VALUES (
  'template_created',
  'template',
  '1',
  '{"version": 1, "phases": ["Bidding", "Project Delivery"], "description": "Production folder structure template"}'::jsonb,
  'system'
);

-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
-- END OF MIGRATION
-- ?????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????

-- ============================================================================
-- Migration: Add comprehensive RPC functions for API access
-- Run this in Supabase SQL Editor after running previous migrations
-- ============================================================================

-- Drop existing functions first to allow signature changes
DROP FUNCTION IF EXISTS public.get_projects(TEXT, TEXT);
DROP FUNCTION IF EXISTS public.get_pending_requests();
DROP FUNCTION IF EXISTS public.get_request_history(INTEGER);
DROP FUNCTION IF EXISTS public.create_project_request(TEXT, TEXT, TEXT, UUID);
DROP FUNCTION IF EXISTS public.approve_request(UUID, TEXT);
DROP FUNCTION IF EXISTS public.reject_request(UUID, TEXT, TEXT);
DROP FUNCTION IF EXISTS public.get_audit_log(INTEGER);
DROP FUNCTION IF EXISTS public.log_audit(TEXT, TEXT, TEXT, TEXT, JSONB);
DROP FUNCTION IF EXISTS public.get_active_template();
DROP FUNCTION IF EXISTS public.save_template(JSONB, TEXT);
DROP FUNCTION IF EXISTS public.get_dashboard_stats();
DROP FUNCTION IF EXISTS public.upsert_project(TEXT, TEXT, TEXT, TEXT);
DROP FUNCTION IF EXISTS public.get_project_by_id(UUID);
DROP FUNCTION IF EXISTS public.get_app_setting(TEXT);
DROP FUNCTION IF EXISTS public.set_app_setting(TEXT, JSONB, TEXT);

-- ============================================================================
-- PROJECTS RPCs
-- ============================================================================

-- Get all projects with optional filters
CREATE OR REPLACE FUNCTION public.get_projects(
    p_status TEXT DEFAULT NULL,
    p_phase TEXT DEFAULT NULL
)
RETURNS TABLE (
    id UUID,
    pr_number TEXT,
    name TEXT,
    phase TEXT,
    status TEXT,
    drive_folder_id TEXT,
    synced_version INTEGER,
    last_synced_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.id,
        p.pr_number,
        p.name,
        COALESCE(p.phase, 'bidding')::TEXT as phase,
        COALESCE(p.status, 'active')::TEXT as status,
        p.drive_folder_id,
        p.synced_version,
        p.last_synced_at,
        p.created_at
    FROM rfp.projects p
    WHERE (p_status IS NULL OR p.status = p_status)
      AND (p_phase IS NULL OR p.phase = p_phase)
    ORDER BY p.created_at DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- PROJECT REQUESTS RPCs
-- ============================================================================

-- Get pending project requests
CREATE OR REPLACE FUNCTION public.get_pending_requests()
RETURNS TABLE (
    id UUID,
    request_type TEXT,
    project_name TEXT,
    pr_number TEXT,
    project_id UUID,
    status TEXT,
    requested_by TEXT,
    requested_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        r.id,
        r.request_type,
        r.project_name,
        r.pr_number,
        r.project_id,
        r.status,
        r.requested_by,
        r.requested_at
    FROM rfp.project_requests r
    WHERE r.status = 'pending'
    ORDER BY r.requested_at DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Get request history (approved/rejected)
CREATE OR REPLACE FUNCTION public.get_request_history(p_limit INTEGER DEFAULT 50)
RETURNS TABLE (
    id UUID,
    request_type TEXT,
    project_name TEXT,
    pr_number TEXT,
    project_id UUID,
    status TEXT,
    requested_by TEXT,
    requested_at TIMESTAMPTZ,
    reviewed_by TEXT,
    reviewed_at TIMESTAMPTZ,
    rejection_reason TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        r.id,
        r.request_type,
        r.project_name,
        r.pr_number,
        r.project_id,
        r.status,
        r.requested_by,
        r.requested_at,
        r.reviewed_by,
        r.reviewed_at,
        r.rejection_reason
    FROM rfp.project_requests r
    WHERE r.status != 'pending'
    ORDER BY r.reviewed_at DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create new project request
CREATE OR REPLACE FUNCTION public.create_project_request(
    p_request_type TEXT,
    p_project_name TEXT,
    p_requested_by TEXT,
    p_project_id UUID DEFAULT NULL
)
RETURNS TABLE (
    id UUID,
    pr_number TEXT
) AS $$
DECLARE
    v_pr_number TEXT;
    v_id UUID;
BEGIN
    IF p_request_type = 'new_project' THEN
        v_pr_number := rfp.get_next_pr_number();
    END IF;
    
    INSERT INTO rfp.project_requests (
        request_type,
        project_name,
        pr_number,
        project_id,
        requested_by
    ) VALUES (
        p_request_type,
        p_project_name,
        v_pr_number,
        p_project_id,
        p_requested_by
    )
    RETURNING project_requests.id INTO v_id;
    
    RETURN QUERY SELECT v_id, v_pr_number;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Approve a project request
CREATE OR REPLACE FUNCTION public.approve_request(
    p_request_id UUID,
    p_reviewed_by TEXT
)
RETURNS JSONB AS $$
DECLARE
    v_request RECORD;
    v_project_id UUID;
BEGIN
    SELECT * INTO v_request
    FROM rfp.project_requests
    WHERE id = p_request_id AND status = 'pending';
    
    IF NOT FOUND THEN
        RETURN jsonb_build_object('success', false, 'error', 'Request not found or already processed');
    END IF;
    
    UPDATE rfp.project_requests
    SET status = 'approved',
        reviewed_by = p_reviewed_by,
        reviewed_at = NOW()
    WHERE id = p_request_id;
    
    IF v_request.request_type = 'new_project' THEN
        INSERT INTO rfp.projects (
            pr_number,
            name,
            status,
            phase,
            drive_folder_id
        ) VALUES (
            v_request.pr_number,
            v_request.project_name,
            'pending_creation',
            'bidding',
            ''
        )
        RETURNING id INTO v_project_id;
    END IF;
    
    IF v_request.request_type = 'upgrade_to_pd' AND v_request.project_id IS NOT NULL THEN
        UPDATE rfp.projects
        SET phase = 'execution'
        WHERE id = v_request.project_id;
        v_project_id := v_request.project_id;
    END IF;
    
    INSERT INTO rfp.audit_log (action, entity_type, entity_id, performed_by, details)
    VALUES ('request_approved', 'project_request', p_request_id::TEXT, p_reviewed_by,
            jsonb_build_object('request_type', v_request.request_type, 'project_name', v_request.project_name));
    
    RETURN jsonb_build_object('success', true, 'project_id', v_project_id);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Reject a project request
CREATE OR REPLACE FUNCTION public.reject_request(
    p_request_id UUID,
    p_reviewed_by TEXT,
    p_reason TEXT
)
RETURNS JSONB AS $$
BEGIN
    UPDATE rfp.project_requests
    SET status = 'rejected',
        reviewed_by = p_reviewed_by,
        reviewed_at = NOW(),
        rejection_reason = p_reason
    WHERE id = p_request_id AND status = 'pending';
    
    IF NOT FOUND THEN
        RETURN jsonb_build_object('success', false, 'error', 'Request not found or already processed');
    END IF;
    
    INSERT INTO rfp.audit_log (action, entity_type, entity_id, performed_by, details)
    VALUES ('request_rejected', 'project_request', p_request_id::TEXT, p_reviewed_by,
            jsonb_build_object('reason', p_reason));
    
    RETURN jsonb_build_object('success', true);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- AUDIT LOG RPCs
-- ============================================================================

-- Get audit log entries
CREATE OR REPLACE FUNCTION public.get_audit_log(p_limit INTEGER DEFAULT 100)
RETURNS TABLE (
    id UUID,
    action TEXT,
    entity_type TEXT,
    entity_id TEXT,
    details JSONB,
    performed_by TEXT,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        a.id,
        a.action,
        a.entity_type,
        a.entity_id,
        a.details,
        a.performed_by,
        a.created_at
    FROM rfp.audit_log a
    ORDER BY a.created_at DESC
    LIMIT p_limit;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Log an audit entry
CREATE OR REPLACE FUNCTION public.log_audit(
    p_action TEXT,
    p_entity_type TEXT,
    p_entity_id TEXT,
    p_performed_by TEXT,
    p_details JSONB DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
    v_id UUID;
BEGIN
    INSERT INTO rfp.audit_log (action, entity_type, entity_id, performed_by, details)
    VALUES (p_action, p_entity_type, p_entity_id, p_performed_by, p_details)
    RETURNING id INTO v_id;
    
    RETURN v_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- TEMPLATE RPCs
-- ============================================================================

-- Get active template
CREATE OR REPLACE FUNCTION public.get_active_template()
RETURNS TABLE (
    id UUID,
    version_number INTEGER,
    template_json JSONB,
    created_by TEXT,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        t.id,
        t.version_number,
        t.template_json,
        t.created_by,
        t.created_at
    FROM rfp.template_versions t
    WHERE t.is_active = true
    LIMIT 1;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Save template (creates new version)
CREATE OR REPLACE FUNCTION public.save_template(
    p_template_json JSONB,
    p_created_by TEXT
)
RETURNS INTEGER AS $$
DECLARE
    v_version INTEGER;
BEGIN
    SELECT COALESCE(MAX(version_number), 0) + 1 INTO v_version
    FROM rfp.template_versions;
    
    UPDATE rfp.template_versions SET is_active = false WHERE is_active = true;
    
    INSERT INTO rfp.template_versions (version_number, template_json, created_by, is_active)
    VALUES (v_version, p_template_json, p_created_by, true);
    
    INSERT INTO rfp.audit_log (action, entity_type, entity_id, performed_by)
    VALUES ('template_saved', 'template', v_version::TEXT, p_created_by);
    
    RETURN v_version;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- DASHBOARD STATS RPC
-- ============================================================================

-- Get dashboard statistics
CREATE OR REPLACE FUNCTION public.get_dashboard_stats()
RETURNS JSONB AS $$
DECLARE
    v_stats JSONB;
BEGIN
    SELECT jsonb_build_object(
        'totalProjects', (SELECT COUNT(*) FROM rfp.projects),
        'biddingCount', (SELECT COUNT(*) FROM rfp.projects WHERE phase = 'bidding'),
        'executionCount', (SELECT COUNT(*) FROM rfp.projects WHERE phase = 'execution'),
        'pendingRequests', (SELECT COUNT(*) FROM rfp.project_requests WHERE status = 'pending'),
        'indexedFolders', (SELECT COUNT(*) FROM rfp.folder_index),
        'violations', (SELECT COUNT(*) FROM rfp.permission_violations WHERE resolved_at IS NULL),
        'activeJobs', (SELECT COUNT(*) FROM rfp.sync_jobs WHERE status = 'running')
    ) INTO v_stats;
    
    RETURN v_stats;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- PROJECT MANAGEMENT RPCs
-- ============================================================================

-- Upsert project (for drive scanning)
CREATE OR REPLACE FUNCTION public.upsert_project(
    p_pr_number TEXT,
    p_name TEXT,
    p_drive_folder_id TEXT,
    p_phase TEXT DEFAULT 'bidding'
)
RETURNS UUID AS $$
DECLARE
    v_id UUID;
BEGIN
    INSERT INTO rfp.projects (pr_number, name, drive_folder_id, phase, status)
    VALUES (p_pr_number, p_name, p_drive_folder_id, p_phase, 'active')
    ON CONFLICT (drive_folder_id) DO UPDATE SET
        pr_number = EXCLUDED.pr_number,
        name = EXCLUDED.name,
        phase = EXCLUDED.phase
    RETURNING id INTO v_id;
    
    RETURN v_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Get project by ID
CREATE OR REPLACE FUNCTION public.get_project_by_id(p_id UUID)
RETURNS TABLE (
    id UUID,
    pr_number TEXT,
    name TEXT,
    phase TEXT,
    status TEXT,
    drive_folder_id TEXT,
    synced_version INTEGER,
    last_synced_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.id,
        p.pr_number,
        p.name,
        COALESCE(p.phase, 'bidding')::TEXT as phase,
        COALESCE(p.status, 'active')::TEXT as status,
        p.drive_folder_id,
        p.synced_version,
        p.last_synced_at,
        p.created_at
    FROM rfp.projects p
    WHERE p.id = p_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- SETTINGS RPCs
-- ============================================================================

-- Get app setting
CREATE OR REPLACE FUNCTION public.get_app_setting(p_key TEXT)
RETURNS JSONB AS $$
DECLARE
    v_value JSONB;
BEGIN
    SELECT value INTO v_value
    FROM rfp.app_settings
    WHERE key = p_key;
    
    RETURN v_value;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Set app setting
CREATE OR REPLACE FUNCTION public.set_app_setting(
    p_key TEXT,
    p_value JSONB,
    p_updated_by TEXT
)
RETURNS BOOLEAN AS $$
BEGIN
    INSERT INTO rfp.app_settings (key, value, updated_by, updated_at)
    VALUES (p_key, p_value, p_updated_by, NOW())
    ON CONFLICT (key) DO UPDATE SET
        value = EXCLUDED.value,
        updated_by = EXCLUDED.updated_by,
        updated_at = NOW();
    
    RETURN true;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- GRANT PERMISSIONS
-- ============================================================================

GRANT EXECUTE ON FUNCTION public.get_projects(TEXT, TEXT) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.get_pending_requests() TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.get_request_history(INTEGER) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.create_project_request(TEXT, TEXT, TEXT, UUID) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.approve_request(UUID, TEXT) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.reject_request(UUID, TEXT, TEXT) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.get_audit_log(INTEGER) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.log_audit(TEXT, TEXT, TEXT, TEXT, JSONB) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.get_active_template() TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.save_template(JSONB, TEXT) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.get_dashboard_stats() TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.upsert_project(TEXT, TEXT, TEXT, TEXT) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.get_project_by_id(UUID) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.get_app_setting(TEXT) TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.set_app_setting(TEXT, JSONB, TEXT) TO anon, authenticated;

-- Migration: Update or Insert the correct default template
-- Run this in Supabase SQL Editor

-- First, delete any existing templates to avoid conflicts
DELETE FROM rfp.template_versions WHERE version_number = 1;

-- Insert the correct default template
INSERT INTO rfp.template_versions (version_number, template_json, created_by, is_active)
VALUES (
    1,
    '[
  {
    "name": "Project Delivery",
    "groups": [
      {
        "role": "reader",
        "email": "technical-team@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "dc-team@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "survey-team@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "projects-control@dtgsa.com"
      },
      {
        "role": "organizer",
        "email": "admin@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "quality-control@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "projects-managers@dtgsa.com"
      }
    ],
    "children": [
      {
        "name": "Quantity Survey",
        "groups": [
          {
            "role": "reader",
            "email": "technical-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "dc-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "survey-team@dtgsa.com"
          },
          {
            "role": "fileOrganizer",
            "email": "projects-control@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "quality-control@dtgsa.com"
          },
          {
            "role": "fileOrganizer",
            "email": "projects-managers@dtgsa.com"
          }
        ],
        "limitedAccess": false
      },
      {
        "name": "Engineering (EPC ONLY)",
        "groups": [
          {
            "role": "fileOrganizer",
            "email": "technical-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "dc-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "survey-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-control@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "quality-control@dtgsa.com"
          },
          {
            "role": "fileOrganizer",
            "email": "projects-managers@dtgsa.com"
          }
        ],
        "limitedAccess": false
      },
      {
        "name": "Project Control",
        "groups": [
          {
            "role": "fileOrganizer",
            "email": "dc-team@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "fileOrganizer",
            "email": "projects-managers@dtgsa.com"
          },
          {
            "email": "projects-control@dtgsa.com",
            "role": "writer"
          }
        ],
        "children": [
          {
            "name": "Commercial",
            "groups": [
              {
                "role": "reader",
                "email": "projects-control@dtgsa.com"
              },
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "fileOrganizer",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "children": [
              {
                "name": "Invoices",
                "groups": [
                  {
                    "role": "organizer",
                    "email": "admin@dtgsa.com"
                  },
                  {
                    "role": "fileOrganizer",
                    "email": "projects-managers@dtgsa.com"
                  }
                ],
                "limitedAccess": true
              },
              {
                "name": "Agreements",
                "groups": [
                  {
                    "role": "organizer",
                    "email": "admin@dtgsa.com"
                  },
                  {
                    "role": "fileOrganizer",
                    "email": "projects-managers@dtgsa.com"
                  }
                ],
                "children": [
                  {
                    "name": "Change Orders",
                    "groups": [
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Contract & PO",
                    "groups": [
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      }
                    ],
                    "limitedAccess": true
                  }
                ],
                "limitedAccess": true
              }
            ],
            "limitedAccess": true
          },
          {
            "name": "Planning",
            "groups": [
              {
                "role": "fileOrganizer",
                "email": "projects-control@dtgsa.com"
              },
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              }
            ],
            "children": [
              {
                "name": "Planning Deliverables",
                "groups": [
                  {
                    "role": "fileOrganizer",
                    "email": "projects-control@dtgsa.com"
                  },
                  {
                    "role": "organizer",
                    "email": "admin@dtgsa.com"
                  }
                ],
                "limitedAccess": true
              },
              {
                "name": "Reports",
                "groups": [
                  {
                    "role": "fileOrganizer",
                    "email": "projects-control@dtgsa.com"
                  },
                  {
                    "role": "organizer",
                    "email": "admin@dtgsa.com"
                  }
                ],
                "limitedAccess": true
              }
            ],
            "limitedAccess": true,
            "users": [
              {
                "email": "a.albaz@dtgsa.com",
                "role": "writer"
              }
            ]
          }
        ],
        "limitedAccess": true
      },
      {
        "name": "Quality Control",
        "groups": [
          {
            "role": "fileOrganizer",
            "email": "dc-team@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "fileOrganizer",
            "email": "projects-managers@dtgsa.com"
          },
          {
            "email": "quality-control@dtgsa.com",
            "role": "writer"
          }
        ],
        "limitedAccess": true,
        "users": [
          {
            "email": "a.albaz@dtgsa.com",
            "role": "writer"
          }
        ]
      },
      {
        "name": "Document Control",
        "groups": [
          {
            "role": "reader",
            "email": "technical-team@dtgsa.com"
          },
          {
            "role": "fileOrganizer",
            "email": "dc-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "survey-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-control@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "quality-control@dtgsa.com"
          },
          {
            "role": "fileOrganizer",
            "email": "projects-managers@dtgsa.com"
          }
        ],
        "children": [
          {
            "name": "MDR",
            "groups": [
              {
                "role": "reader",
                "email": "dc-team@dtgsa.com"
              },
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "reader",
                "email": "projects-managers@dtgsa.com"
              },
              {
                "email": "quality-control@dtgsa.com",
                "role": "writer"
              },
              {
                "email": "projects-control@dtgsa.com",
                "role": "writer"
              }
            ],
            "limitedAccess": true,
            "users": [
              {
                "email": "a.albaz@dtgsa.com",
                "role": "writer"
              }
            ]
          },
          {
            "name": "Forms",
            "groups": [
              {
                "role": "reader",
                "email": "dc-team@dtgsa.com"
              },
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "reader",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "limitedAccess": true
          },
          {
            "name": "Transmittals",
            "groups": [
              {
                "role": "fileOrganizer",
                "email": "dc-team@dtgsa.com"
              },
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "fileOrganizer",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "children": [
              {
                "name": "Sent",
                "groups": [
                  {
                    "role": "fileOrganizer",
                    "email": "dc-team@dtgsa.com"
                  },
                  {
                    "role": "organizer",
                    "email": "admin@dtgsa.com"
                  },
                  {
                    "role": "fileOrganizer",
                    "email": "projects-managers@dtgsa.com"
                  }
                ],
                "limitedAccess": true
              },
              {
                "name": "Received",
                "groups": [
                  {
                    "role": "fileOrganizer",
                    "email": "dc-team@dtgsa.com"
                  },
                  {
                    "role": "organizer",
                    "email": "admin@dtgsa.com"
                  },
                  {
                    "role": "fileOrganizer",
                    "email": "projects-managers@dtgsa.com"
                  }
                ],
                "limitedAccess": true
              }
            ],
            "limitedAccess": true
          },
          {
            "name": "Submittals",
            "groups": [
              {
                "role": "fileOrganizer",
                "email": "dc-team@dtgsa.com"
              },
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "fileOrganizer",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "children": [
              {
                "name": "Received",
                "groups": [
                  {
                    "role": "fileOrganizer",
                    "email": "dc-team@dtgsa.com"
                  },
                  {
                    "role": "organizer",
                    "email": "admin@dtgsa.com"
                  },
                  {
                    "role": "fileOrganizer",
                    "email": "projects-managers@dtgsa.com"
                  }
                ],
                "children": [
                  {
                    "name": "SI & CCCOR",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "projects-control@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Letters",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Quality Control",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "quality-control@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true,
                    "users": [
                      {
                        "email": "a.albaz@dtgsa.com",
                        "role": "writer"
                      }
                    ]
                  },
                  {
                    "name": "Project Control",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "projects-control@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Procurement",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Minutes of Meetings",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "EHS",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "hse-team@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Construction",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "operation-team@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true
                  }
                ],
                "limitedAccess": true
              },
              {
                "name": "Ongoing",
                "groups": [
                  {
                    "role": "fileOrganizer",
                    "email": "dc-team@dtgsa.com"
                  },
                  {
                    "role": "organizer",
                    "email": "admin@dtgsa.com"
                  },
                  {
                    "role": "fileOrganizer",
                    "email": "projects-managers@dtgsa.com"
                  }
                ],
                "children": [
                  {
                    "name": "SI & CCCOR",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "projects-control@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Letters",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Quality Control",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "quality-control@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true,
                    "users": [
                      {
                        "email": "a.albaz@dtgsa.com",
                        "role": "writer"
                      }
                    ]
                  },
                  {
                    "name": "Project Control",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "projects-control@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Procurement",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Minutes of Meetings",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "EHS",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "hse-team@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true
                  },
                  {
                    "name": "Construction",
                    "groups": [
                      {
                        "role": "fileOrganizer",
                        "email": "dc-team@dtgsa.com"
                      },
                      {
                        "role": "organizer",
                        "email": "admin@dtgsa.com"
                      },
                      {
                        "role": "fileOrganizer",
                        "email": "projects-managers@dtgsa.com"
                      },
                      {
                        "email": "operation-team@dtgsa.com",
                        "role": "writer"
                      }
                    ],
                    "limitedAccess": true
                  }
                ],
                "limitedAccess": true
              }
            ],
            "limitedAccess": true
          }
        ],
        "limitedAccess": false
      },
      {
        "name": "Survey",
        "groups": [
          {
            "role": "reader",
            "email": "technical-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "dc-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "survey-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-control@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "quality-control@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-managers@dtgsa.com"
          }
        ],
        "limitedAccess": false
      },
      {
        "name": "Operation",
        "groups": [
          {
            "role": "reader",
            "email": "technical-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "dc-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-control@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-managers@dtgsa.com"
          }
        ],
        "limitedAccess": false
      },
      {
        "name": "IFC Drawings",
        "groups": [
          {
            "role": "reader",
            "email": "technical-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "dc-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "survey-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-control@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "quality-control@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-managers@dtgsa.com"
          }
        ],
        "limitedAccess": false
      },
      {
        "name": "HSE",
        "groups": [
          {
            "role": "reader",
            "email": "technical-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "dc-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "survey-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-control@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "quality-control@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-managers@dtgsa.com"
          },
          {
            "email": "hse-team@dtgsa.com",
            "role": "writer"
          }
        ],
        "limitedAccess": false
      }
    ],
    "limitedAccess": false
  },
  {
    "name": "Bidding",
    "groups": [
      {
        "role": "reader",
        "email": "technical-team@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "dc-team@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "survey-team@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "projects-control@dtgsa.com"
      },
      {
        "role": "organizer",
        "email": "admin@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "quality-control@dtgsa.com"
      },
      {
        "role": "reader",
        "email": "projects-managers@dtgsa.com"
      }
    ],
    "children": [
      {
        "name": "Commercial Proposal",
        "groups": [
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "writer",
            "email": "projects-managers@dtgsa.com"
          }
        ],
        "children": [
          {
            "name": "Admin Only",
            "groups": [
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              }
            ],
            "limitedAccess": true,
            "users": [
              {
                "email": "mo.abuomar@dtgsa.com",
                "role": "writer"
              }
            ]
          }
        ],
        "limitedAccess": false
      },
      {
        "name": "Vendors Quotations",
        "groups": [
          {
            "role": "reader",
            "email": "technical-team@dtgsa.com"
          },
          {
            "role": "reader",
            "email": "projects-control@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "fileOrganizer",
            "email": "projects-managers@dtgsa.com"
          }
        ],
        "children": [
          {
            "name": "Civil and Finishes",
            "groups": [
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "fileOrganizer",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "limitedAccess": true
          },
          {
            "name": "IT",
            "groups": [
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "fileOrganizer",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "limitedAccess": true
          },
          {
            "name": "E&I",
            "groups": [
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "fileOrganizer",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "limitedAccess": true
          },
          {
            "name": "Mechanical",
            "groups": [
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "fileOrganizer",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "limitedAccess": true
          }
        ],
        "limitedAccess": false
      },
      {
        "name": "Technical Proposal",
        "groups": [
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "writer",
            "email": "projects-managers@dtgsa.com"
          },
          {
            "email": "projects-control@dtgsa.com",
            "role": "writer"
          }
        ],
        "children": [
          {
            "name": "TBE",
            "groups": [
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "writer",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "limitedAccess": true,
            "users": [
              {
                "email": "Marwan@dtgsa.com",
                "role": "writer"
              }
            ]
          },
          {
            "name": "Technical Proposal",
            "groups": [
              {
                "role": "organizer",
                "email": "admin@dtgsa.com"
              },
              {
                "role": "writer",
                "email": "projects-managers@dtgsa.com"
              }
            ],
            "limitedAccess": true
          }
        ],
        "limitedAccess": false,
        "users": [
          {
            "email": "a.albaz@dtgsa.com",
            "role": "writer"
          },
          {
            "email": "abed.ahmad@dtgsa.com",
            "role": "writer"
          },
          {
            "email": "Waseem@dtgsa.com",
            "role": "writer"
          }
        ]
      },
      {
        "name": "SOW",
        "groups": [
          {
            "role": "writer",
            "email": "technical-team@dtgsa.com"
          },
          {
            "role": "writer",
            "email": "projects-control@dtgsa.com"
          },
          {
            "role": "organizer",
            "email": "admin@dtgsa.com"
          },
          {
            "role": "writer",
            "email": "projects-managers@dtgsa.com"
          }
        ],
        "limitedAccess": true,
        "users": [
          {
            "email": "abed.ahmad@dtgsa.com",
            "role": "writer"
          },
          {
            "email": "Waseem@dtgsa.com",
            "role": "writer"
          }
        ]
      }
    ],
    "limitedAccess": false
  }
]'::jsonb,
    'system',
    true
);

