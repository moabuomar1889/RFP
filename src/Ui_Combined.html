<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #f5f7fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .main-header { background: #2c3e50; color: white; padding: 1rem 1.25rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #3498db; }
    .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-radius: 8px; margin-bottom: 0.75rem !important; }
    .card-header { background: #34495e; color: white; border-radius: 8px 8px 0 0 !important; border-bottom: 2px solid #3498db; padding: 0.5rem 1rem !important; }
    .card-body { padding: 0.75rem 1rem !important; }
    #adminTree { background: #fff; padding: 12px; border-radius: 8px; border: 2px solid #e1e8ed; min-height: 300px; }
    .group-badge { margin: 1px; cursor:pointer; transition: all 0.3s; }
    .group-badge:hover { transform: scale(1.05); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }
    .node-edit-input { display:inline-block; width:80%; }
    .btn-action { transition: all 0.3s; }
    .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .nav-tabs { border-bottom: 2px solid #e1e8ed; margin-bottom: 0.75rem !important; }
    .nav-tabs .nav-link { border: none; color: #34495e; font-weight: 500; padding: 0.5rem 0.75rem; font-size: 0.9em; }
    .nav-tabs .nav-link.active { background: #34495e; color: white; border-radius: 8px 8px 0 0; border-bottom: 2px solid #3498db; }
    .feature-card { transition: all 0.3s; cursor: pointer; }
    .feature-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    
    /* Custom Tree Table Styles */
    .tree-table { width: 100%; }
    .tree-table td { vertical-align: middle; padding: 6px 8px; border-bottom: 1px solid #e1e8ed; }
    .tree-table tr:hover { background-color: #f8f9fa; }
    .tree-table tr.selected { background-color: #e3f2fd !important; border-left: 3px solid #3498db; }
    .tree-table tr.selected:hover { background-color: #d0e7ff !important; }
    .tree-node-indent { display: inline-block; width: 18px; }
    .tree-node-name { font-weight: 500; cursor: pointer; font-size: 0.95em; }
    .tree-node-name:hover { color: #3498db; }
    .tree-node-name .bi-folder2 { 
      color: #3498db !important; 
    }
    .tree-node-badge { font-size: 0.7em; padding: 2px 6px; border-radius: 10px; }
    .tree-action-btn { padding: 3px 6px; font-size: 0.8em; margin: 0 1px; }
    .tree-status-icon { font-size: 1.1em; cursor: pointer; transition: all 0.2s; }
    .tree-status-icon:hover { transform: scale(1.2); }
    .tree-status-icon.active { color: #e74c3c; }
    .tree-status-icon.inactive { color: #95a5a6; }
    .tree-groups-count { font-size: 0.8em; color: #3498db; cursor: pointer; }
    .tree-groups-count:hover { text-decoration: underline; }
    
    /* Condensed spacing utilities */
    .condensed { margin-bottom: 0.5rem !important; }
    .condensed-sm { margin-bottom: 0.25rem !important; }
    .alert { padding: 0.5rem 0.75rem !important; margin-bottom: 0.5rem !important; }
    .form-label { margin-bottom: 0.25rem !important; }
    .input-group { margin-bottom: 0.5rem !important; }
    h5, h6 { margin-bottom: 0.5rem !important; }
    .mb-3 { margin-bottom: 0.75rem !important; }
    .mb-4 { margin-bottom: 1rem !important; }
    .mt-3 { margin-top: 0.75rem !important; }
    .mt-4 { margin-top: 1rem !important; }
    .p-3 { padding: 0.75rem !important; }
    .p-4 { padding: 1rem !important; }
    .py-2 { padding-top: 0.5rem !important; padding-bottom: 0.5rem !important; }
    .gap-2 { gap: 0.5rem !important; }
    
    /* Theme Colors - Custom Palette */
    :root {
      --theme-elephant: #163655;
      --theme-white-linen: #fcf7f4;
      --theme-slate-gray: #6d7f91;
      --theme-submarine: #b8bec5;
      --theme-blue-bayoux: #435c74;
      
      /* Default theme colors */
      --theme-primary: var(--theme-elephant);
      --theme-secondary: var(--theme-blue-bayoux);
      --theme-background: var(--theme-white-linen);
      --theme-text: var(--theme-slate-gray);
      --theme-border: var(--theme-submarine);
      --theme-accent: var(--theme-blue-bayoux);
      
      /* Bootstrap overrides */
      --bs-info: var(--theme-blue-bayoux);
      --bs-warning: #fd7e14;
    }
    
    /* Apply theme colors */
    body { 
      background-color: var(--theme-background) !important; 
      color: var(--theme-text);
    }
    .main-header { 
      background: var(--theme-primary) !important; 
      color: white; 
      border-left: 4px solid var(--theme-accent) !important;
    }
    .card-header { 
      background: var(--theme-primary) !important; 
      color: white; 
      border-bottom: 2px solid var(--theme-accent) !important;
    }
    .nav-tabs .nav-link { 
      color: var(--theme-primary) !important;
    }
    .nav-tabs .nav-link.active { 
      background: var(--theme-primary) !important; 
      color: white !important;
      border-bottom: 2px solid var(--theme-accent) !important;
    }
    .nav-tabs .nav-link:hover {
      color: var(--theme-primary) !important;
    }
    .nav-tabs .nav-link.active:hover {
      color: white !important;
    }
    /* Button styles with proper text contrast */
    .btn-primary {
      --bs-btn-color: #fff !important;
      --bs-btn-bg: var(--theme-primary);
      --bs-btn-border-color: var(--theme-primary);
      --bs-btn-hover-color: #fff !important;
      --bs-btn-hover-bg: var(--theme-secondary);
      --bs-btn-hover-border-color: var(--theme-secondary);
      color: #fff !important;
    }
    .btn-outline-primary {
      --bs-btn-color: var(--theme-primary) !important;
      --bs-btn-border-color: var(--theme-primary);
      --bs-btn-hover-color: #fff !important;
      --bs-btn-hover-bg: var(--theme-primary);
      --bs-btn-hover-border-color: var(--theme-primary);
      color: var(--theme-primary) !important;
    }
    .btn-outline-primary:hover {
      color: #fff !important;
    }
    .btn-secondary {
      --bs-btn-color: #fff !important;
      --bs-btn-bg: var(--theme-secondary);
      --bs-btn-border-color: var(--theme-secondary);
      --bs-btn-hover-color: #fff !important;
      --bs-btn-hover-bg: var(--theme-primary);
      --bs-btn-hover-border-color: var(--theme-primary);
      color: #fff !important;
    }
    .btn-outline-secondary {
      --bs-btn-color: var(--theme-secondary) !important;
      --bs-btn-border-color: var(--theme-secondary);
      --bs-btn-hover-color: #fff !important;
      --bs-btn-hover-bg: var(--theme-secondary);
      --bs-btn-hover-border-color: var(--theme-secondary);
      color: var(--theme-secondary) !important;
    }
    .btn-outline-secondary:hover {
      color: #fff !important;
    }
    /* Ensure all buttons have visible text */
    .btn {
      color: inherit !important;
    }
    .btn-primary, .btn-secondary, .btn-success, .btn-danger, .btn-info {
      color: #fff !important;
    }
    .btn-warning {
      color: #000 !important;
    }
    .btn-outline-primary, .btn-outline-secondary, .btn-outline-success, .btn-outline-danger, .btn-outline-info {
      color: inherit !important;
    }
    .btn-outline-warning {
      color: #fd7e14 !important;
    }
    .btn-outline-primary:hover, .btn-outline-secondary:hover, .btn-outline-success:hover, .btn-outline-danger:hover, .btn-outline-info:hover {
      color: #fff !important;
    }
    .btn-outline-warning:hover {
      color: #000 !important;
    }
    .tree-node-name:hover { 
      color: var(--theme-accent) !important; 
    }
    .tree-node-name .bi-folder2 { 
      color: var(--theme-accent) !important; 
    }
    .tree-groups-count { 
      color: var(--theme-accent) !important; 
    }
    .tree-table tr.selected { 
      background-color: rgba(22, 54, 85, 0.1) !important; 
      border-left: 3px solid var(--theme-accent) !important; 
    }
    .tree-table tr.selected:hover { 
      background-color: rgba(22, 54, 85, 0.15) !important; 
    }
    .card { 
      background-color: white;
      border: 1px solid var(--theme-border) !important;
    }
    #adminTree { 
      background: white; 
      border: 2px solid var(--theme-border) !important; 
    }
    .nav-tabs { 
      border-bottom: 2px solid var(--theme-border) !important; 
    }
    .tree-table td { 
      border-bottom: 1px solid var(--theme-border) !important; 
    }
    .btn-info {
      --bs-btn-color: #fff !important;
      --bs-btn-bg: var(--theme-blue-bayoux, #435c74);
      --bs-btn-border-color: var(--theme-blue-bayoux, #435c74);
      --bs-btn-hover-color: #fff !important;
      --bs-btn-hover-bg: var(--theme-primary);
      --bs-btn-hover-border-color: var(--theme-primary);
      color: #fff !important;
    }
    .btn-outline-info {
      --bs-btn-color: var(--theme-blue-bayoux, #435c74) !important;
      --bs-btn-border-color: var(--theme-blue-bayoux, #435c74);
      --bs-btn-hover-color: #fff !important;
      --bs-btn-hover-bg: var(--theme-blue-bayoux, #435c74);
      --bs-btn-hover-border-color: var(--theme-blue-bayoux, #435c74);
      color: var(--theme-blue-bayoux, #435c74) !important;
    }
    .btn-outline-info:hover {
      color: #fff !important;
    }
    .btn-warning {
      --bs-btn-color: #000 !important;
      --bs-btn-bg: #fd7e14;
      --bs-btn-border-color: #fd7e14;
      --bs-btn-hover-color: #000 !important;
      --bs-btn-hover-bg: #dc6502;
      --bs-btn-hover-border-color: #c55a02;
      color: #000 !important;
    }
    .btn-outline-warning {
      --bs-btn-color: #fd7e14 !important;
      --bs-btn-border-color: #fd7e14;
      --bs-btn-hover-color: #000 !important;
      --bs-btn-hover-bg: #fd7e14;
      --bs-btn-hover-border-color: #fd7e14;
      color: #fd7e14 !important;
    }
    .btn-outline-warning:hover {
      color: #000 !important;
    }
    .btn-success {
      color: #fff !important;
    }
    .btn-outline-success {
      color: #198754 !important;
    }
    .btn-outline-success:hover {
      color: #fff !important;
    }
    .btn-danger {
      color: #fff !important;
    }
    .btn-outline-danger {
      color: #dc3545 !important;
    }
    .btn-outline-danger:hover {
      color: #fff !important;
    }
    .bg-info {
      background-color: var(--theme-blue-bayoux, #435c74) !important;
    }
    .text-info {
      color: var(--theme-blue-bayoux, #435c74) !important;
    }
    .badge.bg-info {
      background-color: var(--theme-blue-bayoux, #435c74) !important;
    }
    
    /* Additional button text color fixes */
    .btn-outline-light {
      color: #fff !important;
      border-color: rgba(255, 255, 255, 0.5) !important;
    }
    .btn-outline-light:hover {
      color: #000 !important;
      background-color: #fff !important;
      border-color: #fff !important;
    }
  </style>
</head>
<body>
<div class="container mt-2">
  <!-- Header -->
  <div class="main-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h2 class="mb-0" style="font-size: 1.5rem;"><i class="bi bi-folder-fill text-info"></i> Project Folders Management</h2>
        <p class="mb-0 text-light" style="font-size: 0.85em;">Integrated system for managing folder structure and permissions</p>
      </div>
      <div class="col-md-4 text-end">
        <div class="badge bg-light text-dark p-2 mb-1">
          <i class="bi bi-person-circle"></i> <span id="meEmail">â€”</span>
        </div>
        <div class="badge bg-info text-white p-2 mb-1" style="font-size: 0.75em;">
          <i class="bi bi-code-square"></i> Rev: <span id="revisionNumber">â€”</span>
        </div>
        <button class="btn btn-sm btn-outline-light" onclick="showThemeModal()" title="Change Theme">
          <i class="bi bi-palette"></i> Theme
        </button>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-2" id="mainTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#approvalTab" type="button">
        <i class="bi bi-envelope-paper"></i> Send Approval Request
      </button>
    </li>
    <li class="nav-item" id="adminTabBtn">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminStructureTab" type="button">
        <i class="bi bi-diagram-3"></i> Folder Structure
      </button>
    </li>
    <li class="nav-item" id="groupsTabBtn">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#groupsAccessTab" type="button">
        <i class="bi bi-people"></i> Groups & Members
      </button>
    </li>
    <li class="nav-item" id="fileRestrictionsTabBtn">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#fileRestrictionsTab" type="button">
        <i class="bi bi-shield-exclamation"></i> File Restrictions
      </button>
    </li>
    <li class="nav-item" id="featureSelectorTabBtn">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#featureSelectorTab" type="button">
        <i class="bi bi-list-check"></i> Feature Selector
      </button>
    </li>
    <li class="nav-item" id="codeAnalyzerTabBtn">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#codeAnalyzerTab" type="button">
        <i class="bi bi-bug"></i> Code Analyzer
      </button>
    </li>
    <li class="nav-item" id="testRunnerTabBtn">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#testRunnerTab" type="button">
        <i class="bi bi-play-circle"></i> Test Runner
      </button>
    </li>
    <li class="nav-item" id="activityMonitorTabBtn">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#activityMonitorTab" type="button">
        <i class="bi bi-activity"></i> Activity Monitor
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#folderScanTab" type="button" onclick="loadSnapshotStatus()">
        <i class="bi bi-search"></i> Folder Scan
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Approval Tab -->
    <div class="tab-pane fade show active" id="approvalTab">
      <div class="row">
        <!-- Main Content: Send Approval Request -->
        <div class="col-lg-8 col-md-12">
          <div class="card">
            <div class="card-header py-2">
              <h6 class="mb-0"><i class="bi bi-envelope-paper"></i> Send Approval Request</h6>
            </div>
            <div class="card-body p-2">
              <div class="alert alert-info mb-2 py-1" style="font-size: 0.85em;">
                <i class="bi bi-info-circle"></i> <strong>How it works:</strong> Select the phase and enter the project name. An email will be sent for approval to create the folders.
              </div>

              <div class="row g-2">
                <div class="col-md-12">
                  <label class="form-label fw-bold small"><i class="bi bi-diagram-2"></i> Phase</label>
                  <select id="phase" class="form-select form-select-sm" onchange="togglePhase()">
                    <option value="bidding">ðŸ“‹ Bidding (RFP) - Create New Project</option>
                    <option value="project_delivery">ðŸš€ Project Delivery - Upgrade Existing Project</option>
          </select>
        </div>

                <div class="col-md-12" id="biddingSection">
                  <label class="form-label fw-bold small"><i class="bi bi-folder-plus"></i> Project Name</label>
                  <input type="text" id="projectName" class="form-control form-control-sm" placeholder="Enter project name (e.g., Project-2024)">
                  <div class="form-text small">A new folder will be created with name: PRJ-XXX-ProjectName</div>
        </div>

                <div class="col-md-12" id="deliverySection" style="display:none;">
                  <label class="form-label fw-bold small"><i class="bi bi-arrow-up-circle"></i> Select Project to Upgrade</label>
                  <select id="existingProjects" class="form-select form-select-sm">
                    <option value="">Loading...</option>
                  </select>
                  <div class="form-text small">Projects shown are those without a Project Delivery folder</div>
        </div>

                <div class="col-md-12">
                  <button class="btn btn-outline-primary btn-sm w-100 btn-action" onclick="sendApproval()" id="sendApprovalBtn">
                    <span class="btn-text"><i class="bi bi-send"></i> Send Approval Request</span>
                    <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Sending...</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Side Card: Approval Recipients Management -->
        <div class="col-lg-4 col-md-12">
          <div class="card" style="position: sticky; top: 20px;">
            <div class="card-header py-2">
              <h6 class="mb-0"><i class="bi bi-envelope-at"></i> Approval Email Recipients</h6>
            </div>
            <div class="card-body p-2">
              <div class="alert alert-info mb-2 py-1" style="font-size: 0.8em;">
                <i class="bi bi-info-circle"></i> <strong>Note:</strong> All approval requests will be sent to mo.abuomar@dtgsa.com in addition to the list below.
              </div>
              
              <div class="mb-2">
                <div class="input-group input-group-sm">
                  <input type="email" id="newRecipientEmail" class="form-control form-control-sm" placeholder="Enter email">
                  <button class="btn btn-outline-success btn-sm" onclick="addApprovalRecipient()">
                    <i class="bi bi-plus-circle"></i> Add
                  </button>
                </div>
              </div>
              
              <div id="recipientsList" class="mb-2" style="max-height: 300px; overflow-y: auto;">
                <div class="text-center text-muted">
                  <button class="btn btn-outline-primary btn-sm w-100" onclick="loadApprovalRecipients()">
                    <i class="bi bi-download"></i> Load Recipients
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin: Folder Structure -->
    <div class="tab-pane fade" id="adminStructureTab">
      <!-- Quick Actions -->
      <div class="card mb-2">
        <div class="card-header">
          <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-tools"></i> Folder Management</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-light border mb-2">
            <div class="d-flex align-items-center mb-2">
              <i class="bi bi-info-circle text-primary me-2"></i>
              <strong>How to use:</strong>
            </div>
            <ul class="mb-0 small">
              <li>Select a folder from the tree below to manage it</li>
              <li>Use the buttons below to add/modify/delete folders</li>
              <li>You can double-click on a folder name to rename it directly</li>
            </ul>
      </div>

          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-success btn-action" onclick="addChildNode()" id="addChildBtn">
              <i class="bi bi-plus-circle"></i> Add Child Folder
            </button>
            <button class="btn btn-outline-success btn-action" onclick="addSiblingNode()" id="addSiblingBtn">
              <i class="bi bi-node-plus"></i> Add Sibling Folder
            </button>
            <button class="btn btn-outline-primary btn-action" onclick="showBulkAddModal()" id="bulkAddBtn">
              <i class="bi bi-list-ul"></i> Bulk Add Folders
            </button>
            <button class="btn btn-outline-info btn-action" onclick="showImportFromDriveModal()" id="importDriveBtn">
              <i class="bi bi-cloud-download"></i> Import from Drive
            </button>
            <button class="btn btn-outline-warning btn-action" onclick="renameNode()" id="renameBtn">
              <i class="bi bi-pencil-square"></i> Rename
            </button>
            <button class="btn btn-outline-danger btn-action" onclick="deleteNode()" id="deleteBtn">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>


      <!-- Main Layout: Tree on left, Settings & Actions on right -->
      <div class="row g-4">
        <!-- Left Column: Folder Tree -->
        <div class="col-lg-8">
          <div class="card mb-2">
            <div class="card-header">
              <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-diagram-3"></i> Folder Structure</h5>
            </div>
            <div class="card-body p-0">
              <div class="alert alert-light border m-2 mb-0">
                <div class="d-flex align-items-center">
                  <i class="bi bi-info-circle text-primary me-2"></i>
                  <div class="small">
                    <strong>How to use:</strong> 
                    <span class="ms-2"><i class="bi bi-shield-lock-fill text-danger"></i> = Protection enabled</span>
                    <span class="ms-2"><i class="bi bi-people-fill text-primary"></i> = Number of groups</span>
                    <span class="ms-2">Use the buttons in the table to control</span>
                  </div>
                </div>
              </div>
              
              <div class="table-responsive" style="max-height: calc(100vh - 300px); overflow-y: auto;">
                <table class="table tree-table table-hover mb-0">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th style="width: 40%;">Folder Name</th>
                      <th style="width: 15%;" class="text-center">Protection</th>
                      <th style="width: 15%;" class="text-center">Groups</th>
                      <th style="width: 30%;" class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="treeTableBody">
                    <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Keep old tree for reference (hidden) -->
              <div id="adminTree" style="display:none;"></div>
            </div>
          </div>
        </div>

        <!-- Right Column: Settings & Actions -->
        <div class="col-lg-4">
          <!-- Folder Settings -->
          <div class="card mb-2" id="folderSettingsCard" style="display:none;">
            <div class="card-header">
              <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-shield-lock"></i> Folder Permissions Settings</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-light border mb-2">
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-info-circle text-primary me-2"></i>
                  <strong>How do permissions work?</strong>
                </div>
                <ul class="mb-0 small">
                  <li>All folders are <strong>visible to everyone</strong> in the organization (unless protection is enabled)</li>
                  <li>When "Folder Protection" is enabled, this folder will be <strong>protected</strong> and invisible to everyone</li>
                  <li>Only the groups specified below can see and access this folder</li>
                </ul>
              </div>

              <!-- Protection Toggle -->
              <div class="card border-primary mb-2">
                <div class="card-body p-2">
                  <div class="form-check form-switch mb-1">
                    <input class="form-check-input" type="checkbox" id="limitedAccessToggle" onchange="toggleLimitedAccess()" style="transform: scale(1.5);">
                    <label class="form-check-label fw-bold" for="limitedAccessToggle" style="font-size: 1.2em;">
                      ðŸ”’ Folder Protection
                    </label>
                  </div>
                  <div class="text-muted">
                    When enabled: The folder is protected and invisible to everyone, only the groups specified below can see and access it
                  </div>
                </div>
              </div>

              <!-- Groups Section -->
              <div id="groupsSection">
                <h6 class="mb-3"><i class="bi bi-people-fill"></i> Allowed Groups & Users</h6>
                
                <div class="alert alert-warning mb-3" id="protectionWarning" style="display:none;">
                  <i class="bi bi-exclamation-triangle"></i> <strong>Note:</strong> You can add groups and users now, but permissions will only be applied when "Folder Protection" above is enabled.
                </div>
                
                <div id="groupList" class="mb-3 p-3 bg-light rounded" style="min-height: 60px;"></div>
                
                <!-- Add Group -->
                <div class="mb-3">
                  <label class="form-label small fw-bold"><i class="bi bi-people"></i> Add Group</label>
                  <div class="row g-2">
                    <div class="col-md-5">
                      <select id="groupSelect" class="form-select form-select-sm">
                        <option value="">-- Loading groups... --</option>
          </select>
        </div>
                    <div class="col-md-4">
                      <select id="groupRoleSelect" class="form-select form-select-sm">
                        <option value="reader" title="View only">Viewer</option>
                        <option value="commenter" title="View and comment">Commenter</option>
                        <option value="writer" title="Add, edit, and share files">Contributor</option>
                        <option value="fileOrganizer" title="Add, edit, move, delete and share content">Content manager</option>
                        <option value="organizer" title="Manage content, people, and settings">Manager</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-outline-success btn-sm w-100 btn-action" onclick="addGroupToNode()">
                        <i class="bi bi-plus-circle"></i> Add
                      </button>
                    </div>
                  </div>
      </div>

                <!-- Add User -->
                <div class="mb-3">
                  <label class="form-label small fw-bold"><i class="bi bi-person"></i> Add User</label>
                  <div class="row g-2">
                    <div class="col-md-5">
                      <input type="email" id="userEmailInput" class="form-control form-control-sm" placeholder="user@example.com">
                    </div>
                    <div class="col-md-4">
                      <select id="userRoleSelect" class="form-select form-select-sm">
                        <option value="reader" title="View only">Viewer</option>
                        <option value="commenter" title="View and comment">Commenter</option>
                        <option value="writer" title="Add, edit, and share files">Contributor</option>
                        <option value="fileOrganizer" title="Add, edit, move, delete and share content">Content manager</option>
                        <option value="organizer" title="Manage content, people, and settings">Manager</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <button class="btn btn-outline-info btn-sm w-100 btn-action" onclick="addUserToNode()">
                        <i class="bi bi-plus-circle"></i> Add
                      </button>
                    </div>
                  </div>
                </div>

                <div class="alert alert-info mt-3 mb-2">
                  <i class="bi bi-lightbulb"></i> <strong>Tip:</strong> You can add multiple groups and users with different roles. Permissions will be applied to the folder when "Folder Protection" above is enabled.
                </div>
                
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-primary btn-sm" onclick="applyPermissionsToFolder()" title="Apply permissions to this folder">
                    <i class="bi bi-arrow-clockwise"></i> Apply Permissions to Folder
                  </button>
                </div>
              </div>

              <!-- No folder selected -->
              <div id="noFolderSelected" class="text-center text-muted py-5">
                <i class="bi bi-folder-x" style="font-size: 4em; opacity: 0.3;"></i>
                <p class="mt-3">Select a folder from the tree to manage its permissions</p>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-gear"></i> Main Operations</h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-1">
                <button class="btn btn-outline-primary w-100 btn-action" onclick="adminSaveStructure()" id="saveBtn">
                  <span class="btn-text"><i class="bi bi-save"></i> Save Structure</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Saving...</span>
                </button>
                <button class="btn btn-outline-warning w-100 btn-action" onclick="adminApplyAll()" id="applyBtn">
                  <span class="btn-text"><i class="bi bi-arrow-repeat"></i> Apply to All Projects</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Applying...</span>
                </button>
                <button class="btn btn-outline-info w-100 btn-action" onclick="applyLimitedAccessToAll()" id="limitedAccessBtn">
                  <span class="btn-text"><i class="bi bi-shield-lock"></i> Apply Protection to All</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Applying...</span>
                </button>
                <button class="btn btn-outline-info w-100 btn-action" onclick="scanDuplicates()" id="scanBtn">
                  <span class="btn-text"><i class="bi bi-search"></i> Scan for Duplicates</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Scanning...</span>
                </button>
                <button class="btn btn-outline-danger w-100 btn-action" onclick="adminResetTemplate()" id="resetBtn" style="display:none;">
                  <span class="btn-text"><i class="bi bi-arrow-counterclockwise"></i> Reset to Default</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Resetting...</span>
                </button>
                <button class="btn btn-outline-info w-100 btn-action" onclick="showTreeStateInUI()" id="showTreeStateBtn">
                  <span class="btn-text"><i class="bi bi-info-circle"></i> Show Tree State</span>
                </button>
                <button class="btn btn-outline-secondary w-100 btn-action" onclick="syncTemplateFromDrive()" id="syncTemplateBtn">
                  <span class="btn-text"><i class="bi bi-arrow-repeat"></i> Sync from Drive</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Syncing...</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Template Backup Card -->
          <div class="card mb-2">
            <div class="card-header">
              <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-shield-check"></i> Template Backup & Restore</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info mb-2 py-1" style="font-size: 0.85em;">
                <i class="bi bi-info-circle"></i> <strong>Backup Protection:</strong> Save the current tree structure as a backup. You can restore it later if something goes wrong.
              </div>
              
              <div id="backupInfo" class="mb-2 p-2 bg-light rounded small" style="display:none;">
                <div><strong>Last Backup:</strong> <span id="backupTimestamp">-</span></div>
              </div>
              
              <div class="d-grid gap-1">
                <button class="btn btn-outline-success w-100 btn-action" onclick="saveTemplateBackupUI()" id="saveBackupBtn">
                  <span class="btn-text"><i class="bi bi-save"></i> Save Current as Backup</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Saving...</span>
                </button>
                <button class="btn btn-outline-warning w-100 btn-action" onclick="restoreTemplateBackupUI()" id="restoreBackupBtn">
                  <span class="btn-text"><i class="bi bi-arrow-counterclockwise"></i> Restore from Backup</span>
                  <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Restoring...</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Tree State Display Card -->
          <div class="card mb-2" id="treeStateCard" style="display:none;">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-diagram-3"></i> Current Tree State</h5>
              <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('treeStateCard').style.display='none'">
                <i class="bi bi-x"></i>
              </button>
            </div>
            <div class="card-body">
              <div id="treeStateContent" class="small"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin: Groups & Access -->
    <div class="tab-pane fade" id="groupsAccessTab">
      <!-- All Users with Groups -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-people-fill"></i> All Domain Users & Group Management</h5>
          <button class="btn btn-sm btn-primary" onclick="loadAllUsersWithGroups()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div class="card-body">
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i> <strong>Note:</strong> Displays all users in the organization with the groups they belong to. You can add or remove users from groups directly. Requires AdminDirectory API to be enabled.
      </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <input type="text" id="usersSearchInput" class="form-control" placeholder="Search by email or name..." onkeyup="filterUsersTable()">
            </div>
            <div class="col-md-6">
              <select id="filterByGroup" class="form-select" onchange="filterUsersByGroup()">
                <option value="">All Groups</option>
              </select>
            </div>
          </div>
          
          <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-hover table-sm">
              <thead class="table-light sticky-top">
                <tr>
                  <th style="width: 25%;">User</th>
                  <th style="width: 50%;">Groups</th>
                  <th style="width: 25%;">Actions</th>
                </tr>
              </thead>
              <tbody id="allUsersTableBody">
                <tr>
                  <td colspan="3" class="text-center text-muted">
                    <button class="btn btn-outline-primary" onclick="loadAllUsersWithGroups()">
                      <i class="bi bi-download"></i> Load Users
                    </button>
                  </td>
                </tr>
              </tbody>
          </table>
          </div>
          </div>
        </div>

      <!-- Group Roles -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-shield-check"></i> Group Roles (Default Permissions)</h5>
          <button class="btn btn-sm btn-primary" onclick="loadGroupsForRoles()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div class="card-body">
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle"></i> <strong>Note:</strong> These settings are general for all groups. You can specify special permissions for each folder from the "Folder Structure" tab.
        </div>

          <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-hover">
              <thead class="table-light sticky-top">
                <tr>
                  <th style="width: 35%;">Group Name</th>
                  <th style="width: 35%;">Email</th>
                  <th style="width: 30%;">Default Role</th>
                </tr>
              </thead>
              <tbody id="groupsTableBody">
                <tr>
                  <td colspan="3" class="text-center text-muted">
                    <button class="btn btn-outline-primary" onclick="loadGroupsForRoles()">
                      <i class="bi bi-download"></i> Load Groups
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mt-3">
            <button class="btn btn-outline-success btn-action" onclick="savePolicy()">
              <i class="bi bi-save"></i> Save Policy
            </button>
          </div>
        </div>
      </div>


      <!-- System Actions -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-tools"></i> System Operations</h5>
          </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <button class="btn btn-outline-primary w-100 btn-action" onclick="syncAllNewOnly()">
                <i class="bi bi-lightning"></i> Sync New Projects Only
              </button>
          </div>
            <div class="col-md-4">
              <button class="btn btn-outline-danger w-100 btn-action" onclick="syncAllAudit()">
                <i class="bi bi-shield-check"></i> Sync All Projects
              </button>
          </div>
            <div class="col-md-4">
              <button class="btn btn-outline-secondary w-100 btn-action" onclick="loadLogs()">
                <i class="bi bi-journal-text"></i> View Logs
              </button>
        </div>
          </div>

          <div class="mt-3" id="logsBox" style="display:none;">
            <div class="card bg-light">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Recent Logs</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadLogs()">
                  <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
              </div>
              <div class="card-body">
                <div id="logsContent" class="mono small" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85em;"></div>
              </div>
            </div>
          </div>
          
        <div class="mt-2">
            <div class="card bg-info bg-opacity-10">
              <div class="card-body p-2">
                <h6 style="font-size: 0.95rem;"><i class="bi bi-bug"></i> Test Folder Permissions</h6>
                <p class="small text-muted mb-1" style="font-size: 0.8em;">Enter a folder ID from Google Drive to test its permissions</p>
                <div class="input-group mb-1">
                  <input type="text" class="form-control" id="testFolderId" placeholder="Folder ID (e.g., 1abc123def456)">
                  <button class="btn btn-outline-primary" onclick="testFolderPermissions()">
                    <i class="bi bi-search"></i> Test
                  </button>
        </div>
                <div id="testPermissionsResult" class="mt-2" style="display:none;"></div>
              </div>
            </div>
      </div>
        </div>
      </div>
    </div>

    <!-- File Restrictions Tab -->
    <div class="tab-pane fade" id="fileRestrictionsTab">
      <div class="row">
        <div class="col-md-6">
          <!-- Blocked File Types -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-shield-x"></i> Blocked File Types</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle"></i> <strong>Note:</strong> Files of these types will be automatically deleted when uploaded to Shared Drive.
              </div>
              
              <div class="mb-3">
                <div class="input-group">
                  <input type="text" id="newBlockedExtension" class="form-control" placeholder="Enter file extension (e.g., exe, bat, reg)" maxlength="10">
                  <button class="btn btn-outline-danger" onclick="addBlockedExtension()">
                    <i class="bi bi-plus-circle"></i> Add
                  </button>
                </div>
                <small class="text-muted">Enter extension without dot (e.g., "exe" not ".exe")</small>
              </div>
              
              <div id="blockedExtensionsList" class="mb-3">
                <div class="text-center text-muted">
                  <button class="btn btn-outline-primary" onclick="loadFileRestrictions()">
                    <i class="bi bi-download"></i> Load Blocked Extensions
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <!-- Allowed File Types (Whitelist) -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-shield-check"></i> Allowed File Types (Optional Whitelist)</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle"></i> <strong>Note:</strong> If you enable the whitelist, only files of these types will be allowed. Leave it empty to allow all files (except blocked ones).
              </div>
              
        <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="whitelistEnabled" onchange="toggleWhitelist()">
                <label class="form-check-label" for="whitelistEnabled">
                  <strong>Enable Whitelist Mode</strong>
                </label>
        </div>
              
              <div class="mb-3">
                <div class="input-group">
                  <input type="text" id="newAllowedExtension" class="form-control" placeholder="Enter file extension (e.g., pdf, docx, xlsx)" maxlength="10">
                  <button class="btn btn-outline-success" onclick="addAllowedExtension()">
                    <i class="bi bi-plus-circle"></i> Add
                  </button>
        </div>
                <small class="text-muted">Enter extension without dot (e.g., "pdf" not ".pdf")</small>
      </div>

              <div id="allowedExtensionsList" class="mb-3">
                <div class="text-center text-muted">
                  <button class="btn btn-outline-primary" onclick="loadFileRestrictions()">
                    <i class="bi bi-download"></i> Load Allowed Extensions
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- File Monitoring Status -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-activity"></i> File Monitoring Status</h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> <strong>How it works:</strong> Files uploaded to Shared Drive are automatically monitored. Blocked files will be deleted immediately, and a notification will be sent to the user who uploaded them.
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span><strong>Monitoring Status:</strong></span>
                <span id="monitoringStatus" class="badge bg-secondary">Checking...</span>
              </div>
              <button class="btn btn-outline-primary" onclick="checkMonitoringStatus()">
                <i class="bi bi-arrow-clockwise"></i> Refresh Status
              </button>
            </div>
            <div class="col-md-6">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <span><strong>Last Check:</strong></span>
                <span id="lastCheckTime" class="text-muted">â€”</span>
              </div>
              <button class="btn btn-outline-success" onclick="setupFileMonitoring()">
                <i class="bi bi-play-circle"></i> Setup/Enable Monitoring
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Monitor Tab -->
    <div class="tab-pane fade" id="activityMonitorTab">
      <div class="container-fluid">
        <!-- Header -->
        <div class="card mb-2" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
          <div class="card-body text-center p-2">
            <h2 style="font-size: 1.5rem; margin-bottom: 0.25rem;"><i class="bi bi-activity"></i> Shared Drive Activity Monitor</h2>
            <p class="mb-0" style="font-size: 0.85em;">Monitor user activities on Shared Drive (views, edits, downloads, shares, etc.)</p>
          </div>
        </div>

        <!-- Filters -->
        <div class="card mb-2">
          <div class="card-header">
            <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-funnel"></i> Activity Filters</h5>
          </div>
          <div class="card-body p-2">
        <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label small"><strong>Time Range:</strong></label>
                <select id="activityDays" class="form-select form-select-sm">
                  <option value="1">Last 24 Hours</option>
                  <option value="3">Last 3 Days</option>
                  <option value="7" selected>Last 7 Days</option>
                  <option value="14">Last 14 Days</option>
                  <option value="30">Last 30 Days</option>
                  <option value="custom">Custom Range</option>
                </select>
          </div>
              <div class="col-md-3" id="customDateRange" style="display:none;">
                <label class="form-label small"><strong>Start Date:</strong></label>
                <input type="date" id="activityStartDate" class="form-control form-control-sm">
          </div>
              <div class="col-md-3" id="customDateRangeEnd" style="display:none;">
                <label class="form-label small"><strong>End Date:</strong></label>
                <input type="date" id="activityEndDate" class="form-control form-control-sm">
              </div>
              <div class="col-md-3">
                <label class="form-label small"><strong>Max Results:</strong></label>
                <select id="activityMaxResults" class="form-select form-select-sm">
                  <option value="50">50</option>
                  <option value="100" selected>100</option>
                  <option value="200">200</option>
                  <option value="500">500</option>
            </select>
          </div>
        </div>
            <div class="mt-2">
              <button class="btn btn-outline-primary btn-sm" onclick="loadSharedDriveActivity()">
                <i class="bi bi-search"></i> Load Activity
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="exportActivityReport()">
                <i class="bi bi-download"></i> Export Report
              </button>
        </div>
          </div>
        </div>

        <!-- Activity Summary -->
        <div class="row mb-2 g-2" id="activitySummaryCards" style="display:none;">
          <div class="col-md-3">
            <div class="card text-white bg-info">
              <div class="card-body text-center p-2">
                <h3 id="totalActivitiesCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Total Activities</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-success">
              <div class="card-body text-center p-2">
                <h3 id="uniqueUsersCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Unique Users</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-warning">
              <div class="card-body text-center p-2">
                <h3 id="uniqueFilesCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Files/Folders</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-primary">
              <div class="card-body text-center p-2">
                <h3 id="eventTypesCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Event Types</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Activity List -->
        <div class="card mb-2">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-list-ul"></i> Activity Log</h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadSharedDriveActivity()">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
          <div class="card-body p-2">
            <div id="activityLoading" class="text-center" style="display:none;">
              <i class="bi bi-hourglass-split"></i> Loading activity...
            </div>
            <div id="activityList" class="small">
              <div class="text-center text-muted">Select time range and click "Load Activity" to view Shared Drive activity</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feature Selector Tab -->
    <div class="tab-pane fade" id="featureSelectorTab">
      <?!= include('FeatureSelector_Embedded'); ?>
    </div>

    <!-- Code Analyzer Tab -->
    <div class="tab-pane fade" id="codeAnalyzerTab">
      <div class="container-fluid">
        <!-- Header -->
        <div class="card mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <div class="card-body text-center p-2">
            <h2 style="font-size: 1.5rem; margin-bottom: 0.25rem;"><i class="bi bi-bug"></i> Code Analyzer & Auto-Fix</h2>
            <p class="mb-0" style="font-size: 0.85em;">Analyze your codebase for errors, missing functions, and unused code. Auto-fix simple issues.</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="card mb-2">
          <div class="card-body p-2">
            <div class="d-flex gap-1 flex-wrap">
              <button class="btn btn-outline-primary" onclick="runCodeAnalysis()">
                <i class="bi bi-search"></i> Run Analysis
              </button>
              <button class="btn btn-outline-success" onclick="runAutoFix()" id="autoFixBtn" disabled>
                <i class="bi bi-tools"></i> Auto-Fix Issues
              </button>
              <button class="btn btn-outline-info" onclick="exportAnalysisReport()" id="exportReportBtn" disabled>
                <i class="bi bi-download"></i> Export Report
              </button>
            </div>
        </div>
      </div>

        <!-- Summary Cards -->
        <div class="row mb-2 g-2" id="summaryCards" style="display:none;">
          <div class="col-md-3">
            <div class="card text-white bg-danger">
              <div class="card-body text-center p-2">
                <h3 id="errorCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Errors</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-warning">
              <div class="card-body text-center p-2">
                <h3 id="warningCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Warnings</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-info">
              <div class="card-body text-center p-2">
                <h3 id="missingFunctionsCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Missing Functions</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-secondary">
              <div class="card-body text-center p-2">
                <h3 id="unusedFunctionsCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Unused Functions</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Analysis Results -->
        <div id="analysisResults" style="display:none;">
          <!-- Errors -->
          <div class="card mb-2" id="errorsCard" style="display:none;">
            <div class="card-header bg-danger text-white">
              <h5 class="mb-0" style="font-size: 1rem;"><i class="bi bi-x-circle"></i> Errors</h5>
            </div>
            <div class="card-body p-2">
              <div id="errorsList"></div>
            </div>
          </div>

          <!-- Warnings -->
          <div class="card mb-2" id="warningsCard" style="display:none;">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0" style="font-size: 1rem;"><i class="bi bi-exclamation-triangle"></i> Warnings</h5>
            </div>
            <div class="card-body p-2">
              <div id="warningsList"></div>
            </div>
          </div>

          <!-- Missing Functions -->
          <div class="card mb-2" id="missingFunctionsCard" style="display:none;">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0" style="font-size: 1rem;"><i class="bi bi-question-circle"></i> Missing Functions</h5>
            </div>
            <div class="card-body p-2">
              <div id="missingFunctionsList"></div>
            </div>
          </div>

          <!-- Unused Functions -->
          <div class="card mb-2" id="unusedFunctionsCard" style="display:none;">
            <div class="card-header bg-secondary text-white">
              <h5 class="mb-0" style="font-size: 1rem;"><i class="bi bi-trash"></i> Potentially Unused Functions</h5>
            </div>
            <div class="card-body p-2">
              <div id="unusedFunctionsList"></div>
            </div>
          </div>

          <!-- Suggestions -->
          <div class="card mb-2" id="suggestionsCard" style="display:none;">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0" style="font-size: 1rem;"><i class="bi bi-lightbulb"></i> Suggestions</h5>
            </div>
            <div class="card-body p-2">
              <div id="suggestionsList"></div>
            </div>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div id="analysisLoading" class="text-center" style="display:none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Analyzing...</span>
          </div>
          <p class="mt-2">Analyzing codebase... This may take a few seconds.</p>
        </div>
      </div>
    </div>

    <!-- Folder Scan Tab -->
    <div class="tab-pane fade" id="folderScanTab">
      <div class="container-fluid">
        <!-- Header -->
        <div class="card mb-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          <div class="card-body text-center p-2">
            <h2 style="font-size: 1.5rem; margin-bottom: 0.25rem;"><i class="bi bi-search"></i> Folder Limit Access Scanner</h2>
            <p class="mb-0" style="font-size: 0.85em;">Scan all folders in all projects to find folders with limit access enabled</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="card mb-2">
          <div class="card-body p-2">
            <div class="d-flex gap-1 flex-wrap">
              <button class="btn btn-outline-primary" onclick="scanFoldersForLimitAccess()">
                <i class="bi bi-search"></i> Scan All Folders
              </button>
              <button class="btn btn-outline-warning" onclick="compareFolderPermissions()">
                <i class="bi bi-arrow-left-right"></i> Compare with Template
              </button>
              <button class="btn btn-outline-secondary" onclick="exportScanResults()" id="exportScanBtn" disabled>
                <i class="bi bi-download"></i> Export Results
              </button>
            </div>
            <div class="alert alert-info mt-2 mb-0 py-1" style="font-size: 0.85em;">
              <i class="bi bi-info-circle"></i> <strong>Scan All Folders:</strong> Shows folders with limit access in Drive. <strong>Compare with Template:</strong> Compares Drive permissions with Folder Structure template settings (uses Snapshot for fast comparison).
            </div>
            
            <!-- Snapshot Management Section -->
            <div class="card mt-3 mb-2">
              <div class="card-header">
                <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-database"></i> Snapshot Management</h5>
              </div>
              <div class="card-body">
                <div class="alert alert-info mb-2 py-1" style="font-size: 0.85em;">
                  <i class="bi bi-info-circle"></i> <strong>Snapshot System:</strong> Snapshots are cached views of Drive state for fast comparison. They are updated automatically every 3 hours, or you can refresh them manually.
                </div>
                
                <!-- Snapshot Status Display -->
                <div id="snapshotStatus" class="mb-3">
                  <div class="d-flex gap-2 align-items-center mb-2">
                    <i class="bi bi-hourglass-split"></i>
                    <span class="small">Loading snapshot status...</span>
                  </div>
                </div>
                
                <!-- Snapshot Action Buttons -->
                <div class="d-flex gap-2 flex-wrap">
                  <button class="btn btn-outline-primary btn-sm" onclick="refreshFoldersSnapshot()" id="refreshFoldersSnapshotBtn">
                    <span class="btn-text"><i class="bi bi-arrow-clockwise"></i> Refresh Folders Snapshot</span>
                    <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Refreshing...</span>
                  </button>
                  <button class="btn btn-outline-primary btn-sm" onclick="refreshGroupsSnapshot()" id="refreshGroupsSnapshotBtn">
                    <span class="btn-text"><i class="bi bi-arrow-clockwise"></i> Refresh Groups Snapshot</span>
                    <span class="btn-loading" style="display:none;"><i class="bi bi-hourglass-split"></i> Refreshing...</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-2 g-2" id="scanSummaryCards" style="display:none;">
          <div class="col-md-4">
            <div class="card text-white bg-primary">
              <div class="card-body text-center p-2">
                <h3 id="totalFoldersCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Total Folders</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-danger">
              <div class="card-body text-center p-2">
                <h3 id="foldersWithLimitAccessCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Folders with Limit Access</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-white bg-success">
              <div class="card-body text-center p-2">
                <h3 id="foldersWithoutLimitAccessCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Folders without Limit Access</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Comparison Summary Cards -->
        <div class="row mb-2 g-2" id="comparisonSummaryCards" style="display:none;">
          <div class="col-md-3">
            <div class="card text-white bg-success">
              <div class="card-body text-center p-2">
                <h3 id="matchedCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Matched</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-danger">
              <div class="card-body text-center p-2">
                <h3 id="mismatchedCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Mismatched</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-warning">
              <div class="card-body text-center p-2">
                <h3 id="driveOnlyCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Drive Only</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-info">
              <div class="card-body text-center p-2">
                <h3 id="templateOnlyCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Template Only</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Table -->
        <div class="card mb-2">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0" style="font-size: 1.1rem;"><i class="bi bi-list-ul"></i> <span id="scanResultsTitle">Folders with Limit Access</span></h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="scanFoldersForLimitAccess()">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
          <div class="card-body p-2">
            <div id="scanLoading" class="text-center" style="display:none;">
              <i class="bi bi-hourglass-split"></i> Scanning folders... This may take a few minutes.
            </div>
            <div id="scanResults" class="small">
              <div class="text-center text-muted">Click "Scan All Folders" or "Compare with Template" to start</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Runner Tab -->
    <div class="tab-pane fade" id="testRunnerTab">
      <div class="container-fluid">
        <!-- Header -->
        <div class="card mb-2" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
          <div class="card-body text-center p-2">
            <h2 style="font-size: 1.5rem; margin-bottom: 0.25rem;"><i class="bi bi-play-circle"></i> Test Runner</h2>
            <p class="mb-0" style="font-size: 0.85em;">Run dynamic tests to verify that functions work correctly at runtime.</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="card mb-2">
          <div class="card-body p-2">
            <div class="d-flex gap-1 flex-wrap">
              <button class="btn btn-outline-primary" onclick="runAllTests()">
                <i class="bi bi-play-fill"></i> Run All Tests
              </button>
              <button class="btn btn-outline-success" onclick="runSelectedTests()" id="runSelectedBtn" disabled>
                <i class="bi bi-play"></i> Run Selected Tests
              </button>
              <button class="btn btn-outline-info" onclick="exportTestReport()" id="exportTestReportBtn" disabled>
                <i class="bi bi-download"></i> Export Report
              </button>
            </div>
          </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-2 g-2" id="testSummaryCards" style="display:none;">
          <div class="col-md-3">
            <div class="card text-white bg-success">
              <div class="card-body text-center p-2">
                <h3 id="testPassedCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Passed</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-danger">
              <div class="card-body text-center p-2">
                <h3 id="testFailedCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Failed</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-secondary">
              <div class="card-body text-center p-2">
                <h3 id="testSkippedCount" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0</h3>
                <p class="mb-0" style="font-size: 0.85em;">Skipped</p>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-white bg-info">
              <div class="card-body text-center p-2">
                <h3 id="testSuccessRate" style="font-size: 1.5rem; margin-bottom: 0.25rem;">0%</h3>
                <p class="mb-0" style="font-size: 0.85em;">Success Rate</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Test Results -->
        <div id="testResults" style="display:none;">
          <!-- Test List -->
          <div class="card mb-2">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0" style="font-size: 1rem;"><i class="bi bi-list-check"></i> Test Results</h5>
            </div>
            <div class="card-body p-2">
              <div id="testResultsList"></div>
            </div>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div id="testLoading" class="text-center" style="display:none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Running tests...</span>
          </div>
          <p class="mt-2">Running tests... This may take a few seconds.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header" style="background: var(--theme-primary); color: white; border-bottom: 3px solid var(--theme-accent);">
        <h5 class="modal-title"><i class="bi bi-info-circle-fill"></i> Result</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalMessage" style="white-space: pre-wrap;"></div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Theme Settings Modal -->
<div class="modal fade" id="themeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header" style="background: var(--theme-primary); color: white; border-bottom: 3px solid var(--theme-accent);">
        <h5 class="modal-title"><i class="bi bi-palette"></i> Theme Settings</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Preset Palettes -->
        <div class="mb-4">
          <label class="form-label fw-bold"><i class="bi bi-palette-fill"></i> Preset Color Palettes</label>
          <div class="row g-2">
            <div class="col-md-6">
              <button class="btn btn-outline-primary w-100" onclick="applyPalette('elephant')" style="text-align: left;">
                <div class="d-flex align-items-center">
                  <div class="me-2" style="width: 30px; height: 30px; background: linear-gradient(135deg, #163655 0%, #435c74 50%, #fcf7f4 100%); border-radius: 4px; border: 1px solid #ddd;"></div>
                  <div>
                    <strong>Elephant Palette</strong><br>
                    <small class="text-muted">Blue & Linen</small>
                  </div>
                </div>
              </button>
            </div>
            <div class="col-md-6">
              <button class="btn btn-outline-primary w-100" onclick="applyPalette('fire-bush')" style="text-align: left;">
                <div class="d-flex align-items-center">
                  <div class="me-2" style="width: 30px; height: 30px; background: linear-gradient(135deg, #e29536 0%, #636362 50%, #e4e0da 100%); border-radius: 4px; border: 1px solid #ddd;"></div>
                  <div>
                    <strong>Fire Bush Palette</strong><br>
                    <small class="text-muted">Warm & Earthy</small>
                  </div>
                </div>
              </button>
            </div>
          </div>
        </div>
        
        <hr>
        
        <!-- Custom Colors -->
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="bi bi-paint-bucket"></i> Primary Color (Headers & Buttons)</label>
          <input type="color" id="themePrimary" class="form-control form-control-color" value="#163655" title="Primary Color">
          <small class="text-muted">Used for headers and primary buttons</small>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="bi bi-paint-bucket"></i> Secondary Color (Buttons)</label>
          <input type="color" id="themeSecondary" class="form-control form-control-color" value="#435c74" title="Secondary Color">
          <small class="text-muted">Used for secondary buttons and accents</small>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="bi bi-paint-bucket"></i> Background Color</label>
          <input type="color" id="themeBackground" class="form-control form-control-color" value="#fcf7f4" title="Background Color">
          <small class="text-muted">Main background color</small>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold"><i class="bi bi-paint-bucket"></i> Accent Color</label>
          <input type="color" id="themeAccent" class="form-control form-control-color" value="#435c74" title="Accent Color">
          <small class="text-muted">Used for highlights and links</small>
        </div>
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> <strong>Tip:</strong> Changes will be applied immediately. Click "Reset to Default" to restore original colors.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" onclick="resetTheme()">
          <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
        </button>
        <button class="btn btn-outline-primary" onclick="applyTheme()">
          <i class="bi bi-check-circle"></i> Apply Theme
        </button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Add Folders Modal -->
<div class="modal fade" id="bulkAddModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-list-ul"></i> Bulk Add Folders</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> <strong>How to use:</strong>
          <ul class="mb-0 small">
            <li>Enter one folder name per line</li>
            <li>Empty lines will be ignored</li>
            <li>Folders will be added as children of the selected folder</li>
            <li>If no folder is selected, they will be added to the root level</li>
          </ul>
        </div>
        <label class="form-label"><strong>Folder Names (one per line):</strong></label>
        <textarea id="bulkFolderNames" class="form-control" rows="10" placeholder="Folder 1&#10;Folder 2&#10;Folder 3&#10;..."></textarea>
        <div class="mt-2">
          <label class="form-check-label">
            <input type="checkbox" id="bulkAddAsSiblings" class="form-check-input">
            Add as siblings (instead of children)
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-outline-primary" onclick="processBulkAdd()">Add Folders</button>
      </div>
    </div>
  </div>
</div>

<!-- Import from Drive Modal -->
<div class="modal fade" id="importDriveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-cloud-download"></i> Import Folder Structure from Drive</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> <strong>How to use:</strong>
          <ul class="mb-0 small">
            <li>Enter a Google Drive Folder ID</li>
            <li>The system will import the folder structure (folders only, not files)</li>
            <li>Folders will be added as children of the selected folder</li>
            <li>If no folder is selected, they will be added to the root level</li>
          </ul>
        </div>
        <label class="form-label"><strong>Google Drive Folder ID:</strong></label>
        <input type="text" id="importFolderId" class="form-control" placeholder="Enter folder ID (e.g., 1abc123def456)">
        <small class="text-muted">You can get the folder ID from the folder URL in Google Drive</small>
        <div class="mt-3">
          <label class="form-check-label">
            <input type="checkbox" id="importRecursive" class="form-check-input" checked>
            Import subfolders recursively (all levels)
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-outline-primary" onclick="processImportFromDrive()">Import</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-treeview/1.2.0/bootstrap-treeview.min.js"></script>
<script>
let isAdminUser=false, adminTreeData=[], adminSelectedPath=[], adminTreeWidget=null, accessPolicy=null;

// Theme Management Functions
function showThemeModal() {
  // Load current theme from storage
  google.script.run
    .withSuccessHandler(function(theme) {
      if (theme) {
        document.getElementById('themePrimary').value = theme.primary || '#163655';
        document.getElementById('themeSecondary').value = theme.secondary || '#435c74';
        document.getElementById('themeBackground').value = theme.background || '#fcf7f4';
        document.getElementById('themeAccent').value = theme.accent || '#435c74';
      }
      // Show modal
      const themeModal = new bootstrap.Modal(document.getElementById('themeModal'));
      themeModal.show();
    })
    .withFailureHandler(function(error) {
      console.error('Error loading theme:', error);
      // Show modal anyway with defaults
      const themeModal = new bootstrap.Modal(document.getElementById('themeModal'));
      themeModal.show();
    })
    .getThemeSettings();
}

function applyTheme() {
  const theme = {
    primary: document.getElementById('themePrimary').value,
    secondary: document.getElementById('themeSecondary').value,
    background: document.getElementById('themeBackground').value,
    accent: document.getElementById('themeAccent').value
  };
  
  // Apply theme immediately
  document.documentElement.style.setProperty('--theme-primary', theme.primary);
  document.documentElement.style.setProperty('--theme-secondary', theme.secondary);
  document.documentElement.style.setProperty('--theme-background', theme.background);
  document.documentElement.style.setProperty('--theme-accent', theme.accent);
  
  // Save theme
  google.script.run
    .withSuccessHandler(function() {
      showModal('Theme applied successfully!');
      bootstrap.Modal.getInstance(document.getElementById('themeModal')).hide();
    })
    .withFailureHandler(function(error) {
      showModal('Error saving theme: ' + error.message);
    })
    .saveThemeSettings(theme);
}

function resetTheme() {
  const defaultTheme = {
    primary: '#163655',
    secondary: '#435c74',
    background: '#fcf7f4',
    accent: '#435c74'
  };
  
  // Set input values
  document.getElementById('themePrimary').value = defaultTheme.primary;
  document.getElementById('themeSecondary').value = defaultTheme.secondary;
  document.getElementById('themeBackground').value = defaultTheme.background;
  document.getElementById('themeAccent').value = defaultTheme.accent;
  
  // Apply theme immediately
  document.documentElement.style.setProperty('--theme-primary', defaultTheme.primary);
  document.documentElement.style.setProperty('--theme-secondary', defaultTheme.secondary);
  document.documentElement.style.setProperty('--theme-background', defaultTheme.background);
  document.documentElement.style.setProperty('--theme-accent', defaultTheme.accent);
  
  // Save theme
  google.script.run
    .withSuccessHandler(function() {
      showModal('Theme reset to default!');
    })
    .withFailureHandler(function(error) {
      showModal('Error resetting theme: ' + error.message);
    })
    .saveThemeSettings(defaultTheme);
}

// Apply preset palette
function applyPalette(paletteName) {
  let theme;
  
  if (paletteName === 'elephant') {
    // Elephant Palette (Blue & Linen)
    theme = {
      primary: '#163655',      // elephant
      secondary: '#435c74',    // blue-bayoux
      background: '#fcf7f4',   // white-linen
      accent: '#435c74'        // blue-bayoux
    };
  } else if (paletteName === 'fire-bush') {
    // Fire Bush Palette (Warm & Earthy)
    theme = {
      primary: '#636362',      // storm-dust (dark gray for headers)
      secondary: '#e29536',    // fire-bush (orange for buttons)
      background: '#e4e0da',   // westar (light beige)
      accent: '#e29536'        // fire-bush (orange for accents)
    };
  } else {
    // Default to elephant palette
    theme = {
      primary: '#163655',
      secondary: '#435c74',
      background: '#fcf7f4',
      accent: '#435c74'
    };
  }
  
  // Set input values
  document.getElementById('themePrimary').value = theme.primary;
  document.getElementById('themeSecondary').value = theme.secondary;
  document.getElementById('themeBackground').value = theme.background;
  document.getElementById('themeAccent').value = theme.accent;
  
  // Apply theme immediately
  document.documentElement.style.setProperty('--theme-primary', theme.primary);
  document.documentElement.style.setProperty('--theme-secondary', theme.secondary);
  document.documentElement.style.setProperty('--theme-background', theme.background);
  document.documentElement.style.setProperty('--theme-accent', theme.accent);
  
  // Save theme
  google.script.run
    .withSuccessHandler(function() {
      showModal('Palette applied successfully!');
    })
    .withFailureHandler(function(error) {
      showModal('Error applying palette: ' + error.message);
    })
    .saveThemeSettings(theme);
}

function showModal(msg){
  document.getElementById('modalMessage').innerText = msg;
  new bootstrap.Modal(document.getElementById('resultModal')).show();
}

function setButtonLoading(buttonId, isLoading) {
  const btn = document.getElementById(buttonId);
  if (!btn) return;
  
  const textSpan = btn.querySelector('.btn-text');
  const loadingSpan = btn.querySelector('.btn-loading');
  
  if (isLoading) {
    btn.disabled = true;
    if (textSpan) textSpan.style.display = 'none';
    if (loadingSpan) loadingSpan.style.display = 'inline';
  } else {
    btn.disabled = false;
    if (textSpan) textSpan.style.display = 'inline';
    if (loadingSpan) loadingSpan.style.display = 'none';
  }
}

function togglePhase(){
  const phase = document.getElementById('phase').value;
  if(phase === "bidding"){
    document.getElementById('biddingSection').style.display = "block";
    document.getElementById('deliverySection').style.display = "none";
  } else {
    document.getElementById('biddingSection').style.display = "none";
    document.getElementById('deliverySection').style.display = "block";
    google.script.run.withSuccessHandler(function(projects){
      const select = document.getElementById('existingProjects');
      select.innerHTML = "";
      if(!projects.length){
        const opt = document.createElement('option'); 
        opt.text = "No projects available"; 
        opt.value = "";
        select.add(opt); 
        return;
      }
      projects.forEach(p=>{ 
        const opt = document.createElement('option'); 
        opt.text = p; 
        opt.value = p; 
        select.add(opt); 
      });
    }).getProjectsWithoutPD();
  }
}

function sendApproval(){
  const phase = document.getElementById('phase').value;
  let name = "";
  if(phase === "bidding"){
    name = document.getElementById('projectName').value.trim();
    if(!name){ showModal("Please enter project name"); return; }
  } else {
    name = document.getElementById('existingProjects').value;
    if(!name){ showModal("Please select a project"); return; }
  }
  setButtonLoading('sendApprovalBtn', true);
  google.script.run
    .withSuccessHandler(function(msg){
      setButtonLoading('sendApprovalBtn', false);
      showModal(msg);
    })
    .withFailureHandler(function(e){
      setButtonLoading('sendApprovalBtn', false);
      showModal("Error: " + e.message);
    })
    .requestApproval(name, phase);
}

// Auth + initial loads
google.script.run
  .withSuccessHandler(function(info){
  isAdminUser = info && info.isAdmin;
    try { document.getElementById('meEmail').textContent = (info && (info.userEmail || info.user)) || ''; } catch(e) {}
    try { document.getElementById('revisionNumber').textContent = (info && info.revision) || 'N/A'; } catch(e) {}
    
    // Apply theme if available
    if (info && info.theme) {
      document.documentElement.style.setProperty('--theme-primary', info.theme.primary || '#163655');
      document.documentElement.style.setProperty('--theme-secondary', info.theme.secondary || '#435c74');
      document.documentElement.style.setProperty('--theme-background', info.theme.background || '#fcf7f4');
      document.documentElement.style.setProperty('--theme-accent', info.theme.accent || '#435c74');
    }
    
    // Always show tabs (assume admin)
    showAllTabs();
    loadAdminTree(); 
    loadAccessPolicy();
    // Load snapshot status when Folder Scan tab is available
    if (document.getElementById('snapshotStatus')) {
      loadSnapshotStatus();
    }
    // Don't load groups/users immediately - load them lazily when needed
    // populateFolderGroupSelect(); // Load groups for folder permissions - moved to lazy loading
  })
  .withFailureHandler(function(error){
    console.error('Error getting auth info:', error);
    // Show tabs anyway if auth fails
    showAllTabs();
    loadAdminTree(); 
    loadAccessPolicy(); 
    // Don't load groups/users immediately - load them lazily when needed
    // populateFolderGroupSelect();
  })
  .getAuthInfo();

// Function to show all tabs
function showAllTabs() {
  try {
    const tabs = [
      'adminTabBtn', 'groupsTabBtn', 'fileRestrictionsTabBtn', 
      'featureSelectorTabBtn', 'codeAnalyzerTabBtn', 
      'testRunnerTabBtn', 'activityMonitorTabBtn'
    ];
    tabs.forEach(tabId => {
      const tab = document.getElementById(tabId);
      if (tab) {
        tab.style.display = 'block';
      }
    });
  } catch(e) {
    console.error('Error showing tabs:', e);
  }
}

// Show tabs immediately when page loads (fallback)
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(showAllTabs, 100);
  });
} else {
  setTimeout(showAllTabs, 100);
}

/*************** Admin Tree ***************/
function loadAdminTree(){ 
  console.log('loadAdminTree called');
  // Load template with syncing from Drive to show actual state
  // This ensures the UI displays the actual limit access status from Drive
  google.script.run
    .withSuccessHandler(function(serverTree){ 
      console.log('Template loaded successfully:', serverTree);
      if (!serverTree) {
        console.warn('Template is null or undefined');
        const tbody = document.getElementById('treeTableBody');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-warning">No folder structure found. Please create one.</td></tr>';
        }
        return;
      }
      adminTreeData = serverTree; 
      renderAdminTree();
      // Load backup info (fast - reads from PropertiesService)
      loadBackupInfo();
      // Don't load users/groups immediately - load them lazily when user opens folder settings
      // loadUsersForAutocomplete(); // Moved to lazy loading
    })
    .withFailureHandler(function(error){
      console.error('Error loading admin tree:', error);
      const tbody = document.getElementById('treeTableBody');
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading folder structure: ' + (error.message || error) + '</td></tr>';
      }
    })
    .getTemplateTree(true); // Sync from Drive to show actual state
}

/* Load users for autocomplete - lazy loading */
let allUsersList = [];
let usersLoaded = false;
function loadUsersForAutocomplete() {
  if (usersLoaded) return; // Already loaded
  usersLoaded = true;
  
  google.script.run
    .withSuccessHandler(function(users) {
      allUsersList = users || [];
      setupUserAutocomplete();
    })
    .withFailureHandler(function(err) {
      console.error('Error loading users:', err);
      allUsersList = [];
      usersLoaded = false; // Reset on error so we can retry
    })
    .getAllDomainUsers();
}

/* Setup user autocomplete */
function setupUserAutocomplete() {
  const userInput = document.getElementById('userEmailInput');
  if (!userInput) return;
  
  userInput.addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase().trim();
    const datalist = document.getElementById('userSuggestions');
    if (!datalist) return;
    
    // Clear previous options
    datalist.innerHTML = '';
    
    if (query.length < 2) {
      return; // Don't show suggestions for less than 2 characters
    }
    
    // Filter users based on query
    const matches = allUsersList.filter(user => {
      const email = (user.email || '').toLowerCase();
      const name = (user.name || '').toLowerCase();
      return email.includes(query) || name.includes(query);
    }).slice(0, 20); // Limit to 20 suggestions
    
    // Add options to datalist
    matches.forEach(user => {
      const option = document.createElement('option');
      option.value = user.email || '';
      option.textContent = `${user.name || ''} (${user.email || ''})`;
      datalist.appendChild(option);
    });
  });
}

/* Load backup information */
function loadBackupInfo() {
  google.script.run.withSuccessHandler(function(backup) {
    const backupInfo = document.getElementById('backupInfo');
    const backupTimestamp = document.getElementById('backupTimestamp');
    
    if (backup && backup.timestamp) {
      const date = new Date(backup.timestamp);
      backupTimestamp.textContent = date.toLocaleString();
      backupInfo.style.display = 'block';
    } else {
      backupInfo.style.display = 'none';
    }
  }).withFailureHandler(function(err) {
    console.error('Error loading backup info:', err);
  }).getTemplateBackup();
}

/* Save template backup */
function saveTemplateBackupUI() {
  const btn = document.getElementById('saveBackupBtn');
  const btnText = btn.querySelector('.btn-text');
  const btnLoading = btn.querySelector('.btn-loading');
  
  btn.disabled = true;
  btnText.style.display = 'none';
  btnLoading.style.display = 'inline';
  
  google.script.run
    .withSuccessHandler(function(result) {
      btn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      
      showModal(`âœ… Backup saved successfully!\n\nSaved at: ${new Date(result.timestamp).toLocaleString()}`);
      loadBackupInfo();
    })
    .withFailureHandler(function(err) {
      btn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      showModal('âŒ Error saving backup: ' + err.message);
    })
    .saveTemplateBackup();
}

/* Restore template from backup */
function restoreTemplateBackupUI() {
  if (!confirm('âš ï¸ Are you sure you want to restore from backup?\n\nThis will replace the current tree structure with the backup version.')) {
    return;
  }
  
  const btn = document.getElementById('restoreBackupBtn');
  const btnText = btn.querySelector('.btn-text');
  const btnLoading = btn.querySelector('.btn-loading');
  
  btn.disabled = true;
  btnText.style.display = 'none';
  btnLoading.style.display = 'inline';
  
  google.script.run
    .withSuccessHandler(function(result) {
      btn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      
      showModal(`âœ… Template restored successfully!\n\nRestored from backup saved at: ${new Date(result.timestamp).toLocaleString()}\n\nPlease refresh the page to see the changes.`);
      
      // Reload the tree after a short delay
      setTimeout(function() {
        loadAdminTree();
      }, 1000);
    })
    .withFailureHandler(function(err) {
      btn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
      showModal('âŒ Error restoring backup: ' + err.message);
    })
    .restoreTemplateFromBackup();
}

function buildAdminNodes(nodes, path=[]){
  return nodes.map((n, idx)=>{ 
    const p=[...path, idx];
    // Build node text with permission indicators
    let nodeText = n.text;
    if (n.limitedAccess) {
      nodeText += ' <span class="tree-node-badge bg-danger text-white" title="Protection enabled"><i class="bi bi-shield-lock-fill"></i></span>';
    }
    if (n.groups && n.groups.length > 0) {
      // Support both old format (string array) and new format (object array)
      const groupNames = n.groups.map(g => typeof g === 'string' ? g : (g.name || g));
      nodeText += ` <span class="tree-node-groups" title="Groups: ${groupNames.join(', ')}"><i class="bi bi-people-fill"></i> ${n.groups.length}</span>`;
    }
    
    const o = { 
      text: nodeText, 
      _path: p,
      html: true // Enable HTML in node text
    }; 
    if(n.nodes) o.nodes=buildAdminNodes(n.nodes,p); 
    return o; 
  });
}

function renderAdminTree(){
  console.log('renderAdminTree called, adminTreeData:', adminTreeData);
  // Render custom tree table
  renderTreeTable();
  
  // Also render old tree for compatibility (hidden)
  try {
  const nodes = buildAdminNodes(adminTreeData);
  // Check if treeview is initialized before trying to remove
  if ($('#adminTree').data('treeview')) {
    $('#adminTree').treeview('remove');
  }
  adminTreeWidget = $('#adminTree').treeview({
    data: nodes,
    levels: 8,
    expandIcon: 'bi bi-plus-square',
    collapseIcon: 'bi bi-dash-square',
    emptyIcon: 'bi bi-square',
    nodeIcon: 'bi bi-folder2',
      onNodeSelected: function(event, node){ 
        adminSelectedPath = node._path; 
        renderGroupList(); 
      }
    });
  } catch (e) {
    console.error('Error rendering old tree:', e);
  }
}

/* Render custom tree table */
function renderTreeTable() {
  console.log('renderTreeTable called');
  const tbody = document.getElementById('treeTableBody');
  if (!tbody) {
    console.error('treeTableBody element not found!');
    return;
  }
  // Save current selection before clearing
  const currentSelection = adminSelectedPath ? JSON.stringify(adminSelectedPath) : null;
  tbody.innerHTML = '';
  
  if (!adminTreeData || adminTreeData.length === 0) {
    console.warn('adminTreeData is empty');
    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No folders</td></tr>';
    return;
  }
  
  console.log('Rendering tree with', adminTreeData.length, 'root nodes');
  // Render nodes recursively
  adminTreeData.forEach((node, index) => {
    renderTreeTableRow(node, [index], 0, tbody);
  });
  
  // Restore selection highlight after rendering
  if (currentSelection) {
    setTimeout(function() {
      highlightSelectedRow(currentSelection);
    }, 50);
  }
}

/* Highlight selected row */
function highlightSelectedRow(pathStr) {
  // Remove previous selection
  document.querySelectorAll('tr[data-path]').forEach(function(row) {
    row.classList.remove('selected');
  });
  
  // Add selection to current row
  const selectedRow = document.querySelector(`tr[data-path='${pathStr}']`);
  if (selectedRow) {
    selectedRow.classList.add('selected');
    // Scroll into view if needed
    selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

/* Render a single tree table row */
function renderTreeTableRow(node, path, depth, tbody) {
  const tr = document.createElement('tr');
  tr.setAttribute('data-path', JSON.stringify(path));
  tr.setAttribute('data-depth', depth);
  
  // Indentation
  const indent = '<span class="tree-node-indent"></span>'.repeat(depth);
  
  // Folder name with expand/collapse
  const hasChildren = node.nodes && node.nodes.length > 0;
  const isExpanded = node._expanded === true; // Default to collapsed
  const expandIcon = hasChildren ? 
    `<i class="bi ${isExpanded ? 'bi-chevron-down' : 'bi-chevron-right'} text-muted me-1" style="cursor: pointer;"></i>` : 
    '<span style="width: 16px; display: inline-block;"></span>';
  
  const nameCell = `
    <td>
      ${indent}
      ${expandIcon}
      <span class="tree-node-name" onclick="selectNodeFromTable('${JSON.stringify(path)}')" style="cursor: pointer;">
        <i class="bi bi-folder2 me-1"></i>
        ${node.text}
      </span>
    </td>
  `;
  
  // Add click handler for expand icon
  if (hasChildren) {
    tr.setAttribute('data-has-children', 'true');
  }
  
  // Protection status
  const isProtected = !!(node.limitedAccess);
  const protectionCell = `
    <td class="text-center">
      <i class="bi ${isProtected ? 'bi-shield-lock-fill tree-status-icon active' : 'bi-shield tree-status-icon inactive'}" 
         onclick="toggleNodeProtectionFromTable('${JSON.stringify(path)}')"
         title="${isProtected ? 'Protection enabled - Click to disable' : 'Protection disabled - Click to enable'}">
      </i>
    </td>
  `;
  
  // Groups count
  const groupsCount = (node.groups && node.groups.length) || 0;
  const usersCount = (node.users && node.users.length) || 0;
  const totalCount = groupsCount + usersCount;
  const groupsCell = `
    <td class="text-center">
      ${totalCount > 0 ? 
        `<span class="tree-groups-count" onclick="manageNodeGroups('${JSON.stringify(path)}')" title="Groups: ${groupsCount}, Users: ${usersCount}">
          <i class="bi bi-people-fill"></i> ${totalCount}
        </span>` : 
        '<span class="text-muted">-</span>'
      }
    </td>
  `;
  
  // Actions
  const actionsCell = `
    <td class="text-center">
      <button class="btn btn-sm btn-success tree-action-btn" onclick="addChildNodeFromTable('${JSON.stringify(path)}')" title="Add Child Folder">
        <i class="bi bi-plus-circle"></i>
      </button>
      <button class="btn btn-sm btn-outline-warning tree-action-btn" onclick="renameNodeFromTable('${JSON.stringify(path)}')" title="Rename">
        <i class="bi bi-pencil"></i>
      </button>
      <button class="btn btn-sm btn-outline-info tree-action-btn" onclick="selectNodeFromTable('${JSON.stringify(path)}')" title="Manage Permissions">
        <i class="bi bi-gear"></i>
      </button>
      <button class="btn btn-sm btn-danger tree-action-btn" onclick="deleteNodeFromTable('${JSON.stringify(path)}')" title="Delete">
        <i class="bi bi-trash"></i>
      </button>
    </td>
  `;
  
  tr.innerHTML = nameCell + protectionCell + groupsCell + actionsCell;
  tbody.appendChild(tr);
  
  // Add click handler for expand icon after rendering
  if (hasChildren) {
    setTimeout(function() {
      const expandIconEl = tr.querySelector('.bi-chevron-down, .bi-chevron-right');
      if (expandIconEl) {
        expandIconEl.addEventListener('click', function(e) {
          e.stopPropagation();
          toggleTreeNode(JSON.stringify(path));
        });
      }
    }, 0);
  }
  
  // Render children if expanded (we'll track expanded state)
  if (hasChildren && isExpanded) {
    node.nodes.forEach((child, idx) => {
      renderTreeTableRow(child, [...path, idx], depth + 1, tbody);
    });
  }
}

/* Toggle tree node expand/collapse */
function toggleTreeNode(pathStr) {
  const path = JSON.parse(pathStr);
  const node = getNodeByPath(path);
  if (!node) return;
  
  // Toggle expanded state
  if (node._expanded === undefined) {
    node._expanded = false; // Collapse if was default expanded
  } else {
    node._expanded = !node._expanded;
  }
  
  // Re-render table (will restore selection automatically)
  renderTreeTable();
}

/* Toggle protection from table */
function toggleNodeProtectionFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  const node = getNodeByPath(path);
  if (!node) return;
  
  node.limitedAccess = !node.limitedAccess;
  
  google.script.run
    .withSuccessHandler(function(msg) {
      renderTreeTable();
      if (adminSelectedPath && JSON.stringify(adminSelectedPath) === pathStr) {
        renderGroupList();
      }
    })
    .withFailureHandler(function(e) {
      showModal("Error: " + (e && e.message ? e.message : e));
      node.limitedAccess = !node.limitedAccess;
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

/* Manage groups from table */
function manageNodeGroups(pathStr) {
  const path = JSON.parse(pathStr);
  selectNodeFromTable(pathStr);
}

/* Select node from table */
function selectNodeFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  adminSelectedPath = path;
  
  // Show settings card first
  document.getElementById('folderSettingsCard').style.display = 'block';
  
  // Load groups and users lazily when folder settings card is shown (only if not already loaded)
  populateFolderGroupSelect(); // Load groups if not already loaded
  loadUsersForAutocomplete(); // Load users if not already loaded
  
  renderGroupList();
  
  // Highlight selected row
  highlightSelectedRow(pathStr);
}

/* Add child node from table */
function addChildNodeFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  adminSelectedPath = path;
  addChildNode();
}

/* Rename node from table */
function renameNodeFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  adminSelectedPath = path;
  renameNode();
}

/* Delete node from table */
function deleteNodeFromTable(pathStr) {
  const path = JSON.parse(pathStr);
  adminSelectedPath = path;
  deleteNode();
}

function showBulkAddModal(){
  const modal = new bootstrap.Modal(document.getElementById('bulkAddModal'));
  document.getElementById('bulkFolderNames').value = '';
  document.getElementById('bulkAddAsSiblings').checked = false;
  modal.show();
}

function processBulkAdd(){
  const folderNamesText = document.getElementById('bulkFolderNames').value.trim();
  if(!folderNamesText){
    showModal('Please enter at least one folder name');
    return;
  }
  
  const folderNames = folderNamesText.split('\n')
    .map(name => name.trim())
    .filter(name => name.length > 0);
  
  if(folderNames.length === 0){
    showModal('Please enter at least one valid folder name');
    return;
  }
  
  const addAsSiblings = document.getElementById('bulkAddAsSiblings').checked;
  const targetPath = addAsSiblings ? (adminSelectedPath.length ? adminSelectedPath.slice(0, -1) : []) : adminSelectedPath;
  
  if(!addAsSiblings && !adminSelectedPath.length){
    showModal('Please select a folder first to add children, or check "Add as siblings" to add at root level');
    return;
  }
  
  const folderType = (targetPath && targetPath.length && targetPath[0] === 0) ? 'RFP' : 'PD';
  
  bootstrap.Modal.getInstance(document.getElementById('bulkAddModal')).hide();
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree();
    })
    .withFailureHandler(function(err){
      showModal("Error: " + err.message);
    })
    .bulkAddFoldersToTemplate(targetPath, folderNames, folderType, addAsSiblings);
}

function showImportFromDriveModal(){
  const modal = new bootstrap.Modal(document.getElementById('importDriveModal'));
  document.getElementById('importFolderId').value = '';
  document.getElementById('importRecursive').checked = true;
  modal.show();
}

function processImportFromDrive(){
  const folderId = document.getElementById('importFolderId').value.trim();
  if(!folderId){
    showModal('Please enter a folder ID');
    return;
  }
  
  const importRecursive = document.getElementById('importRecursive').checked;
  const targetPath = adminSelectedPath.length ? adminSelectedPath : [];
  const folderType = (targetPath && targetPath.length && targetPath[0] === 0) ? 'RFP' : 'PD';
  
  bootstrap.Modal.getInstance(document.getElementById('importDriveModal')).hide();
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree();
    })
    .withFailureHandler(function(err){
      showModal("Error: " + err.message);
    })
    .importFolderStructureFromDrive(folderId, targetPath, folderType, importRecursive);
}

function getNodeByPath(path){
  let cur = adminTreeData;
  for (let i=0;i<path.length;i++){ 
    cur = cur[path[i]]; 
    if (!cur) return null; 
    if (i < path.length-1) cur = cur.nodes; 
  }
  return cur || null;
}

/* Get current tree state (expanded nodes, selected node, etc.) */
function getTreeState() {
  const state = {
    selectedPath: adminSelectedPath ? [...adminSelectedPath] : null,
    selectedNode: adminSelectedPath ? getNodeByPath(adminSelectedPath) : null,
    expandedPaths: [],
    totalNodes: 0,
    protectedNodes: 0,
    nodesWithGroups: 0,
    treeStructure: null
  };
  
  // Recursively collect expanded nodes and statistics
  function traverseNodes(nodes, currentPath = []) {
    if (!nodes || !Array.isArray(nodes)) return;
    
    nodes.forEach((node, index) => {
      const nodePath = [...currentPath, index];
      state.totalNodes++;
      
      // Check if node is expanded
      if (node._expanded === true) {
        state.expandedPaths.push([...nodePath]);
      }
      
      // Count protected nodes
      if (node.limitedAccess) {
        state.protectedNodes++;
      }
      
      // Count nodes with groups
      if (node.groups && node.groups.length > 0) {
        state.nodesWithGroups++;
      }
      
      // Recursively process children
      if (node.nodes && node.nodes.length > 0) {
        traverseNodes(node.nodes, nodePath);
      }
    });
  }
  
  traverseNodes(adminTreeData);
  
  // Get selected node info
  if (state.selectedNode) {
    state.selectedNodeInfo = {
      text: state.selectedNode.text,
      path: state.selectedPath,
      hasChildren: !!(state.selectedNode.nodes && state.selectedNode.nodes.length > 0),
      isProtected: !!state.selectedNode.limitedAccess,
      groupsCount: state.selectedNode.groups ? state.selectedNode.groups.length : 0,
      groups: state.selectedNode.groups || []
    };
  }
  
  return state;
}

/* Display tree state in console or alert */
function showTreeState() {
  const state = getTreeState();
  let info = 'Tree State:\n';
  info += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  info += 'Total Nodes: ' + state.totalNodes + '\n';
  info += 'Protected Nodes: ' + state.protectedNodes + '\n';
  info += 'Nodes with Groups: ' + state.nodesWithGroups + '\n';
  info += 'Expanded Nodes: ' + state.expandedPaths.length + '\n';
  info += 'Selected Node: ' + (state.selectedNodeInfo ? state.selectedNodeInfo.text : 'None') + '\n';
  info += 'Selected Path: ' + (state.selectedPath ? JSON.stringify(state.selectedPath) : 'None') + '\n';
  info += '\n';
  info += 'Expanded Paths:\n';
  info += (state.expandedPaths.length > 0 ? state.expandedPaths.map(p => '  - ' + JSON.stringify(p)).join('\n') : '  (none)') + '\n';
  info += '\n';
  info += 'Selected Node Details:\n';
  info += (state.selectedNodeInfo ? JSON.stringify(state.selectedNodeInfo, null, 2) : '  (none)') + '\n';
  info += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  
  console.log(info);
  return state;
}

/* Display tree state in UI */
function showTreeStateInUI() {
  const state = getTreeState();
  const card = document.getElementById('treeStateCard');
  const content = document.getElementById('treeStateContent');
  
  // Build HTML content
  let html = '<div class="row g-2 mb-3">' +
      '<div class="col-md-4">' +
        '<div class="card border-primary">' +
          '<div class="card-body p-2 text-center">' +
            '<h6 class="mb-0 text-primary"><i class="bi bi-folder"></i> Total Nodes</h6>' +
            '<h4 class="mb-0 mt-1">' + state.totalNodes + '</h4>' +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div class="col-md-4">' +
        '<div class="card border-danger">' +
          '<div class="card-body p-2 text-center">' +
            '<h6 class="mb-0 text-danger"><i class="bi bi-shield-lock"></i> Protected</h6>' +
            '<h4 class="mb-0 mt-1">' + state.protectedNodes + '</h4>' +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div class="col-md-4">' +
        '<div class="card border-info">' +
          '<div class="card-body p-2 text-center">' +
            '<h6 class="mb-0 text-info"><i class="bi bi-people"></i> With Groups</h6>' +
            '<h4 class="mb-0 mt-1">' + state.nodesWithGroups + '</h4>' +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>' +
    '<div class="mb-3">' +
      '<h6><i class="bi bi-chevron-down"></i> Expanded Nodes: <span class="badge bg-info">' + state.expandedPaths.length + '</span></h6>' +
      '<div class="bg-light p-2 rounded" style="max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.85em;">';
  
  if (state.expandedPaths.length > 0) {
    html += state.expandedPaths.map(p => {
      const node = getNodeByPath(p);
      const nodeText = node ? node.text : 'Unknown';
      return '<div><i class="bi bi-folder2 text-primary"></i> ' + nodeText + ' <span class="text-muted">[' + JSON.stringify(p) + ']</span></div>';
    }).join('');
  } else {
    html += '<div class="text-muted">No expanded nodes</div>';
  }
  
  html += '</div></div>' +
    '<div class="mb-3">' +
      '<h6><i class="bi bi-cursor"></i> Selected Node</h6>' +
      '<div class="bg-light p-2 rounded">';
  
  if (state.selectedNodeInfo) {
    const groupsList = state.selectedNodeInfo.groups.length > 0 ? 
      '(' + state.selectedNodeInfo.groups.map(g => typeof g === 'string' ? g : (g.name || g)).join(', ') + ')' : '';
    html += '<div><strong>Name:</strong> ' + state.selectedNodeInfo.text + '</div>' +
      '<div><strong>Path:</strong> <code>' + JSON.stringify(state.selectedNodeInfo.path) + '</code></div>' +
      '<div><strong>Has Children:</strong> ' + (state.selectedNodeInfo.hasChildren ? 'Yes' : 'No') + '</div>' +
      '<div><strong>Protected:</strong> ' + (state.selectedNodeInfo.isProtected ? '<span class="text-danger">Yes</span>' : '<span class="text-muted">No</span>') + '</div>' +
      '<div><strong>Groups:</strong> ' + state.selectedNodeInfo.groupsCount + ' ' + groupsList + '</div>';
  } else {
    html += '<div class="text-muted">No node selected</div>';
  }
  
  html += '</div></div>' +
    '<div class="mb-2">' +
      '<h6><i class="bi bi-diagram-3"></i> Tree Structure Preview</h6>' +
      '<div class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85em;">' +
        renderTreeStructurePreview(adminTreeData, 0) +
      '</div>' +
    '</div>';
  
  content.innerHTML = html;
  card.style.display = 'block';
  
  // Scroll to the card
  card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

/* Render tree structure as text preview */
function renderTreeStructurePreview(nodes, depth = 0) {
  if (!nodes || !Array.isArray(nodes)) return '';
  
  let html = '';
  const indent = '  '.repeat(depth);
  const prefix = depth > 0 ? 'â”œâ”€ ' : '';
  
  nodes.forEach((node, index) => {
    const isLast = index === nodes.length - 1;
    const connector = isLast ? 'â””â”€ ' : 'â”œâ”€ ';
    const icon = node.limitedAccess ? '<i class="bi bi-shield-lock-fill text-danger"></i>' : '<i class="bi bi-folder2 text-primary"></i>';
    const groupsBadge = node.groups && node.groups.length > 0 ? ' <span class="badge bg-info">' + node.groups.length + '</span>' : '';
    const expandedBadge = node._expanded === true ? ' <span class="badge bg-success">expanded</span>' : '';
    
    html += '<div style="margin-left: ' + (depth * 20) + 'px;">' + icon + ' ' + node.text + groupsBadge + expandedBadge + '</div>';
    
    if (node.nodes && node.nodes.length > 0) {
      html += renderTreeStructurePreview(node.nodes, depth + 1);
    }
  });
  
  return html;
}

function addChildNode(){ 
  const node=getNodeByPath(adminSelectedPath); 
  if(!node){
    showModal("Please select a folder first");
    return;
  } 
  const folderName = prompt("Enter new folder name:");
  if(!folderName) return;
  
  node.nodes=node.nodes||[]; 
  node.nodes.push({text:folderName,nodes:[]}); 
  
  const folderType = (adminSelectedPath && adminSelectedPath.length && adminSelectedPath[0] === 0) ? 'RFP' : 'PD';
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree(); // Reload to refresh table
    })
    .withFailureHandler(function(err){
      showModal("Error: " + err.message);
    })
    .addFolderToTemplateFromUI(adminSelectedPath, folderName, folderType);
}

function addSiblingNode(){
  if (!adminSelectedPath.length){ 
    showModal("Please select a folder first"); 
    return; 
  }
  const folderName = prompt("Enter new folder name:");
  if(!folderName) return;
  
  let parent = adminTreeData;
  for (let i=0;i<adminSelectedPath.length-1;i++){ 
    parent = parent[adminSelectedPath[i]].nodes; 
  }
  parent.splice(adminSelectedPath[adminSelectedPath.length-1]+1,0,{text:folderName,nodes:[]}); 
  
  const folderType = (adminSelectedPath && adminSelectedPath.length && adminSelectedPath[0] === 0) ? 'RFP' : 'PD';
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree(); // Reload to refresh table
    })
    .withFailureHandler(function(err){
      showModal("Error: " + err.message);
    })
    .addFolderToTemplateFromUI(adminSelectedPath.slice(0, -1), folderName, folderType);
}

function renameNode(){ 
  const node=getNodeByPath(adminSelectedPath); 
  if(!node){
    showModal("Please select a folder first");
    return;
  } 
  const nv=prompt("New name:",node.text); 
  if(!nv)return; 
  
  const oldName = node.text;
  node.text=nv; 
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree(); // Reload to refresh table
    })
    .withFailureHandler(function(err){
      showModal("Error: " + err.message);
      node.text = oldName;
      loadAdminTree();
    })
    .renameFolderInTemplateFromUI(adminSelectedPath, nv);
}

function deleteNode(){
  if (!adminSelectedPath.length){ 
    showModal("Please select a folder first"); 
    return; 
  }
  
  if(!confirm("Do you want to delete this folder from the template? (This will not affect existing projects)")) return;
  
  let parent = adminTreeData;
  for (let i=0;i<adminSelectedPath.length-1;i++){ 
    parent = parent[adminSelectedPath[i]].nodes; 
  }
  parent.splice(adminSelectedPath[adminSelectedPath.length-1],1); 
  adminSelectedPath=[]; 
  
  google.script.run
    .withSuccessHandler(function(result){
      showModal(result);
      loadAdminTree(); // Reload to refresh table
      adminSelectedPath = [];
      renderGroupList();
    })
    .withFailureHandler(function(err){
      showModal("Error: " + err.message);
      loadAdminTree();
    })
    .removeFolderFromTemplateFromUI(adminSelectedPath);
}

/* Inline rename (double-click) - Deprecated, using table now */
function enableInlineRename() {
  // This function is no longer used with the new table design
  return;
  $('#adminTree').off('dblclick');
  
  $('#adminTree').on('dblclick', function(e) {
    e.stopPropagation();
    
    let $target = $(e.target);
    let $row = $target.closest('.list-group-item[data-nodeid]');
    
    if (!$row.length) {
      $row = $target.closest('[data-nodeid]');
    }
    if (!$row.length) {
      $row = $target.parents('.list-group-item').first();
    }
    
    if (!$row.length) return;
    
    let nodeId = $row.attr('data-nodeid') || $row.data('nodeid');
    if (!nodeId) return;
    
    nodeId = parseInt(nodeId);
    if (isNaN(nodeId)) return;
    
    const node = $('#adminTree').treeview('getNode', nodeId);
    if (!node || !Array.isArray(node._path)) return;
    
    let $textSpan = $row.find('.list-group-item-text').first();
    if (!$textSpan.length) {
      $textSpan = $row.find('span:not(.expand-icon):not(.node-icon):not(.check-icon):not(.bi)').first();
    }
    if (!$textSpan.length) {
      $textSpan = $row.find('.node-text').first();
    }
    if (!$textSpan.length || !$textSpan.text().trim()) {
      const nodeText = node.text || '';
      if (nodeText) {
        $textSpan = $row;
      } else {
        $textSpan = $row;
      }
    }
    
    const oldVal = ($textSpan.text().trim() || node.text || '').trim();
    if (!oldVal) return;
    
    if ($('#adminTree').find('input.node-edit-input').length) return;
    
    const $input = $('<input type="text" class="form-control form-control-sm node-edit-input" style="width:100%;padding:2px 5px;" />').val(oldVal);
    $textSpan.css('visibility','hidden'); 
    $textSpan.after($input); 
    $input.trigger('focus').select();
    
    const commit = () => {
      const newVal = ($input.val() || '').trim();
      $input.remove(); 
      $textSpan.css('visibility','');
      if (!newVal || newVal === oldVal) return;
      
      const target = getNodeByPath(node._path); 
      if (!target) return;
      
      const oldName = target.text;
      target.text = newVal;
      const keepPath = node._path.slice(); 
      
      google.script.run
        .withSuccessHandler(function(result){
          showModal(result);
          renderAdminTree();
      try {
        const selNode = findNodeByPathInWidget(keepPath);
            if (selNode) { 
              $('#adminTree').treeview('selectNode', [selNode.nodeId, { silent: true }]); 
              adminSelectedPath = keepPath; 
            }
      } catch(_) {}
        })
        .withFailureHandler(function(err){
          showModal('Error: ' + (err && err.message ? err.message : err));
          target.text = oldName;
          renderAdminTree();
        })
        .renameFolderInTemplateFromUI(keepPath, newVal);
    };
    
    const cancel = () => { 
      $input.remove(); 
      $textSpan.css('visibility',''); 
    };
    
    $input.on('keydown', function (ev) { 
      if (ev.key === 'Enter') { 
        ev.preventDefault(); 
        ev.stopPropagation();
        commit(); 
      } else if (ev.key === 'Escape') { 
        ev.preventDefault(); 
        ev.stopPropagation();
        cancel(); 
      }
    });
    $input.on('blur', commit);
  });
}

function findNodeByPathInWidget(pathArr) {
  const nodes = $('#adminTree').treeview('getEnabled');
  for (const n of nodes) {
    if (Array.isArray(n._path) && n._path.length === pathArr.length) {
      let same = true;
      for (let i = 0; i < pathArr.length; i++) { 
        if (n._path[i] !== pathArr[i]) { 
          same = false; 
          break; 
        } 
      }
      if (same) return n;
    }
  }
  return null;
}

/* Groups per node */
function renderGroupList(){
  const node = getNodeByPath(adminSelectedPath);
  const container = document.getElementById('groupList');
  const folderSettingsCard = document.getElementById('folderSettingsCard');
  const noFolderSelected = document.getElementById('noFolderSelected');
  const groupsSection = document.getElementById('groupsSection');
  
  if (!node){ 
    folderSettingsCard.style.display = 'none';
    return; 
  }
  
  folderSettingsCard.style.display = 'block';
  if (noFolderSelected) noFolderSelected.style.display = 'none';
  
  const toggle = document.getElementById('limitedAccessToggle');
  toggle.disabled = false;
  toggle.checked = !!(node.limitedAccess);
  
  // Always show groups section, but show warning if protection is not enabled
  groupsSection.style.display = 'block';
  const protectionWarning = document.getElementById('protectionWarning');
  if (protectionWarning) {
    if (node.limitedAccess) {
      protectionWarning.style.display = 'none';
    } else {
      protectionWarning.style.display = 'block';
    }
  }
  
  // Allow adding groups even if protection is not enabled
  // Groups will be applied when protection is enabled
  const groupSelect = document.getElementById('groupSelect');
  const roleSelect = document.getElementById('groupRoleSelect');
  if (groupSelect) {
    groupSelect.disabled = false; // Always enabled
  }
  if (roleSelect) {
    roleSelect.disabled = false; // Always enabled
  }
  
  node.groups = node.groups || [];
  node.users = node.users || [];
  
  if (node.groups.length === 0 && node.users.length === 0) {
    container.innerHTML = '<div class="text-muted text-center py-3"><i class="bi bi-inbox"></i> No groups or users specified</div>';
  } else {
    container.innerHTML = '';
    
    // Display groups
    node.groups.forEach((g, idx) => {
      // Support both old format (string) and new format (object)
      const groupName = typeof g === 'string' ? g : (g.name || g);
      const groupRole = typeof g === 'object' && g.role ? g.role : 'reader';
      
      const badge = document.createElement('span');
      badge.className = 'badge bg-primary me-2 mb-2 p-2 d-inline-flex align-items-center';
      badge.style.fontSize = '0.95em';
      badge.style.fontWeight = 'normal';
      badge.style.cursor = 'pointer';
      
      const roleBadge = getRoleBadgeColor(groupRole);
      badge.innerHTML = `
        <i class="bi bi-people me-1"></i> 
        ${groupName}
        <span class="badge ${roleBadge} ms-2" style="font-size: 0.75em; font-weight: normal;">${getRoleLabel(groupRole)}</span>
        <i class="bi bi-x-circle ms-2" onclick="event.stopPropagation(); removeGroupFromNode('${groupName}');"></i>
      `;
      badge.onclick = () => removeGroupFromNode(groupName);
      container.appendChild(badge);
    });
    
    // Display users
    node.users.forEach((u, idx) => {
      // Support both old format (string) and new format (object)
      const userEmail = typeof u === 'string' ? u : (u.email || u);
      const userRole = typeof u === 'object' && u.role ? u.role : 'reader';
      
      const badge = document.createElement('span');
      badge.className = 'badge bg-info me-2 mb-2 p-2 d-inline-flex align-items-center';
      badge.style.fontSize = '0.95em';
      badge.style.fontWeight = 'normal';
      badge.style.cursor = 'pointer';
      
      const roleBadge = getRoleBadgeColor(userRole);
      badge.innerHTML = `
        <i class="bi bi-person me-1"></i> 
        ${userEmail}
        <span class="badge ${roleBadge} ms-2" style="font-size: 0.75em; font-weight: normal;">${getRoleLabel(userRole)}</span>
        <i class="bi bi-x-circle ms-2" onclick="event.stopPropagation(); removeUserFromNode('${userEmail}');"></i>
      `;
      badge.onclick = () => removeUserFromNode(userEmail);
      container.appendChild(badge);
    });
  }
}

function getRoleBadgeColor(role) {
  const colors = {
    'reader': 'bg-secondary',
    'commenter': 'bg-info',
    'writer': 'bg-warning',
    'fileOrganizer': 'bg-primary',
    'organizer': 'bg-danger',
    'owner': 'bg-danger' // For backward compatibility
  };
  return colors[role] || 'bg-secondary';
}

function getRoleLabel(role) {
  const labels = {
    'reader': 'Viewer',
    'commenter': 'Commenter',
    'writer': 'Contributor',
    'fileOrganizer': 'Content manager',
    'organizer': 'Manager',
    'owner': 'Manager' // For backward compatibility, owner maps to Manager
  };
  return labels[role] || role;
}

function toggleLimitedAccess(){
  const node = getNodeByPath(adminSelectedPath);
  if (!node){ 
    showModal("Please select a folder first"); 
    return; 
  }
  
  const isEnabled = document.getElementById('limitedAccessToggle').checked;
  node.limitedAccess = isEnabled;
  
  const groupsSection = document.getElementById('groupsSection');
  groupsSection.style.display = 'block';
  
  const protectionWarning = document.getElementById('protectionWarning');
  const groupSelect = document.getElementById('groupSelect');
  const roleSelect = document.getElementById('groupRoleSelect');
  
  if (isEnabled) {
    if (protectionWarning) protectionWarning.style.display = 'none';
    // Groups can always be added, but they only apply when protection is enabled
    if (groupSelect) groupSelect.disabled = false;
    if (roleSelect) roleSelect.disabled = false;
  } else {
    if (protectionWarning) protectionWarning.style.display = 'block';
    // Keep groups enabled even when protection is off - user can prepare groups in advance
    if (groupSelect) groupSelect.disabled = false;
    if (roleSelect) roleSelect.disabled = false;
    if (!isEnabled && node.groups && node.groups.length > 0) {
      if (confirm('Do you want to remove all groups when disabling protection?')) {
        node.groups = [];
      }
    }
  }
  
  renderGroupList();
  
  google.script.run
    .withSuccessHandler(msg=>{
      renderTreeTable(); // Re-render table to update icons
    })
    .withFailureHandler(e=>{
      showModal("Error: "+(e&&e.message?e.message:e));
      node.limitedAccess = !isEnabled;
      renderGroupList();
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

function addGroupToNode(){
  const node = getNodeByPath(adminSelectedPath);
  if (!node){ 
    showModal("Please select a folder first"); 
    return; 
  }
  
  const groupSelect = document.getElementById('groupSelect');
  const roleSelect = document.getElementById('groupRoleSelect');
  const g = groupSelect.value;
  const role = roleSelect.value || 'reader';
  
  if (!g) {
    showModal("Please select a group from the list");
    return;
  }
  
  node.groups = node.groups || [];
  
  // Check if group already exists (support both old and new format)
  const exists = node.groups.some(grp => {
    const name = typeof grp === 'string' ? grp : (grp.name || grp);
    return name === g;
  });
  
  if (exists) {
    showModal("This group already exists");
    return;
  }
  
  // Add group with role (new format: object)
  node.groups.push({ name: g, role: role });
  groupSelect.value = '';
  roleSelect.value = 'reader';
  renderGroupList();
  
  google.script.run
    .withSuccessHandler(msg => {
      renderTreeTable(); // Re-render table to update icons
    })
    .withFailureHandler(e => {
      showModal("Error: " + (e && e.message ? e.message : e));
      node.groups = node.groups.filter(grp => {
        const name = typeof grp === 'string' ? grp : (grp.name || grp);
        return name !== g;
      });
      renderGroupList();
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

function removeGroupFromNode(g){
  const node = getNodeByPath(adminSelectedPath);
  if (!node) return;
  
  if (!confirm('Do you want to remove the group "' + g + '" from this folder?')) {
    return;
  }
  
  // Remove group (support both old and new format)
  node.groups = (node.groups || []).filter(grp => {
    const name = typeof grp === 'string' ? grp : (grp.name || grp);
    return name !== g;
  });
  renderGroupList();
  
  google.script.run
    .withSuccessHandler(msg => {
      renderTreeTable(); // Re-render table to update icons
    })
    .withFailureHandler(e => {
      showModal("Error: " + (e && e.message ? e.message : e));
      // Restore group (add back with default role)
      node.groups.push({ name: g, role: 'reader' });
      renderGroupList();
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

/* Add user to node */
function addUserToNode(){
  const node = getNodeByPath(adminSelectedPath);
  if (!node){ 
    showModal("Please select a folder first"); 
    return; 
  }
  
  const userEmailInput = document.getElementById('userEmailInput');
  const userRoleSelect = document.getElementById('userRoleSelect');
  const email = userEmailInput.value.trim();
  const role = userRoleSelect.value || 'reader';
  
  if (!email) {
    showModal("Please enter a user email address");
    return;
  }
  
  // Basic email validation
  if (!email.includes('@') || !email.includes('.')) {
    showModal("Please enter a valid email address");
    return;
  }
  
  node.users = node.users || [];
  
  // Check if user already exists (support both old and new format)
  const exists = node.users.some(usr => {
    const userEmail = typeof usr === 'string' ? usr : (usr.email || usr);
    return userEmail.toLowerCase() === email.toLowerCase();
  });
  
  if (exists) {
    showModal("This user already exists");
    return;
  }
  
  // Add user with role (new format: object)
  node.users.push({ email: email, role: role, type: 'user' });
  userEmailInput.value = '';
  userRoleSelect.value = 'reader';
  renderGroupList();
  
  google.script.run
    .withSuccessHandler(msg => {
      renderTreeTable(); // Re-render table to update icons
    })
    .withFailureHandler(e => {
      showModal("Error: " + (e && e.message ? e.message : e));
      node.users = node.users.filter(usr => {
        const userEmail = typeof usr === 'string' ? usr : (usr.email || usr);
        return userEmail.toLowerCase() !== email.toLowerCase();
      });
      renderGroupList();
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

/* Remove user from node */
function removeUserFromNode(email){
  const node = getNodeByPath(adminSelectedPath);
  if (!node) return;
  
  if (!confirm('Do you want to remove the user "' + email + '" from this folder?')) {
    return;
  }
  
  // Remove user (support both old and new format)
  node.users = (node.users || []).filter(usr => {
    const userEmail = typeof usr === 'string' ? usr : (usr.email || usr);
    return userEmail.toLowerCase() !== email.toLowerCase();
  });
  renderGroupList();
  
  google.script.run
    .withSuccessHandler(msg => {
      renderTreeTable(); // Re-render table to update icons
    })
    .withFailureHandler(e => {
      showModal("Error: " + (e && e.message ? e.message : e));
      // Restore user (add back with default role)
      node.users.push({ email: email, role: 'reader', type: 'user' });
      renderGroupList();
      renderTreeTable();
    })
    .saveConfig(adminTreeData);
}

/* Apply permissions to selected folder */
function applyPermissionsToFolder(){
  const node = getNodeByPath(adminSelectedPath);
  if (!node){ 
    showModal("Please select a folder first"); 
    return; 
  }
  
  if (!node.limitedAccess) {
    showModal("You must enable 'Folder Protection' first to apply permissions to the folder");
    return;
  }
  
  if (!node.groups || node.groups.length === 0) {
    showModal("No groups or users specified for this folder. Add groups or users first");
    return;
  }
  
  if (!confirm('Do you want to apply permissions to this folder in all projects?\n\nNote: This operation may take several minutes. You can track progress from the "Groups & Members" â†’ "Recent Logs" tab.')) {
    return;
  }
  
  // Show processing message
  showModal('Processing... This may take several minutes. Please wait...\n\nYou can check the logs in "Groups & Members" tab to see progress.');
  
  google.script.run
    .withSuccessHandler(msg => {
      showModal('âœ… ' + msg + '\n\nCheck the logs in "Groups & Members" tab for detailed information.');
    })
    .withFailureHandler(e => {
      let errorMsg = e.message || e;
      if (errorMsg.includes('timeout') || errorMsg.includes('exceeded')) {
        errorMsg = 'The operation timed out. Some projects may have been processed. Check the logs for details.';
      }
      showModal("âŒ Error: " + errorMsg + '\n\nCheck the logs in "Groups & Members" tab for more details.');
    })
    .applyPermissionsToFolder(adminSelectedPath);
}

/* Save / Apply / Reset */
function adminSaveStructure(){ 
  setButtonLoading('saveBtn', true);
  google.script.run
    .withSuccessHandler(function(msg){
      setButtonLoading('saveBtn', false);
      showModal(msg);
    })
    .withFailureHandler(function(e){
      setButtonLoading('saveBtn', false);
      showModal("Error: "+e.message);
    })
    .saveConfig(adminTreeData); 
}

function adminApplyAll(){
  if(!confirm("Do you want to apply the current structure to all projects? This will:\n1. Share folders with domain\n2. Apply Limited Access protection to folders according to settings\n3. Apply protection to files according to settings\n\nNote: This operation may take several minutes depending on the number of projects.")) return;
  setButtonLoading('applyBtn', true);
  
  // Show progress message
  showModal('Processing... This may take several minutes. Please wait...\n\nStep 1: Applying folder structure and sharing...\nStep 2: Applying Limited Access protection...\n\nYou can check the logs in "Groups & Members" tab to see progress.');
  
  // Step 1: Apply folder structure and sharing
  google.script.run
    .withSuccessHandler(function(msg1){
      // Step 2: Apply Limited Access protection
      google.script.run
        .withSuccessHandler(function(msg2){
          setButtonLoading('applyBtn', false);
          showModal('âœ… Successfully applied!\n\n' + msg1 + '\n' + msg2 + '\n\nCheck the logs in "Groups & Members" tab for detailed information.');
        })
        .withFailureHandler(function(e){
          setButtonLoading('applyBtn', false);
          let errorMsg = e.message || e;
          if (errorMsg.includes('timeout') || errorMsg.includes('exceeded')) {
            errorMsg = 'âš ï¸ Step 2 (Limited Access) timed out. Step 1 completed successfully.\n\n' +
              'The process may have partially completed. Please check the logs in "Groups & Members" tab.\n\n' +
              'You can try running "Apply Protection to All" separately to complete Limited Access setup.';
          } else {
            errorMsg = 'âš ï¸ Step 1 completed, but Step 2 (Limited Access) failed: ' + errorMsg;
          }
          showModal("âš ï¸ " + errorMsg);
        })
        .applyLimitedAccessToAllProjects();
    })
    .withFailureHandler(function(e){
      setButtonLoading('applyBtn', false);
      let errorMsg = e.message || e;
      if (errorMsg.includes('timeout') || errorMsg.includes('exceeded')) {
        errorMsg = 'âš ï¸ Operation timed out. This may happen if there are many projects.\n\n' +
          'The process may have partially completed. Please check the logs in "Groups & Members" tab.\n\n' +
          'You can try running the operation again - it will continue from where it left off.';
      }
      showModal("âŒ Error in Step 1 (Folder Structure): " + errorMsg);
    })
    .applyConfigToAllProjectsSharedDrive();
}

function applyLimitedAccessToAll(){
  if(!confirm("Do you want to apply protection settings to all existing projects? Folders with protection enabled will be protected.\n\nNote: This operation may take several minutes depending on the number of projects.\n\nYou can check the logs in 'Groups & Members' tab to see real-time progress.")) return;
  setButtonLoading('limitedAccessBtn', true);
  
  // Show progress message with auto-refresh instruction
  const progressMsg = 'â³ Processing... This may take several minutes. Please wait...\n\n' +
    'ðŸ“Š You can check the logs in "Groups & Members" tab to see real-time progress.\n\n' +
    'âš ï¸ Do NOT close this window or refresh the page until the operation completes.';
  showModal(progressMsg);
  
  // Start a timeout to check if operation is still running
  const startTime = Date.now();
  const checkInterval = setInterval(function() {
    const elapsed = Math.round((Date.now() - startTime) / 1000);
    if (elapsed > 300) { // 5 minutes
      console.log('Operation is taking longer than expected. Still running...');
    }
  }, 30000); // Check every 30 seconds
  
  google.script.run
    .withSuccessHandler(function(msg){
      clearInterval(checkInterval);
      setButtonLoading('limitedAccessBtn', false);
      showModal('âœ… ' + msg + '\n\nCheck the logs in "Groups & Members" tab for detailed information.');
    })
    .withFailureHandler(function(e){
      clearInterval(checkInterval);
      setButtonLoading('limitedAccessBtn', false);
      let errorMsg = e.message || e;
      if (errorMsg.includes('timeout') || errorMsg.includes('exceeded')) {
        errorMsg = 'âš ï¸ Operation timed out. This may happen if there are many projects.\n\n' +
          'The process may have partially completed. Please check the logs in "Groups & Members" tab.\n\n' +
          'You can try running the operation again - it will continue from where it left off.';
      }
      showModal("âŒ Error: " + errorMsg);
    })
    .applyLimitedAccessToAllProjects();
}

function adminResetTemplate(){
  if(!confirm("Do you want to reset the structure to default?")) return;
  setButtonLoading('resetBtn', true);
  google.script.run
    .withSuccessHandler(function(msg){ 
      setButtonLoading('resetBtn', false);
      showModal(msg); 
      loadAdminTree(); 
    })
    .withFailureHandler(function(e){
      setButtonLoading('resetBtn', false);
      showModal("Error: "+e.message);
    })
    .resetTemplateConfig();
}

function scanDuplicates(){
  setButtonLoading('scanBtn', true);
  google.script.run
    .withSuccessHandler(function(result){
      setButtonLoading('scanBtn', false);
      let message = result.summary + '\n\n';
      if(result.duplicates.length > 0){
        message += 'Duplicate projects:\n';
        result.duplicates.forEach(dup => {
          message += `\nâ€¢ ${dup.projectName}:\n`;
          dup.projects.forEach(proj => {
            message += `  - ${proj.title} (PRJ-${proj.pr})\n`;
          });
        });
      } else {
        message += 'No duplicate projects found!';
      }
      showModal(message);
    })
    .withFailureHandler(function(e){
      setButtonLoading('scanBtn', false);
      showModal("Error: "+e.message);
    })
    .scanForDuplicateProjects();
}


/*************** Access policy & logs ***************/
function loadAccessPolicy(){ 
  google.script.run
    .withSuccessHandler(function(policy){ 
      accessPolicy=policy; 
      renderAccessPolicy(); 
    })
    .getAccessPolicy(); 
}

function renderAccessPolicy(){
  const tbody=document.getElementById('groupsTableBody'); 
  tbody.innerHTML=''; 
  const groups=accessPolicy.groups||{};
  
  if (Object.keys(groups).length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No groups specified</td></tr>';
    return;
  }
  
  Object.keys(groups).forEach(g=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${g}</td>
      <td>${groups[g].email || g}</td>
      <td>
        <select class="form-select form-select-sm role-select" data-group="${g}">
          <option value="reader" ${groups[g].role==='reader'?'selected':''} title="View only">Viewer</option>
          <option value="commenter" ${groups[g].role==='commenter'?'selected':''} title="View and comment">Commenter</option>
          <option value="writer" ${groups[g].role==='writer'?'selected':''} title="Add, edit, and share files">Contributor</option>
          <option value="fileOrganizer" ${groups[g].role==='fileOrganizer'?'selected':''} title="Add, edit, move, delete and share content">Content manager</option>
          <option value="organizer" ${groups[g].role==='organizer' || groups[g].role==='owner'?'selected':''} title="Manage content, people, and settings">Manager</option>
        </select>
      </td>`;
    tbody.appendChild(tr);
  });
  
  // Check if elements exist before accessing them
  const protCopyEl = document.getElementById('protCopy');
  const protWriterCopyEl = document.getElementById('protWriterCopy');
  if (protCopyEl) {
    protCopyEl.checked = !!(accessPolicy.protection && accessPolicy.protection.viewersCanCopyContent);
  }
  if (protWriterCopyEl) {
    protWriterCopyEl.checked = !!(accessPolicy.protection && accessPolicy.protection.copyRequiresWriterPermission);
  }
}

/* Load all groups from Google Workspace and display them with their roles */
function loadGroupsForRoles(){
  const tbody = document.getElementById('groupsTableBody');
  tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Loading groups...</td></tr>';
  
  // Load access policy first to get saved roles
  google.script.run
    .withSuccessHandler(function(policy){
      accessPolicy = policy || { groups: {}, protection: {} };
      const savedGroups = accessPolicy.groups || {};
      
      // Then load all groups from Google Workspace
      google.script.run
        .withSuccessHandler(function(groupsMap){
          const entries = Object.entries(groupsMap || {});
          
          if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No groups found</td></tr>';
            return;
          }
          
          tbody.innerHTML = '';
          
          // Sort by group name
          entries.sort((a, b) => a[0].localeCompare(b[0]));
          
          entries.forEach(([groupName, groupEmail]) => {
            const tr = document.createElement('tr');
            const savedGroup = savedGroups[groupName] || {};
            const savedRole = savedGroup.role || 'reader';
            
            tr.innerHTML = `
              <td>${groupName}</td>
              <td>${groupEmail}</td>
              <td>
                <select class="form-select form-select-sm role-select" data-group="${groupName}">
                  <option value="reader" ${savedRole==='reader'?'selected':''} title="View only">Viewer</option>
                  <option value="commenter" ${savedRole==='commenter'?'selected':''} title="View and comment">Commenter</option>
                  <option value="writer" ${savedRole==='writer'?'selected':''} title="Add, edit, and share files">Contributor</option>
                  <option value="fileOrganizer" ${savedRole==='fileOrganizer'?'selected':''} title="Add, edit, move, delete and share content">Content manager</option>
                  <option value="organizer" ${savedRole==='organizer' || savedRole==='owner'?'selected':''} title="Manage content, people, and settings">Manager</option>
                </select>
              </td>`;
            tbody.appendChild(tr);
          });
        })
        .withFailureHandler(function(err){
          tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading groups: ' + (err.message || err) + '</td></tr>';
        })
        .getGroupsMap();
    })
    .withFailureHandler(function(err){
      // If policy load fails, still try to load groups
      google.script.run
        .withSuccessHandler(function(groupsMap){
          const entries = Object.entries(groupsMap || {});
          if (entries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No groups found</td></tr>';
            return;
          }
          tbody.innerHTML = '';
          entries.sort((a, b) => a[0].localeCompare(b[0]));
          entries.forEach(([groupName, groupEmail]) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${groupName}</td>
              <td>${groupEmail}</td>
              <td>
                <select class="form-select form-select-sm role-select" data-group="${groupName}">
                  <option value="reader" selected title="View only">Viewer</option>
                  <option value="commenter" title="View and comment">Commenter</option>
                  <option value="writer" title="Add, edit, and share files">Contributor</option>
                  <option value="fileOrganizer" title="Add, edit, move, delete and share content">Content manager</option>
                  <option value="organizer" title="Manage content, people, and settings">Manager</option>
                </select>
              </td>`;
            tbody.appendChild(tr);
          });
        })
        .getGroupsMap();
    })
    .getAccessPolicy();
}

/* Load all users with their groups */
function loadAllUsersWithGroups(){
  const tbody = document.getElementById('allUsersTableBody');
  tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Loading users...</td></tr>';
  
  // Also load groups for the filter dropdown
  google.script.run
    .withSuccessHandler(function(groupsMap){
      const groupSelect = document.getElementById('filterByGroup');
      if (groupSelect) {
        // Clear existing options except "All Groups"
        groupSelect.innerHTML = '<option value="">All Groups</option>';
        const entries = Object.entries(groupsMap || {});
        entries.sort((a, b) => a[0].localeCompare(b[0]));
        entries.forEach(([name, email]) => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          groupSelect.appendChild(opt);
        });
      }
    })
    .getGroupsMap();
  
  google.script.run
    .withSuccessHandler(function(users){
      if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No users found</td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      users.forEach(user => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-email', user.email.toLowerCase());
        tr.setAttribute('data-name', (user.name || '').toLowerCase());
        tr.setAttribute('data-fullname', (user.fullName || '').toLowerCase());
        tr.setAttribute('data-groups', (user.groups || []).join(',').toLowerCase());
        
        const userDisplay = user.fullName 
          ? `${user.fullName} <br><small class="text-muted">${user.email}</small>`
          : user.email;
        
        const suspendedBadge = user.suspended 
          ? '<span class="badge bg-warning ms-1">Suspended</span>' 
          : '';
        
        const groupsHtml = user.groups && user.groups.length > 0 
          ? user.groups.map(g => `
              <span class="badge bg-primary me-1 mb-1" style="display: inline-block;">
                ${g}
                <button class="btn-close btn-close-white ms-1" style="font-size: 0.6em; vertical-align: middle;" onclick="removeUserFromGroup('${user.email}', '${g}')" title="Remove from group"></button>
              </span>
            `).join('')
          : '<span class="text-muted">No groups</span>';
        
        tr.innerHTML = `
          <td>
            ${userDisplay}
            ${suspendedBadge}
          </td>
          <td>${groupsHtml}</td>
          <td>
            <button class="btn btn-sm btn-success" onclick="showAddGroupModal('${user.email}')" title="Add to Group">
              <i class="bi bi-plus-circle"></i> Add to Group
            </button>
          </td>`;
        tbody.appendChild(tr);
      });
    })
    .withFailureHandler(function(err){
      tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading users: ' + (err.message || err) + '</td></tr>';
    })
    .getAllUsersWithGroups();
}

/* Filter users table by search input */
function filterUsersTable(){
  const searchInput = document.getElementById('usersSearchInput');
  const filter = searchInput.value.toLowerCase();
  const groupFilter = document.getElementById('filterByGroup') ? document.getElementById('filterByGroup').value : '';
  const rows = document.querySelectorAll('#allUsersTableBody tr');
  
  rows.forEach(row => {
    const email = row.getAttribute('data-email') || '';
    const name = row.getAttribute('data-name') || '';
    const fullname = row.getAttribute('data-fullname') || '';
    const groups = row.getAttribute('data-groups') || '';
    
    const matchesSearch = !filter || email.includes(filter) || name.includes(filter) || fullname.includes(filter);
    const matchesGroup = !groupFilter || groups.includes(groupFilter.toLowerCase());
    
    if (matchesSearch && matchesGroup) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

/* Filter users by group */
function filterUsersByGroup(){
  filterUsersTable();
}

/* Show modal to add user to group */
function showAddGroupModal(userEmail){
  // Store current user email
  window.currentUserForGroup = userEmail;
  
  // Load groups into modal select
  google.script.run
    .withSuccessHandler(function(groupsMap){
      const select = document.getElementById('addGroupSelect');
      if (!select) {
        // Create modal if it doesn't exist
        createAddGroupModal();
        const newSelect = document.getElementById('addGroupSelect');
        populateGroupSelect(newSelect, groupsMap, userEmail);
      } else {
        populateGroupSelect(select, groupsMap, userEmail);
      }
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('addGroupModal'));
      modal.show();
    })
    .withFailureHandler(function(err){
      showModal('Error loading groups: ' + (err.message || err));
    })
    .getGroupsMap();
}

/* Populate group select in modal */
function populateGroupSelect(select, groupsMap, userEmail){
  select.innerHTML = '<option value="">-- Select Group --</option>';
  const entries = Object.entries(groupsMap || {});
  entries.sort((a, b) => a[0].localeCompare(b[0]));
  
  entries.forEach(([name, email]) => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = `${name} (${email})`;
    opt.setAttribute('data-email', email);
    select.appendChild(opt);
  });
  
  // Set user email in modal
  const userEmailInput = document.getElementById('addGroupUserEmail');
  if (userEmailInput) {
    userEmailInput.value = userEmail;
  }
}

/* Create add group modal if it doesn't exist */
function createAddGroupModal(){
  const modalHtml = 
    '<div class="modal fade" id="addGroupModal" tabindex="-1">' +
      '<div class="modal-dialog">' +
        '<div class="modal-content">' +
          '<div class="modal-header">' +
            '<h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add User to Group</h5>' +
            '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="mb-3">' +
              '<label class="form-label">User Email</label>' +
              '<input type="text" id="addGroupUserEmail" class="form-control" readonly>' +
            '</div>' +
            '<div class="mb-3">' +
              '<label class="form-label">Select Group</label>' +
              '<select id="addGroupSelect" class="form-select"></select>' +
            '</div>' +
            '<div class="mb-3">' +
              '<label class="form-label">Role in Group</label>' +
              '<select id="addGroupRole" class="form-select">' +
                '<option value="MEMBER">Member</option>' +
                '<option value="MANAGER">Manager</option>' +
                '<option value="OWNER">Owner</option>' +
              '</select>' +
            '</div>' +
          '</div>' +
          '<div class="modal-footer">' +
            '<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>' +
            '<button type="button" class="btn btn-outline-primary" onclick="addUserToGroupFromModal()">Add to Group</button>' +
          '</div>' +
        '</div>' +
      '</div>' +
    '</div>';
  // Ensure document.body is available before inserting HTML
  if (document.body) {
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  } else {
    // Fallback: wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      });
    } else {
      // DOM is already loaded, but body might not be ready yet
      setTimeout(function() {
        if (document.body) {
          document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
      }, 100);
    }
  }
}

/* Add user to group from modal */
function addUserToGroupFromModal(){
  const userEmail = window.currentUserForGroup;
  const groupSelect = document.getElementById('addGroupSelect');
  const roleSelect = document.getElementById('addGroupRole');
  
  if (!userEmail || !groupSelect || !groupSelect.value) {
    showModal('Please select a group');
    return;
  }
  
  const groupName = groupSelect.value;
  const role = roleSelect ? roleSelect.value : 'MEMBER';
  
  google.script.run
    .withSuccessHandler(function(msg){
      showModal('User added to group successfully');
      bootstrap.Modal.getInstance(document.getElementById('addGroupModal')).hide();
      // Refresh users list
      loadAllUsersWithGroups();
    })
    .withFailureHandler(function(err){
      showModal('Error: ' + (err.message || err));
    })
    .addGroupMember(groupName, userEmail, role);
}

/* Remove user from group */
function removeUserFromGroup(userEmail, groupName){
  if (!confirm(`Are you sure you want to remove ${userEmail} from group "${groupName}"?`)) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(msg){
      showModal('User removed from group successfully');
      // Refresh users list
      loadAllUsersWithGroups();
    })
    .withFailureHandler(function(err){
      showModal('Error: ' + (err.message || err));
    })
    .removeGroupMember(groupName, userEmail);
}

function savePolicy(){
  // Ensure accessPolicy exists
  if (!accessPolicy) {
    accessPolicy = { groups: {}, protection: {} };
  }
  
  const selects=document.querySelectorAll('#groupsTableBody select');
  selects.forEach(sel=>{ 
    const g=sel.getAttribute('data-group'); 
    if (!accessPolicy.groups) accessPolicy.groups = {};
    accessPolicy.groups[g] = accessPolicy.groups[g] || {}; 
    accessPolicy.groups[g].role = sel.value;
    
    // Also store group email if available from the table
    const row = sel.closest('tr');
    if (row) {
      const emailCell = row.querySelector('td:nth-child(2)');
      if (emailCell) {
        accessPolicy.groups[g].email = emailCell.textContent.trim();
      }
    }
  });
  
  accessPolicy.protection = {
    viewersCanCopyContent: document.getElementById('protCopy') ? document.getElementById('protCopy').checked : false,
    copyRequiresWriterPermission: document.getElementById('protWriterCopy') ? document.getElementById('protWriterCopy').checked : false,
    disableLinkSharing: false
  };
  
  google.script.run
    .withSuccessHandler(function(msg){
      showModal("Policy saved successfully");
    })
    .withFailureHandler(e=>showModal("Error: "+e.message))
    .saveAccessPolicy(accessPolicy);
}

function syncAllNewOnly(){ 
  google.script.run
    .withSuccessHandler(function(msg){
      showModal(msg);
    })
    .withFailureHandler(e=>showModal("Error: "+e.message))
    .cronSyncRecent(); 
}

function syncAllAudit(){
  if(!confirm("Do you want to reapply permissions to all files?")) return;
  google.script.run
    .withSuccessHandler(function(msg){
      showModal(msg);
    })
    .withFailureHandler(e=>showModal("Error: "+e.message))
    .cronAuditAll();
}

function loadLogs(){
  const box = document.getElementById('logsBox'); 
  const logContent = document.getElementById('logsContent');
  if (!logContent) return;
  
  box.style.display='block';
  logContent.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Loading logs...</div>';
  
  google.script.run
    .withSuccessHandler(function(rows){
      if(!rows || !rows.length){
        logContent.innerHTML = '<div class="text-muted text-center p-3"><i class="bi bi-info-circle"></i> No logs found. Logs will appear here once operations are performed.</div>';
        return;
      }
      
      // Check if there's an error message
      if(rows.length === 1 && rows[0].error){
        logContent.innerHTML = `<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> ${rows[0].error}</div>`;
        return;
      }
      
      const logHtml = rows.map(r => {
        const levelClass = r.level === 'ERROR' ? 'text-danger' : 
                          r.level === 'WARN' ? 'text-warning' : 
                          r.level === 'INFO' ? 'text-info' : 'text-secondary';
        const timestamp = r.timestamp ? new Date(r.timestamp).toLocaleString('en-US', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit',
          hour12: false 
        }) : 'N/A';
        return `<div class="mb-1">
          <span class="text-muted">[${timestamp}]</span> 
          <span class="${levelClass} fw-bold">${r.level}</span> 
          <span class="text-primary">${r.action || ''}</span> :: 
          <span>${r.message || ''}</span>
          ${r.meta ? `<span class="text-muted">- ${r.meta}</span>` : ''}
        </div>`;
      }).join('');
      
      logContent.innerHTML = logHtml;
    })
    .withFailureHandler(e => {
      logContent.innerHTML = '<div class="text-danger">Error loading logs: ' + (e.message || e) + '</div>';
    })
    .getLogs(100);
}

function testFolderPermissions(){
  const folderId = document.getElementById('testFolderId').value.trim();
  if (!folderId) {
    showModal('Please enter a folder ID');
    return;
  }
  
  const resultDiv = document.getElementById('testPermissionsResult');
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Testing permissions...</div>';
  
  google.script.run
    .withSuccessHandler(function(result){
      if (result.error) {
        resultDiv.innerHTML = '<div class="alert alert-danger">Error: ' + result.error + '</div>';
        return;
      }
      
      const summary = result.summary || {};
      const perms = result.permissions || [];
      
      let html = '<div class="alert alert-info">' +
        '<h6><i class="bi bi-folder"></i> Folder: <strong>' + (result.folderName || 'Unknown') + '</strong></h6>' +
        '<p class="mb-1 small"><code>' + (result.folderId || '') + '</code></p>' +
        '<p class="mb-2"><strong>Summary:</strong></p>' +
        '<div class="row">' +
          '<div class="col-md-6">' +
            '<ul class="mb-0 small">' +
              '<li><strong>Total Permissions:</strong> ' + (summary.total || 0) + '</li>' +
              '<li><strong>Domain:</strong> ' + (summary.domain || 0) + '</li>' +
              '<li><strong>Anyone:</strong> ' + (summary.anyone || 0) + '</li>' +
              '<li><strong>Groups:</strong> ' + (summary.groups || 0) + '</li>' +
              '<li><strong>Users:</strong> ' + (summary.users || 0) + '</li>' +
            '</ul>' +
          '</div>' +
          '<div class="col-md-6">' +
            '<ul class="mb-0 small">' +
              '<li><strong>File Organizer/Manager:</strong> ' + (summary.fileOrganizer || 0) + '</li>' +
              '<li><strong>Writer/Contributor:</strong> ' + (summary.writer || 0) + '</li>' +
              '<li><strong>Commenter:</strong> ' + (summary.commenter || 0) + '</li>' +
              '<li><strong>Reader/Viewer:</strong> ' + (summary.reader || 0) + '</li>' +
            '</ul>' +
          '</div>' +
        '</div>' +
      '</div>';
      
      if (perms.length > 0) {
        html += '<div class="table-responsive">' +
          '<table class="table table-sm table-bordered">' +
            '<thead>' +
              '<tr>' +
                '<th>Type</th>' +
                '<th>Role</th>' +
                '<th>Email/Name/Domain</th>' +
                '<th>Permission ID</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody>';
        
        for (let i = 0; i < perms.length; i++) {
          const p = perms[i];
          // Color code the role badges
          let roleBadgeClass = 'bg-secondary';
          if (p.role === 'organizer' || p.role === 'fileOrganizer') roleBadgeClass = 'bg-danger';
          else if (p.role === 'writer') roleBadgeClass = 'bg-warning';
          else if (p.role === 'commenter') roleBadgeClass = 'bg-info';
          else if (p.role === 'reader') roleBadgeClass = 'bg-success';
          
          // Color code the type badges
          let typeBadgeClass = 'bg-secondary';
          if (p.type === 'domain') typeBadgeClass = 'bg-primary';
          else if (p.type === 'group') typeBadgeClass = 'bg-info';
          else if (p.type === 'user') typeBadgeClass = 'bg-success';
          else if (p.type === 'anyone') typeBadgeClass = 'bg-warning';
          
          html += '<tr>' +
            '<td><span class="badge ' + typeBadgeClass + '">' + (p.type || 'N/A') + '</span></td>' +
            '<td><span class="badge ' + roleBadgeClass + '">' + (p.role || 'N/A') + '</span></td>' +
            '<td>' + (p.name || p.emailAddress || p.displayName || p.domain || 'N/A') + '</td>' +
            '<td><small class="text-muted">' + (p.id || '-') + '</small></td>' +
          '</tr>';
        }
        
        html += '</tbody></table></div>';
      }
      
      resultDiv.innerHTML = html;
    })
    .withFailureHandler(e => {
      resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message || e}</div>`;
    })
    .testFolderPermissions(folderId);
}


/* Populate groups dropdown for folder permissions - lazy loading */
let groupsLoaded = false;
function populateFolderGroupSelect(){
  const sel = document.getElementById('groupSelect');
  if (!sel) return;
  
  // If already loaded, don't reload
  if (groupsLoaded && sel.options.length > 1) {
    return;
  }
  
  sel.innerHTML = '<option value="">-- Loading groups... --</option>';
  groupsLoaded = true;
  
  google.script.run
    .withSuccessHandler(function(map){
      const entries = Object.entries(map || {});
      sel.innerHTML = '<option value="">-- Select Group --</option>';
      
      if (!entries.length){
        const opt = document.createElement('option'); 
        opt.value = ''; 
        opt.textContent = 'No groups available';
        opt.disabled = true;
        sel.appendChild(opt);
        return;
      }
      
      // Sort by group name (display name)
      entries.sort((a,b) => {
        const nameA = a[0] || '';
        const nameB = b[0] || '';
        return nameA.localeCompare(nameB);
      });
      
      entries.forEach(([name, email]) => {
        const opt = document.createElement('option');
        opt.value = name; // Use display name as value
        opt.textContent = `${name} (${email})`;
        opt.setAttribute('data-email', email); // Store email in data attribute
        sel.appendChild(opt);
      });
    })
    .withFailureHandler(function(err){
      sel.innerHTML = '<option value="">-- Error loading groups --</option>';
      console.error('Failed to load groups:', err);
    })
    .getGroupsMap();
}

/* Load approval recipients list */
function loadApprovalRecipients(){
  const container = document.getElementById('recipientsList');
  container.innerHTML = '<div class="text-center text-muted">Loading recipients...</div>';
  
  google.script.run
    .withSuccessHandler(function(recipients){
      if (!recipients || recipients.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">No recipients found. mo.abuomar@dtgsa.com will be used by default.</div>';
        return;
      }
      
      container.innerHTML = '';
      
      recipients.forEach((email, index) => {
        const isDefault = email === 'mo.abuomar@dtgsa.com';
        const badge = document.createElement('div');
        badge.className = 'd-inline-block me-2 mb-2';
        badge.innerHTML = `
          <span class="badge ${isDefault ? 'bg-primary' : 'bg-secondary'} p-2" style="font-size: 0.9em;">
            ${email}
            ${isDefault ? '<span class="ms-2"><i class="bi bi-star-fill"></i> Default</span>' : ''}
            ${!isDefault ? `<button class="btn-close btn-close-white ms-2" onclick="removeApprovalRecipient('${email}')" style="font-size: 0.7em;" title="Remove"></button>` : ''}
          </span>
        `;
        container.appendChild(badge);
      });
    })
    .withFailureHandler(function(err){
      container.innerHTML = '<div class="text-center text-danger">Error loading recipients: ' + (err.message || err) + '</div>';
    })
    .getApprovalRecipients();
}

/* Add approval recipient */
function addApprovalRecipient(){
  const emailInput = document.getElementById('newRecipientEmail');
  const email = emailInput.value.trim();
  
  if (!email) {
    showModal('Please enter an email address');
    return;
  }
  
  if (!email.includes('@')) {
    showModal('Please enter a valid email address');
    return;
  }
  
  // Load current recipients
  google.script.run
    .withSuccessHandler(function(currentRecipients){
      // Check if email already exists
      if (currentRecipients.includes(email.toLowerCase())) {
        showModal('This email is already in the recipients list');
        return;
      }
      
      // Add new recipient
      currentRecipients.push(email.toLowerCase());
      
      // Save updated list
      google.script.run
        .withSuccessHandler(function(msg){
          showModal('Recipient added successfully');
          emailInput.value = '';
          loadApprovalRecipients();
        })
        .withFailureHandler(function(err){
          showModal('Error: ' + (err.message || err));
        })
        .saveApprovalRecipients(currentRecipients);
    })
    .withFailureHandler(function(err){
      showModal('Error: ' + (err.message || err));
    })
    .getApprovalRecipients();
}

/* Remove approval recipient */
function removeApprovalRecipient(email){
  if (email === 'mo.abuomar@dtgsa.com') {
    showModal('Cannot remove the default recipient (mo.abuomar@dtgsa.com)');
    return;
  }
  
  if (!confirm(`Are you sure you want to remove ${email} from the recipients list?`)) {
    return;
  }
  
  // Load current recipients
  google.script.run
    .withSuccessHandler(function(currentRecipients){
      // Remove the email
      const updated = currentRecipients.filter(e => e.toLowerCase() !== email.toLowerCase());
      
      // Save updated list
      google.script.run
        .withSuccessHandler(function(msg){
          showModal('Recipient removed successfully');
          loadApprovalRecipients();
        })
        .withFailureHandler(function(err){
          showModal('Error: ' + (err.message || err));
        })
        .saveApprovalRecipients(updated);
    })
    .withFailureHandler(function(err){
      showModal('Error: ' + (err.message || err));
    })
    .getApprovalRecipients();
}

function init(){ 
  togglePhase(); 
  
  // Load approval recipients on page load
  if (document.getElementById('recipientsList')) {
    loadApprovalRecipients();
  }
  
  // Setup role description display
  setupRoleDescription();
  
  // Load data when Groups & Members tab is shown
  const groupsTab = document.querySelector('[data-bs-target="#groupsAccessTab"]');
  if (groupsTab) {
    groupsTab.addEventListener('shown.bs.tab', function() {
      // Load groups for roles
      if (document.getElementById('groupsTableBody')) {
        loadGroupsForRoles();
      }
    });
  }
  
  // Load data when File Restrictions tab is shown
  const fileRestrictionsTab = document.querySelector('[data-bs-target="#fileRestrictionsTab"]');
  if (fileRestrictionsTab) {
    fileRestrictionsTab.addEventListener('shown.bs.tab', function() {
      loadFileRestrictions();
      checkMonitoringStatus();
    });
  }
}

/* File Restrictions Management */
function loadFileRestrictions() {
  google.script.run
    .withSuccessHandler(function(data) {
      const blocked = data.blocked || [];
      const allowed = data.allowed || [];
      const whitelistEnabled = data.whitelistEnabled || false;
      
      // Update whitelist toggle
      document.getElementById('whitelistEnabled').checked = whitelistEnabled;
      
      // Display blocked extensions
      const blockedContainer = document.getElementById('blockedExtensionsList');
      if (blocked.length === 0) {
        blockedContainer.innerHTML = '<div class="text-center text-muted">No blocked extensions. Add some to start blocking files.</div>';
      } else {
        blockedContainer.innerHTML = '';
        blocked.forEach(ext => {
          const badge = document.createElement('div');
          badge.className = 'd-inline-block me-2 mb-2';
          badge.innerHTML = `
            <span class="badge bg-danger p-2" style="font-size: 0.9em;">
              .${ext}
              <button class="btn-close btn-close-white ms-2" onclick="removeBlockedExtension('${ext}')" style="font-size: 0.7em;" title="Remove"></button>
            </span>
          `;
          blockedContainer.appendChild(badge);
        });
      }
      
      // Display allowed extensions
      const allowedContainer = document.getElementById('allowedExtensionsList');
      if (allowed.length === 0) {
        allowedContainer.innerHTML = '<div class="text-center text-muted">No allowed extensions. All files (except blocked) will be allowed.</div>';
      } else {
        allowedContainer.innerHTML = '';
        allowed.forEach(ext => {
          const badge = document.createElement('div');
          badge.className = 'd-inline-block me-2 mb-2';
          badge.innerHTML = `
            <span class="badge bg-success p-2" style="font-size: 0.9em;">
              .${ext}
              <button class="btn-close btn-close-white ms-2" onclick="removeAllowedExtension('${ext}')" style="font-size: 0.7em;" title="Remove"></button>
            </span>
          `;
          allowedContainer.appendChild(badge);
        });
      }
    })
    .withFailureHandler(function(err) {
      showModal('Error loading file restrictions: ' + (err.message || err));
    })
    .getFileRestrictions();
}

function addBlockedExtension() {
  const ext = document.getElementById('newBlockedExtension').value.trim().toLowerCase();
  if (!ext) {
    showModal('Please enter a file extension');
    return;
  }
  
  // Remove dot if present
  const cleanExt = ext.replace(/^\./, '');
  
  google.script.run
    .withSuccessHandler(function(msg) {
      document.getElementById('newBlockedExtension').value = '';
      loadFileRestrictions();
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
    })
    .addBlockedExtension(cleanExt);
}

function removeBlockedExtension(ext) {
  if (!confirm(`Are you sure you want to remove .${ext} from blocked list?`)) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(msg) {
      loadFileRestrictions();
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
    })
    .removeBlockedExtension(ext);
}

function addAllowedExtension() {
  const ext = document.getElementById('newAllowedExtension').value.trim().toLowerCase();
  if (!ext) {
    showModal('Please enter a file extension');
    return;
  }
  
  // Remove dot if present
  const cleanExt = ext.replace(/^\./, '');
  
  google.script.run
    .withSuccessHandler(function(msg) {
      document.getElementById('newAllowedExtension').value = '';
      loadFileRestrictions();
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
    })
    .addAllowedExtension(cleanExt);
}

function removeAllowedExtension(ext) {
  if (!confirm(`Are you sure you want to remove .${ext} from allowed list?`)) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(msg) {
      loadFileRestrictions();
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
    })
    .removeAllowedExtension(ext);
}

function toggleWhitelist() {
  const enabled = document.getElementById('whitelistEnabled').checked;
  
  google.script.run
    .withSuccessHandler(function(msg) {
      showModal(msg);
    })
    .withFailureHandler(function(err) {
      showModal('Error: ' + (err.message || err));
      document.getElementById('whitelistEnabled').checked = !enabled; // Revert
    })
    .setWhitelistEnabled(enabled);
}

function checkMonitoringStatus() {
  google.script.run
    .withSuccessHandler(function(data) {
      const status = data.enabled ? 'Enabled' : 'Disabled';
      const statusClass = data.enabled ? 'bg-success' : 'bg-secondary';
      document.getElementById('monitoringStatus').textContent = status;
      document.getElementById('monitoringStatus').className = 'badge ' + statusClass;
      document.getElementById('lastCheckTime').textContent = data.lastCheck || 'Never';
    })
    .withFailureHandler(function(err) {
      document.getElementById('monitoringStatus').textContent = 'Error';
      document.getElementById('monitoringStatus').className = 'badge bg-danger';
    })
    .getFileMonitoringStatus();
}

function setupFileMonitoring() {
  if (!confirm('This will set up automatic file monitoring. Files with blocked extensions will be deleted automatically. Continue?')) {
    return;
  }
  
  google.script.run
    .withSuccessHandler(function(msg) {
      showModal(msg);
      checkMonitoringStatus();
    })
    .withFailureHandler(function(err) {
      let errorMsg = err.message || err;
      
      // Check if it's a permissions error
      if (errorMsg.includes('script.scriptapp') || errorMsg.includes('Permission denied')) {
        errorMsg = 'âš ï¸ Permission Required\n\n' +
          'The script needs additional permissions to set up file monitoring.\n\n' +
          'Please follow these steps:\n\n' +
          '1. Open Google Apps Script editor (script.google.com)\n' +
          '2. Find your project and open it\n' +
          '3. Click on "Review permissions" or run any function\n' +
          '4. Click "Advanced" â†’ "Go to [Project Name] (unsafe)"\n' +
          '5. Click "Allow" to grant the required permissions\n' +
          '6. Return here and try again\n\n' +
          'Required permission: Manage triggers for this script';
      }
      
      showModal('Error: ' + errorMsg);
    })
    .setupFileMonitoring();
}

function setupRoleDescription() {
  const roleSelect = document.getElementById('groupRoleSelect');
  const roleDescription = document.getElementById('roleDescription');
  
  if (roleSelect && roleDescription) {
    // Update description on change
    roleSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const description = selectedOption.getAttribute('title') || '';
      roleDescription.textContent = description;
    });
    
    // Set initial description
    if (roleSelect.selectedIndex >= 0) {
      const selectedOption = roleSelect.options[roleSelect.selectedIndex];
      const description = selectedOption.getAttribute('title') || '';
      roleDescription.textContent = description;
    }
  }
}

// Code Analyzer Functions
function runCodeAnalysis() {
  document.getElementById('analysisLoading').style.display = 'block';
  document.getElementById('analysisResults').style.display = 'none';
  document.getElementById('summaryCards').style.display = 'none';
  document.getElementById('autoFixBtn').disabled = true;
  document.getElementById('exportReportBtn').disabled = true;

  google.script.run
    .withSuccessHandler(function(analysis) {
      document.getElementById('analysisLoading').style.display = 'none';
      displayAnalysisResults(analysis);
      document.getElementById('exportReportBtn').disabled = false;
    })
    .withFailureHandler(function(error) {
      document.getElementById('analysisLoading').style.display = 'none';
      showModal('Error running analysis: ' + error.message);
    })
    .analyzeCodebaseEnhanced();
}

function displayAnalysisResults(analysis) {
  // Show summary
  document.getElementById('errorCount').textContent = analysis.summary.totalErrors || 0;
  document.getElementById('warningCount').textContent = analysis.summary.totalWarnings || 0;
  document.getElementById('missingFunctionsCount').textContent = analysis.summary.missingFunctionsCount || 0;
  document.getElementById('unusedFunctionsCount').textContent = analysis.summary.unusedFunctionsCount || 0;
  document.getElementById('summaryCards').style.display = 'flex';

  // Display errors
  if (analysis.errors && analysis.errors.length > 0) {
    let errorsHtml = '';
    for (let i = 0; i < analysis.errors.length; i++) {
      const err = analysis.errors[i];
      const errType = err.type || 'Error';
      const errMessage = err.message || err;
      const funcPart = err.function ? '<br><small>Function: <code>' + err.function + '</code></small>' : '';
      const filePart = err.file ? '<br><small>File: <code>' + err.file + '</code></small>' : '';
      errorsHtml += '<div class="alert alert-danger mb-1" style="font-size: 0.85em;">' +
        '<strong>' + errType + ':</strong> ' + errMessage + funcPart + filePart +
        '</div>';
    }
    document.getElementById('errorsList').innerHTML = errorsHtml;
    document.getElementById('errorsCard').style.display = 'block';
  } else {
    document.getElementById('errorsCard').style.display = 'none';
  }

  // Display warnings
  if (analysis.warnings && analysis.warnings.length > 0) {
    let warningsHtml = '';
    for (let i = 0; i < analysis.warnings.length; i++) {
      const warn = analysis.warnings[i];
      const warnType = warn.type || 'Warning';
      const warnMessage = warn.message || warn;
      const funcPart = warn.function ? '<br><small>Function: <code>' + warn.function + '</code></small>' : '';
      warningsHtml += '<div class="alert alert-warning mb-1" style="font-size: 0.85em;">' +
        '<strong>' + warnType + ':</strong> ' + warnMessage + funcPart +
        '</div>';
    }
    document.getElementById('warningsList').innerHTML = warningsHtml;
    document.getElementById('warningsCard').style.display = 'block';
  } else {
    document.getElementById('warningsCard').style.display = 'none';
  }

  // Display missing functions
  if (analysis.missingFunctions && analysis.missingFunctions.length > 0) {
    let missingHtml = '';
    for (let i = 0; i < analysis.missingFunctions.length; i++) {
      const func = analysis.missingFunctions[i];
      missingHtml += '<div class="alert alert-info mb-1 d-flex justify-content-between align-items-center" style="font-size: 0.85em;">' +
        '<span><code>' + func + '</code> - Function is called but not defined</span>' +
        '<button class="btn btn-sm btn-primary" onclick="suggestFix(\'' + func + '\')" style="font-size: 0.8em;">' +
          '<i class="bi bi-tools"></i> Suggest Fix' +
        '</button>' +
      '</div>';
    }
    document.getElementById('missingFunctionsList').innerHTML = missingHtml;
    document.getElementById('missingFunctionsCard').style.display = 'block';
    document.getElementById('autoFixBtn').disabled = false;
  } else {
    document.getElementById('missingFunctionsCard').style.display = 'none';
  }

  // Display unused functions
  if (analysis.unusedFunctions && analysis.unusedFunctions.length > 0) {
    let unusedHtml = '';
    for (let i = 0; i < analysis.unusedFunctions.length; i++) {
      const func = analysis.unusedFunctions[i];
      unusedHtml += '<div class="alert alert-secondary mb-1" style="font-size: 0.85em;">' +
        '<code>' + func + '</code> - May be unused (not called from UI and not in feature map)' +
      '</div>';
    }
    document.getElementById('unusedFunctionsList').innerHTML = unusedHtml;
    document.getElementById('unusedFunctionsCard').style.display = 'block';
  } else {
    document.getElementById('unusedFunctionsCard').style.display = 'none';
  }

  // Display suggestions
  if (analysis.suggestions && analysis.suggestions.length > 0) {
      const suggestionsHtml = analysis.suggestions.map(sugg => `
      <div class="alert alert-success mb-1" style="font-size: 0.85em;">
        <strong>${sugg.type}:</strong> ${sugg.message}
        ${sugg.functions ? `<br><small>Functions: ${sugg.functions.join(', ')}</small>` : ''}
      </div>
    `).join('');
    document.getElementById('suggestionsList').innerHTML = suggestionsHtml;
    document.getElementById('suggestionsCard').style.display = 'block';
  } else {
    document.getElementById('suggestionsCard').style.display = 'none';
  }

  document.getElementById('analysisResults').style.display = 'block';
  
  // Store analysis for auto-fix
  window.currentAnalysis = analysis;
}

function runAutoFix() {
  if (!window.currentAnalysis) {
    showModal('Please run analysis first');
    return;
  }

  const fixes = [];
  
  // Prepare fixes for missing functions
  if (window.currentAnalysis.missingFunctions && window.currentAnalysis.missingFunctions.length > 0) {
    window.currentAnalysis.missingFunctions.forEach(funcName => {
      fixes.push({
        type: 'add_missing_function',
        functionName: funcName
      });
    });
  }

  if (fixes.length === 0) {
    showModal('No auto-fixable issues found');
    return;
  }

  if (!confirm(`Auto-fix will attempt to fix ${fixes.length} issue(s). Continue?`)) {
    return;
  }

  setButtonLoading('autoFixBtn', true);

  google.script.run
    .withSuccessHandler(function(results) {
      setButtonLoading('autoFixBtn', false);
      let message = `Auto-fix completed:\n`;
      message += `- Fixed: ${results.fixed.length}\n`;
      message += `- Failed: ${results.failed.length}\n`;
      message += '- Skipped: ' + (results.skipped ? results.skipped.length : 0) + '\n\n';
      message += 'Please review the changes and test the application.';
      showModal(message);
      
      // Re-run analysis
      setTimeout(runCodeAnalysis, 2000);
    })
    .withFailureHandler(function(error) {
      setButtonLoading('autoFixBtn', false);
      showModal('Auto-fix error: ' + error.message);
    })
    .autoFixCodebase(fixes);
}

function suggestFix(functionName) {
  showModal(`To fix "${functionName}":\n\n1. Check if the function exists in Code.gs or GroupsAndAccess.gs\n2. If not, add the function implementation\n3. If it exists with a different name, update the UI call\n4. Run analysis again to verify`);
}

function exportAnalysisReport() {
  if (!window.currentAnalysis) {
    showModal('Please run analysis first');
    return;
  }

  let report = '=== CODE ANALYSIS REPORT ===\n\n';
  report += `Generated: ${window.currentAnalysis.timestamp}\n\n`;
  report += `Summary:\n`;
  report += '- Total Errors: ' + (window.currentAnalysis.summary.totalErrors || 0) + '\n';
  report += '- Total Warnings: ' + (window.currentAnalysis.summary.totalWarnings || 0) + '\n';
  report += '- Missing Functions: ' + (window.currentAnalysis.summary.missingFunctionsCount || 0) + '\n';
  report += '- Unused Functions: ' + (window.currentAnalysis.summary.unusedFunctionsCount || 0) + '\n\n';

  if (window.currentAnalysis.errors && window.currentAnalysis.errors.length > 0) {
    report += '=== ERRORS ===\n';
    window.currentAnalysis.errors.forEach(err => {
      report += '- ' + (err.message || err) + '\n';
    });
    report += '\n';
  }

  if (window.currentAnalysis.warnings && window.currentAnalysis.warnings.length > 0) {
    report += '=== WARNINGS ===\n';
    window.currentAnalysis.warnings.forEach(warn => {
      report += `- ${warn.message || warn}\n`;
    });
    report += '\n';
  }

  if (window.currentAnalysis.missingFunctions && window.currentAnalysis.missingFunctions.length > 0) {
    report += '=== MISSING FUNCTIONS ===\n';
    window.currentAnalysis.missingFunctions.forEach(func => {
      report += `- ${func}\n`;
    });
    report += '\n';
  }

  if (window.currentAnalysis.unusedFunctions && window.currentAnalysis.unusedFunctions.length > 0) {
    report += '=== UNUSED FUNCTIONS ===\n';
    window.currentAnalysis.unusedFunctions.forEach(func => {
      report += `- ${func}\n`;
    });
  }

  // Download as file
  const blob = new Blob([report], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `code-analysis-${new Date().toISOString().split('T')[0]}.txt`;
  link.style.display = 'none'; // Hide the link
  
  // Ensure document.body is available before appending
  if (document.body) {
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } else {
    // Fallback: wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        if (document.body) {
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      });
    } else {
      // DOM is already loaded, but body might not be ready yet
      setTimeout(function() {
        if (document.body) {
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }, 100);
    }
  }
  URL.revokeObjectURL(url);
}

// Test Runner Functions
function runAllTests() {
  document.getElementById('testLoading').style.display = 'block';
  document.getElementById('testResults').style.display = 'none';
  document.getElementById('testSummaryCards').style.display = 'none';
  document.getElementById('exportTestReportBtn').disabled = true;
  document.getElementById('runSelectedBtn').disabled = true;

  google.script.run
    .withSuccessHandler(function(results) {
      document.getElementById('testLoading').style.display = 'none';
      displayTestResults(results);
      document.getElementById('exportTestReportBtn').disabled = false;
    })
    .withFailureHandler(function(error) {
      document.getElementById('testLoading').style.display = 'none';
      showModal('Error running tests: ' + error.message);
    })
    .runTestSuite();
}

function displayTestResults(results) {
  // Show summary
  document.getElementById('testPassedCount').textContent = results.passed || 0;
  document.getElementById('testFailedCount').textContent = results.failed || 0;
  document.getElementById('testSkippedCount').textContent = results.skipped || 0;
  document.getElementById('testSuccessRate').textContent = (results.summary && results.summary.successRate) ? results.summary.successRate + '%' : '0%';
  document.getElementById('testSummaryCards').style.display = 'flex';

  // Display test results
  if (results.tests && results.tests.length > 0) {
    const testsHtml = results.tests.map(test => {
      let badgeClass = 'secondary';
      let icon = 'question-circle';
      if (test.status === 'passed') {
        badgeClass = 'success';
        icon = 'check-circle';
      } else if (test.status === 'failed') {
        badgeClass = 'danger';
        icon = 'x-circle';
      } else if (test.status === 'skipped') {
        badgeClass = 'secondary';
        icon = 'skip-forward';
      }

      let detailsHtml = '';
      if (test.details) {
        detailsHtml = '<div class="mt-2"><small><strong>Details:</strong><pre class="bg-light p-2 mt-1 rounded">' + JSON.stringify(test.details, null, 2) + '</pre></small></div>';
      }

      let errorHtml = '';
      if (test.error) {
        errorHtml = '<div class="mt-2"><small class="text-danger"><strong>Error:</strong><pre class="bg-light p-2 mt-1 rounded text-danger">' + test.error + '</pre></small></div>';
      }

      return '<div class="card mb-2">' +
        '<div class="card-body p-2">' +
          '<div class="d-flex justify-content-between align-items-start">' +
            '<div class="flex-grow-1">' +
              '<h6 class="mb-1" style="font-size: 0.9rem;">' +
                '<span class="badge bg-' + badgeClass + ' me-2" style="font-size: 0.75em;">' +
                  '<i class="bi bi-' + icon + '"></i> ' + test.status.toUpperCase() +
                '</span>' +
                '<strong>' + test.name + '</strong>' +
              '</h6>' +
              '<p class="mb-0" style="font-size: 0.85em;">' + (test.message || '') + '</p>' +
              detailsHtml +
              errorHtml +
            '</div>' +
            '<button class="btn btn-sm btn-outline-primary" onclick="runSingleTest(\'' + test.name + '\')" style="font-size: 0.8em;">' +
              '<i class="bi bi-arrow-repeat"></i> Re-run' +
            '</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }).join('');
    document.getElementById('testResultsList').innerHTML = testsHtml;
    document.getElementById('testResults').style.display = 'block';
  } else {
    document.getElementById('testResultsList').innerHTML = '<div class="alert alert-info">No test results available</div>';
    document.getElementById('testResults').style.display = 'block';
  }

  // Store results for export
  window.currentTestResults = results;
}

function runSingleTest(testName) {
  document.getElementById('testLoading').style.display = 'block';

  google.script.run
    .withSuccessHandler(function(result) {
      document.getElementById('testLoading').style.display = 'none';
      showModal(`Test: ${result.name}\nStatus: ${result.status.toUpperCase()}\nMessage: ${result.message}`);
      // Re-run all tests to refresh the view
      setTimeout(runAllTests, 1000);
    })
    .withFailureHandler(function(error) {
      document.getElementById('testLoading').style.display = 'none';
      showModal('Error running test: ' + error.message);
    })
    .runSpecificTest(testName);
}

function runSelectedTests() {
  // This can be enhanced to allow selecting specific tests
  showModal('Feature coming soon: Select specific tests to run');
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function scanFoldersForLimitAccess() {
  document.getElementById('scanLoading').style.display = 'block';
  document.getElementById('scanResults').innerHTML = '';
  document.getElementById('scanSummaryCards').style.display = 'none';
  document.getElementById('exportScanBtn').disabled = true;

  google.script.run
    .withSuccessHandler(function(results) {
      document.getElementById('scanLoading').style.display = 'none';
      displayScanResults(results);
      document.getElementById('exportScanBtn').disabled = false;
    })
    .withFailureHandler(function(error) {
      document.getElementById('scanLoading').style.display = 'none';
      document.getElementById('scanResults').innerHTML = '<div class="alert alert-danger">Error scanning folders: ' + error.message + '</div>';
    })
    .scanAllFoldersForLimitAccess();
}

function displayScanResults(results) {
  if (!results || !results.success) {
    document.getElementById('scanResults').innerHTML = '<div class="alert alert-danger">Error: ' + (results.error || 'Unknown error') + '</div>';
    return;
  }

  // Show summary cards
  document.getElementById('totalFoldersCount').textContent = results.totalFolders || 0;
  document.getElementById('foldersWithLimitAccessCount').textContent = results.foldersWithLimitAccess || 0;
  const withoutLimitAccess = (results.totalFolders || 0) - (results.foldersWithLimitAccess || 0);
  document.getElementById('foldersWithoutLimitAccessCount').textContent = withoutLimitAccess;
  document.getElementById('scanSummaryCards').style.display = 'flex';

  // Store results for export
  window.currentScanResults = results;

  // Display results table
  if (results.results && results.results.length > 0) {
    let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
    html += '<thead class="table-light"><tr>';
    html += '<th>Project</th>';
    html += '<th>PR</th>';
    html += '<th>Folder Name</th>';
    html += '<th>Folder Path</th>';
    html += '<th>Actions</th>';
    html += '</tr></thead><tbody>';

    for (let i = 0; i < results.results.length; i++) {
      const folderItem = results.results[i];
      html += '<tr>';
      html += '<td><strong>' + escapeHtml(folderItem.projectTitle) + '</strong></td>';
      html += '<td><span class="badge bg-info">' + escapeHtml(folderItem.pr) + '</span></td>';
      html += '<td>' + escapeHtml(folderItem.folderTitle) + '</td>';
      html += '<td><small class="text-muted">' + escapeHtml(folderItem.folderPath) + '</small></td>';
      html += '<td>';
      html += '<a href="https://drive.google.com/drive/folders/' + folderItem.folderId + '" target="_blank" class="btn btn-sm btn-outline-primary" title="Open in Drive">';
      html += '<i class="bi bi-box-arrow-up-right"></i> Open</a>';
      html += '</td>';
      html += '</tr>';
    }

    html += '</tbody></table></div>';
    document.getElementById('scanResults').innerHTML = html;
  } else {
    document.getElementById('scanResults').innerHTML = '<div class="alert alert-success">No folders with limit access found.</div>';
  }
}

function compareFolderPermissions() {
  document.getElementById('scanLoading').style.display = 'block';
  document.getElementById('scanResults').innerHTML = '';
  document.getElementById('scanSummaryCards').style.display = 'none';
  document.getElementById('comparisonSummaryCards').style.display = 'none';
  document.getElementById('exportScanBtn').disabled = true;
  document.getElementById('scanResultsTitle').textContent = 'Comparison Results';

  google.script.run
    .withSuccessHandler(function(results) {
      document.getElementById('scanLoading').style.display = 'none';
      displayComparisonResults(results);
      document.getElementById('exportScanBtn').disabled = false;
    })
    .withFailureHandler(function(error) {
      document.getElementById('scanLoading').style.display = 'none';
      document.getElementById('scanResults').innerHTML = '<div class="alert alert-danger">Error comparing permissions: ' + error.message + '</div>';
    })
    .compareFolderPermissionsWithTemplate();
}

function displayComparisonResults(results) {
  try {
    if (!results || !results.success) {
      document.getElementById('scanResults').innerHTML = '<div class="alert alert-danger">Error: ' + (results && results.error ? results.error : 'Unknown error') + '</div>';
      return;
    }

    // Validate results structure
    if (!results.results) {
      document.getElementById('scanResults').innerHTML = '<div class="alert alert-danger">Error: Invalid results structure</div>';
      return;
    }

    // Ensure results.results has required arrays
    if (!results.results.mismatched) results.results.mismatched = [];
    if (!results.results.driveOnly) results.results.driveOnly = [];
    if (!results.results.templateOnly) results.results.templateOnly = [];
    if (!results.results.matched) results.results.matched = [];

    // Show comparison summary cards
    document.getElementById('matchedCount').textContent = results.matched || 0;
    document.getElementById('mismatchedCount').textContent = results.mismatched || 0;
    document.getElementById('driveOnlyCount').textContent = results.driveOnly || 0;
    document.getElementById('templateOnlyCount').textContent = results.templateOnly || 0;
    document.getElementById('comparisonSummaryCards').style.display = 'flex';

    // Store results for export
    window.currentScanResults = results;

    // Display snapshot status badges for each project
    // Group results by project to show snapshot status
    const projectStatusMap = {};
    if (results.results && results.results.mismatched) {
      results.results.mismatched.forEach(item => {
        if (!projectStatusMap[item.projectId]) {
          projectStatusMap[item.projectId] = {
            projectTitle: item.projectTitle,
            projectId: item.projectId
          };
        }
      });
    }
    if (results.results && results.results.matched) {
      results.results.matched.forEach(item => {
        if (!projectStatusMap[item.projectId]) {
          projectStatusMap[item.projectId] = {
            projectTitle: item.projectTitle,
            projectId: item.projectId
          };
        }
      });
    }

    // Load snapshot status for all projects
    const projectIds = Object.keys(projectStatusMap);
    if (projectIds.length > 0) {
      loadProjectSnapshotStatuses(projectIds, projectStatusMap);
    }

    // Display results with tabs
    let html = '<ul class="nav nav-tabs mb-2" role="tablist">';
    html += '<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#mismatchedTab" type="button">Mismatched (' + (results.mismatched || 0) + ')</button></li>';
    html += '<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#driveOnlyTab" type="button">Drive Only (' + (results.driveOnly || 0) + ')</button></li>';
    html += '<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#templateOnlyTab" type="button">Template Only (' + (results.templateOnly || 0) + ')</button></li>';
    html += '<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#matchedTab" type="button">Matched (' + (results.matched || 0) + ')</button></li>';
    html += '</ul>';

    html += '<div class="tab-content">';

    // Mismatched tab
    html += '<div class="tab-pane fade show active" id="mismatchedTab">';
    if (results.results.mismatched && results.results.mismatched.length > 0) {
      html += '<div class="table-responsive"><table class="table table-sm table-hover">';
      html += '<thead class="table-light"><tr>';
      html += '<th>Project</th><th>PR</th><th>Folder Name</th><th>Drive</th><th>Template</th><th>Actions</th>';
      html += '</tr></thead><tbody>';
      for (let i = 0; i < results.results.mismatched.length; i++) {
        const folderItem = results.results.mismatched[i];
        html += '<tr>';
        html += '<td><strong>' + escapeHtml(folderItem.projectTitle) + '</strong>' + getSnapshotBadgeHTML(folderItem.projectId) + '</td>';
        html += '<td><span class="badge bg-info">' + escapeHtml(folderItem.pr) + '</span></td>';
        html += '<td>' + escapeHtml(folderItem.folderTitle) + '<br><small class="text-muted">' + escapeHtml(folderItem.folderPath) + '</small></td>';
        html += '<td><span class="badge bg-' + (folderItem.driveLimitAccess ? 'danger' : 'success') + '">' + (folderItem.driveLimitAccess ? 'Yes' : 'No') + '</span></td>';
        html += '<td><span class="badge bg-' + (folderItem.templateLimitAccess ? 'danger' : 'success') + '">' + (folderItem.templateLimitAccess ? 'Yes' : 'No') + '</span></td>';
        html += '<td><a href="https://drive.google.com/drive/folders/' + folderItem.folderId + '" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-up-right"></i> Open</a></td>';
        html += '</tr>';
      }
      html += '</tbody></table></div>';
    } else {
      html += '<div class="alert alert-success">No mismatched folders found. All folders match between Drive and Template.</div>';
    }
    html += '</div>';

  // Drive Only tab
  html += '<div class="tab-pane fade" id="driveOnlyTab">';
  if (results.results.driveOnly && results.results.driveOnly.length > 0) {
    html += '<div class="table-responsive"><table class="table table-sm table-hover">';
    html += '<thead class="table-light"><tr>';
    html += '<th>Project</th><th>PR</th><th>Folder Name</th><th>Path</th><th>Actions</th>';
    html += '</tr></thead><tbody>';
    for (let i = 0; i < results.results.driveOnly.length; i++) {
      const folderItem = results.results.driveOnly[i];
      html += '<tr>';
      html += '<td><strong>' + escapeHtml(folderItem.projectTitle) + '</strong>' + getSnapshotBadgeHTML(folderItem.projectId) + '</td>';
      html += '<td><span class="badge bg-info">' + escapeHtml(folderItem.pr) + '</span></td>';
      html += '<td>' + escapeHtml(folderItem.folderTitle) + '</td>';
      html += '<td><small class="text-muted">' + escapeHtml(folderItem.folderPath) + '</small></td>';
      html += '<td><a href="https://drive.google.com/drive/folders/' + folderItem.folderId + '" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-up-right"></i> Open</a></td>';
      html += '</tr>';
    }
    html += '</tbody></table></div>';
  } else {
    html += '<div class="alert alert-info">No folders found with limit access in Drive but not in Template.</div>';
  }
  html += '</div>';

  // Template Only tab
  html += '<div class="tab-pane fade" id="templateOnlyTab">';
  if (results.results.templateOnly && results.results.templateOnly.length > 0) {
    html += '<div class="table-responsive"><table class="table table-sm table-hover">';
    html += '<thead class="table-light"><tr>';
    html += '<th>Project</th><th>PR</th><th>Folder Name</th><th>Path</th><th>Actions</th>';
    html += '</tr></thead><tbody>';
    for (let i = 0; i < results.results.templateOnly.length; i++) {
      const folderItem = results.results.templateOnly[i];
      html += '<tr>';
      html += '<td><strong>' + escapeHtml(folderItem.projectTitle) + '</strong>' + getSnapshotBadgeHTML(folderItem.projectId) + '</td>';
      html += '<td><span class="badge bg-info">' + escapeHtml(folderItem.pr) + '</span></td>';
      html += '<td>' + escapeHtml(folderItem.folderTitle) + '</td>';
      html += '<td><small class="text-muted">' + escapeHtml(folderItem.folderPath) + '</small></td>';
      html += '<td><a href="https://drive.google.com/drive/folders/' + folderItem.folderId + '" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-up-right"></i> Open</a></td>';
      html += '</tr>';
    }
    html += '</tbody></table></div>';
  } else {
    html += '<div class="alert alert-info">No folders found with limit access in Template but not in Drive.</div>';
  }
  html += '</div>';

  // Matched tab
  html += '<div class="tab-pane fade" id="matchedTab">';
  if (results.results.matched && results.results.matched.length > 0) {
    html += '<div class="alert alert-success">' + results.matched + ' folders match between Drive and Template.</div>';
    html += '<div class="table-responsive"><table class="table table-sm table-hover">';
    html += '<thead class="table-light"><tr>';
    html += '<th>Project</th><th>PR</th><th>Folder Name</th><th>Status</th><th>Actions</th>';
    html += '</tr></thead><tbody>';
    const matchedCount = Math.min(50, results.results.matched.length);
    for (let i = 0; i < matchedCount; i++) {
      const folderItem = results.results.matched[i];
      html += '<tr>';
      html += '<td><strong>' + escapeHtml(folderItem.projectTitle) + '</strong>' + getSnapshotBadgeHTML(folderItem.projectId) + '</td>';
      html += '<td><span class="badge bg-info">' + escapeHtml(folderItem.pr) + '</span></td>';
      html += '<td>' + escapeHtml(folderItem.folderTitle) + '</td>';
      html += '<td><span class="badge bg-' + (folderItem.driveLimitAccess ? 'danger' : 'success') + '">' + (folderItem.driveLimitAccess ? 'Protected' : 'Not Protected') + '</span></td>';
      html += '<td><a href="https://drive.google.com/drive/folders/' + folderItem.folderId + '" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-up-right"></i> Open</a></td>';
      html += '</tr>';
    }
    html += '</tbody></table></div>';
    if (results.results.matched.length > 50) {
      html += '<div class="alert alert-info">Showing first 50 matched folders. Total: ' + results.matched + '</div>';
    }
  } else {
    html += '<div class="alert alert-warning">No matched folders found.</div>';
  }
  html += '</div>';

  html += '</div>'; // End tab-content

    document.getElementById('scanResults').innerHTML = html;
  } catch (error) {
    console.error('Error displaying comparison results:', error);
    document.getElementById('scanResults').innerHTML = '<div class="alert alert-danger">Error displaying results: ' + error.message + '</div>';
  }
}

function exportScanResults() {
  if (!window.currentScanResults) {
    showModal('Please scan folders first');
    return;
  }

  let report = '=== FOLDER LIMIT ACCESS SCAN REPORT ===\n\n';
  report += 'Generated: ' + new Date().toLocaleString() + '\n\n';
  report += 'Summary:\n';
  report += '- Total Folders Scanned: ' + (window.currentScanResults.totalFolders || 0) + '\n';
  report += '- Folders with Limit Access: ' + (window.currentScanResults.foldersWithLimitAccess || 0) + '\n';
  const withoutLimitAccess = (window.currentScanResults.totalFolders || 0) - (window.currentScanResults.foldersWithLimitAccess || 0);
  report += '- Folders without Limit Access: ' + withoutLimitAccess + '\n';
  report += '\n';

  if (window.currentScanResults.results && window.currentScanResults.results.length > 0) {
    report += '=== FOLDERS WITH LIMIT ACCESS ===\n\n';
    for (let index = 0; index < window.currentScanResults.results.length; index++) {
      const folderItem = window.currentScanResults.results[index];
      report += (index + 1) + '. ' + folderItem.folderTitle + '\n';
      report += '   Project: ' + folderItem.projectTitle + '\n';
      report += '   PR: ' + folderItem.pr + '\n';
      report += '   Path: ' + folderItem.folderPath + '\n';
      report += '   Folder ID: ' + folderItem.folderId + '\n';
      report += '   Drive Link: https://drive.google.com/drive/folders/' + folderItem.folderId + '\n';
      report += '\n';
    }
  } else {
    report += 'No folders with limit access found.\n';
  }

  // Create download link
  const blob = new Blob([report], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const dateStr = new Date().toISOString().split('T')[0];
  a.download = 'folder-limit-access-scan-' + dateStr + '.txt';
  a.style.display = 'none'; // Hide the link
  
  // Ensure document.body is available before appending
  if (document.body) {
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  } else {
    // Fallback: wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        if (document.body) {
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      });
    } else {
      // DOM is already loaded, but body might not be ready yet
      setTimeout(function() {
        if (document.body) {
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      }, 100);
    }
  }
  URL.revokeObjectURL(url);
}

function exportTestReport() {
  if (!window.currentTestResults) {
    showModal('Please run tests first');
    return;
  }

  let report = '=== TEST RUNNER REPORT ===\n\n';
  report += 'Generated: ' + (window.currentTestResults.timestamp || '') + '\n\n';
  report += 'Summary:\n';
  report += '- Total Tests: ' + (window.currentTestResults.totalTests || 0) + '\n';
  report += '- Passed: ' + (window.currentTestResults.passed || 0) + '\n';
  report += '- Failed: ' + (window.currentTestResults.failed || 0) + '\n';
  report += '- Skipped: ' + (window.currentTestResults.skipped || 0) + '\n';
  if (window.currentTestResults.summary) {
    report += '- Success Rate: ' + (window.currentTestResults.summary.successRate || 0) + '%\n';
  }
  report += '\n';

  if (window.currentTestResults.tests && window.currentTestResults.tests.length > 0) {
    report += '=== TEST DETAILS ===\n\n';
    window.currentTestResults.tests.forEach(test => {
      report += 'Test: ' + test.name + '\n';
      report += 'Status: ' + test.status.toUpperCase() + '\n';
      report += 'Message: ' + (test.message || '') + '\n';
      if (test.details) {
        report += 'Details: ' + JSON.stringify(test.details, null, 2) + '\n';
      }
      if (test.error) {
        report += 'Error: ' + test.error + '\n';
      }
      report += '\n';
    });
  }

  // Download as file
  const blob = new Blob([report], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `test-report-${new Date().toISOString().split('T')[0]}.txt`;
  link.style.display = 'none'; // Hide the link
  
  // Ensure document.body is available before appending
  if (document.body) {
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } else {
    // Fallback: wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        if (document.body) {
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      });
    } else {
      // DOM is already loaded, but body might not be ready yet
      setTimeout(function() {
        if (document.body) {
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      }, 100);
    }
  }
  URL.revokeObjectURL(url);
}

document.addEventListener('DOMContentLoaded', function(){ 
  init(); 
  
  // Load admin tree when Folder Structure tab is shown
  const adminStructureTab = document.querySelector('[data-bs-target="#adminStructureTab"]');
  if (adminStructureTab) {
    adminStructureTab.addEventListener('shown.bs.tab', function() {
      console.log('Folder Structure tab shown, checking if tree needs to be loaded');
      const tbody = document.getElementById('treeTableBody');
      if (tbody && (!adminTreeData || adminTreeData.length === 0)) {
        console.log('Tree data is empty, loading...');
        loadAdminTree();
      }
    });
  }
});

// Activity Monitor Functions
function loadSharedDriveActivity() {
  const daysSelect = document.getElementById('activityDays');
  const days = daysSelect.value === 'custom' ? 'custom' : parseInt(daysSelect.value) || 7;
  const maxResults = parseInt(document.getElementById('activityMaxResults').value) || 100;
  
  let startTime, endTime;
  
  if (days === 'custom') {
    const startDate = document.getElementById('activityStartDate').value;
    const endDate = document.getElementById('activityEndDate').value;
    if (!startDate || !endDate) {
      showModal('Please select both start and end dates for custom range');
      return;
    }
    startTime = new Date(startDate).toISOString();
    endTime = new Date(endDate).toISOString();
  } else {
    endTime = new Date().toISOString();
    const start = new Date();
    start.setDate(start.getDate() - days);
    startTime = start.toISOString();
  }
  
  const loadingDiv = document.getElementById('activityLoading');
  const activityList = document.getElementById('activityList');
  const summaryCards = document.getElementById('activitySummaryCards');
  
  loadingDiv.style.display = 'block';
  activityList.innerHTML = '';
  summaryCards.style.display = 'none';
  
  if (days === 'custom') {
    google.script.run
      .withSuccessHandler(displayActivityResults)
      .withFailureHandler(displayActivityError)
      .getSharedDriveActivity(startTime, endTime, maxResults);
  } else {
    google.script.run
      .withSuccessHandler(displayActivityResults)
      .withFailureHandler(displayActivityError)
      .getRecentSharedDriveActivity(days, maxResults);
  }
}

function displayActivityResults(result) {
  const loadingDiv = document.getElementById('activityLoading');
  const activityList = document.getElementById('activityList');
  const summaryCards = document.getElementById('activitySummaryCards');
  
  loadingDiv.style.display = 'none';
  
  if (!result.success || !result.activities || result.activities.length === 0) {
    activityList.innerHTML = `
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> No activity found for the selected time range.
        ${result.note ? `<br><small>${result.note}</small>` : ''}
      </div>
    `;
    return;
  }
  
  // Calculate summary
  const uniqueUsers = new Set(result.activities.map(a => a.user));
  const uniqueFiles = new Set(result.activities.map(a => a.docId));
  const eventTypes = new Set(result.activities.map(a => a.event));
  
  // Update summary cards
  document.getElementById('totalActivitiesCount').textContent = result.totalActivities;
  document.getElementById('uniqueUsersCount').textContent = uniqueUsers.size;
  document.getElementById('uniqueFilesCount').textContent = uniqueFiles.size;
  document.getElementById('eventTypesCount').textContent = eventTypes.size;
  summaryCards.style.display = 'flex';
  
  // Display activities
  const activitiesHtml = result.activities.map(activity => {
    const eventIcon = getEventIcon(activity.event);
    const eventColor = getEventColor(activity.event);
    const time = new Date(activity.time).toLocaleString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric', 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    return `
      <div class="card mb-1">
        <div class="card-body p-2">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center mb-1">
                <span class="badge bg-${eventColor} me-2" style="font-size: 0.75em;">
                  <i class="bi bi-${eventIcon}"></i> ${activity.event}
                </span>
                <strong class="small">${activity.user}</strong>
                <span class="text-muted small ms-2">${time}</span>
              </div>
              <div class="small">
                <i class="bi bi-file-earmark"></i> <strong>${activity.docTitle || 'Unknown'}</strong>
                ${activity.ipAddress && activity.ipAddress !== 'N/A' ? `<br><small class="text-muted">IP: ${activity.ipAddress}</small>` : ''}
              </div>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="testFolderPermissions('${activity.docId}')" title="Test permissions">
              <i class="bi bi-shield-check"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  activityList.innerHTML = activitiesHtml;
}

function displayActivityError(err) {
  const loadingDiv = document.getElementById('activityLoading');
  const activityList = document.getElementById('activityList');
  
  loadingDiv.style.display = 'none';
  activityList.innerHTML = `
    <div class="alert alert-danger">
      <strong>Error loading activity:</strong><br>
      ${err.message || err}
      <br><br>
      <small><strong>Note:</strong> Activity monitoring requires Super Admin privileges and Reports API access. 
      If you don't have access, the system will show limited activity data (file modifications only).</small>
    </div>
  `;
}

function getEventIcon(eventName) {
  const icons = {
    'view': 'eye',
    'edit': 'pencil',
    'download': 'download',
    'create': 'plus-circle',
    'delete': 'trash',
    'upload': 'upload',
    'share': 'share',
    'change_user_access': 'person-plus',
    'change_document_access_scope': 'shield-check',
    'file_change': 'file-earmark'
  };
  return icons[eventName] || 'circle';
}

function getEventColor(eventName) {
  const colors = {
    'view': 'info',
    'edit': 'warning',
    'download': 'primary',
    'create': 'success',
    'delete': 'danger',
    'upload': 'success',
    'share': 'primary',
    'change_user_access': 'warning',
    'change_document_access_scope': 'info',
    'file_change': 'secondary'
  };
  return colors[eventName] || 'secondary';
}

function exportActivityReport() {
  showModal('Export feature coming soon. For now, you can copy the activity data from the screen.');
}

/* Sync template from Drive */
function syncTemplateFromDrive() {
  if (!confirm('This will sync the Folder Structure template with the actual permissions in Google Drive.\n\nThis operation may take a few minutes. Continue?')) {
    return;
  }
  
  setButtonLoading('syncTemplateBtn', true);
  google.script.run
    .withSuccessHandler(function(msg) {
      setButtonLoading('syncTemplateBtn', false);
      showModal('âœ… ' + msg + '\n\nReloading Folder Structure...');
      // Reload the tree after sync
      setTimeout(function() {
        loadAdminTree();
      }, 1000);
    })
    .withFailureHandler(function(error) {
      setButtonLoading('syncTemplateBtn', false);
      showModal('âŒ Error syncing template: ' + error.message);
    })
    .syncTemplateFromDrive();
}

/* Snapshot Management Functions */
function loadSnapshotStatus() {
  google.script.run
    .withSuccessHandler(function(status) {
      displaySnapshotStatus(status);
    })
    .withFailureHandler(function(error) {
      document.getElementById('snapshotStatus').innerHTML = 
        '<div class="alert alert-warning mb-0 py-1"><i class="bi bi-exclamation-triangle"></i> Error loading snapshot status: ' + (error.message || error) + '</div>';
    })
    .getSnapshotStatus();
}

function displaySnapshotStatus(status) {
  const statusDiv = document.getElementById('snapshotStatus');
  if (!statusDiv) return;
  
  let html = '<div class="small">';
  
  // Folders snapshot status
  if (status.folders && status.folders.lastUpdated) {
    const lastUpdated = new Date(status.folders.lastUpdated);
    const formattedDate = lastUpdated.toLocaleString('en-US', { 
      year: 'numeric', 
      month: '2-digit', 
      day: '2-digit', 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: false
    });
    html += '<div class="mb-2"><strong>Folders Snapshot:</strong> Last updated: ' + formattedDate + ' (' + status.folders.totalRows + ' folders)</div>';
  } else {
    html += '<div class="mb-2 text-warning"><strong>Folders Snapshot:</strong> No snapshot data available. Click "Refresh Folders Snapshot" to create one.</div>';
  }
  
  // Groups snapshot status
  if (status.groups && status.groups.lastUpdated) {
    const lastUpdated = new Date(status.groups.lastUpdated);
    const formattedDate = lastUpdated.toLocaleString('en-US', { 
      year: 'numeric', 
      month: '2-digit', 
      day: '2-digit', 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: false
    });
    html += '<div><strong>Groups Snapshot:</strong> Last updated: ' + formattedDate + ' (' + status.groups.totalRows + ' groups)</div>';
  } else {
    html += '<div class="text-warning"><strong>Groups Snapshot:</strong> No snapshot data available. Click "Refresh Groups Snapshot" to create one.</div>';
  }
  
  html += '</div>';
  statusDiv.innerHTML = html;
}

function refreshFoldersSnapshot() {
  if (!confirm('This will refresh the Folders Snapshot by scanning all folders in Drive.\n\nThis operation may take several minutes. You can continue working while it runs.\n\nContinue?')) {
    return;
  }
  
  setButtonLoading('refreshFoldersSnapshotBtn', true);
  google.script.run
    .withSuccessHandler(function(result) {
      setButtonLoading('refreshFoldersSnapshotBtn', false);
      const message = 'âœ… Snapshot refresh started. ' + 
        (result.scannedFolders || 0) + ' folders scanned in ' + 
        (result.elapsedSeconds || 0) + ' seconds.\n\n' +
        'The snapshot is being updated. You can continue working while it runs.';
      showModal(message);
      // Reload status after a delay
      setTimeout(function() {
        loadSnapshotStatus();
      }, 2000);
    })
    .withFailureHandler(function(error) {
      setButtonLoading('refreshFoldersSnapshotBtn', false);
      showModal('âŒ Error refreshing folders snapshot: ' + error.message);
    })
    .scanDriveSnapshot();
}

function refreshGroupsSnapshot() {
  if (!confirm('This will refresh the Groups Snapshot by scanning all groups.\n\nThis operation may take a few minutes. You can continue working while it runs.\n\nContinue?')) {
    return;
  }
  
  setButtonLoading('refreshGroupsSnapshotBtn', true);
  google.script.run
    .withSuccessHandler(function(result) {
      setButtonLoading('refreshGroupsSnapshotBtn', false);
      const message = 'âœ… Groups snapshot refresh completed. ' + 
        (result.scanned || 0) + ' groups scanned in ' + 
        (result.elapsedSeconds || 0) + ' seconds.';
      showModal(message);
      // Reload status after a delay
      setTimeout(function() {
        loadSnapshotStatus();
      }, 2000);
    })
    .withFailureHandler(function(error) {
      setButtonLoading('refreshGroupsSnapshotBtn', false);
      showModal('âŒ Error refreshing groups snapshot: ' + error.message);
    })
    .scanGroupsSnapshot();
}
</script>
</body>
</html>
