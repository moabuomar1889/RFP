<!-- Feature Selector Content - Embedded in Ui_Combined.html -->
<style>
  .feature-selector-container {
    padding: 20px;
  }
  .feature-selector-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }
  .feature-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  .feature-section h3 {
    color: #667eea;
    border-bottom: 2px solid #667eea;
    padding-bottom: 10px;
    margin-bottom: 20px;
  }
  .feature-item {
    padding: 12px;
    margin: 8px 0;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    transition: all 0.3s;
  }
  .feature-item:hover {
    background: #f8f9fa;
    border-color: #667eea;
  }
  .feature-item label {
    cursor: pointer;
    width: 100%;
    display: flex;
    align-items: center;
    margin: 0;
  }
  .feature-item input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
  }
  .feature-description {
    font-size: 0.85em;
    color: #666;
    margin-left: 32px;
    margin-top: 4px;
  }
  .stats-card {
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
  }
  .select-all-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
  }
  .log-output {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 20px;
    border-radius: 10px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    max-height: 500px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    margin-top: 20px;
  }
  .btn-generate-log {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 15px 40px;
    font-size: 1.1em;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }
  .btn-generate-log:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    color: white;
  }
</style>

<div class="feature-selector-container">
  <!-- Header -->
  <div class="feature-selector-header text-center">
    <h1><i class="bi bi-list-check"></i> Feature Selector</h1>
    <p class="mb-0">Select the features you want to keep. Unselected features will be removed from the code.</p>
    <div class="stats-card mt-3">
      <div class="row text-center">
        <div class="col-md-4">
          <h2 id="totalFeatures">0</h2>
          <p class="mb-0">Total Features</p>
        </div>
        <div class="col-md-4">
          <h2 id="selectedFeatures">0</h2>
          <p class="mb-0">Selected</p>
        </div>
        <div class="col-md-4">
          <h2 id="unselectedFeatures">0</h2>
          <p class="mb-0">Will Be Removed</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="select-all-section">
    <button class="btn btn-sm btn-primary me-2" onclick="featureSelectAll()">
      <i class="bi bi-check-all"></i> Select All
    </button>
    <button class="btn btn-sm btn-secondary me-2" onclick="featureDeselectAll()">
      <i class="bi bi-x-square"></i> Deselect All
    </button>
    <button class="btn btn-sm btn-info me-2" onclick="featureSelectEssential()">
      <i class="bi bi-star"></i> Select Essential Only
    </button>
    <button class="btn btn-sm btn-warning me-2" onclick="featureExportSelection()">
      <i class="bi bi-download"></i> Export Selection
    </button>
    <button class="btn btn-sm btn-success" onclick="featureGenerateLog()">
      <i class="bi bi-file-text"></i> Generate Removal Log
    </button>
  </div>

  <!-- Feature Sections -->
  <div id="featuresContainer">
    <!-- Project Management -->
    <div class="feature-section">
      <h3><i class="bi bi-folder"></i> Project Management</h3>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="project" data-feature="create-rfp" checked>
          <strong>Create RFP Project</strong>
        </label>
        <div class="feature-description">Create new RFP (Request for Proposal) projects with folder structure</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="project" data-feature="create-pd" checked>
          <strong>Create PD Folder</strong>
        </label>
        <div class="feature-description">Create Project Delivery folder for approved projects</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="project" data-feature="approval-system" checked>
          <strong>Approval System</strong>
        </label>
        <div class="feature-description">Email-based approval workflow for project creation</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="project" data-feature="pr-number" checked>
          <strong>PR Number Generation</strong>
        </label>
        <div class="feature-description">Automatic PR (Project Request) number generation</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="project" data-feature="check-duplicates">
          <strong>Check Duplicate Projects</strong>
        </label>
        <div class="feature-description">Scan and detect duplicate project names</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="project" data-feature="list-projects">
          <strong>List Projects</strong>
        </label>
        <div class="feature-description">List all bidding projects and projects without PD folder</div>
      </div>
    </div>

    <!-- Template Management -->
    <div class="feature-section">
      <h3><i class="bi bi-diagram-3"></i> Template Management</h3>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="template" data-feature="folder-template" checked>
          <strong>Folder Structure Template</strong>
        </label>
        <div class="feature-description">Define and manage folder structure templates</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="template" data-feature="add-folder" checked>
          <strong>Add Folder to Template</strong>
        </label>
        <div class="feature-description">Add new folders to the template structure</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="template" data-feature="remove-folder" checked>
          <strong>Remove Folder from Template</strong>
        </label>
        <div class="feature-description">Remove folders from the template</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="template" data-feature="rename-folder" checked>
          <strong>Rename Folder in Template</strong>
        </label>
        <div class="feature-description">Rename folders in the template and update existing projects</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="template" data-feature="save-template" checked>
          <strong>Save/Reset Template</strong>
        </label>
        <div class="feature-description">Save template changes or reset to default</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="template" data-feature="apply-to-existing">
          <strong>Apply Template to Existing Projects</strong>
        </label>
        <div class="feature-description">Apply template changes to all existing projects</div>
      </div>
    </div>

    <!-- Permissions & Security -->
    <div class="feature-section">
      <h3><i class="bi bi-shield-lock"></i> Permissions & Security</h3>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="permissions" data-feature="limited-access" checked>
          <strong>Limited Access Folders</strong>
        </label>
        <div class="feature-description">Protect folders with limited access (only specific groups can access)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="permissions" data-feature="group-permissions" checked>
          <strong>Group Permissions</strong>
        </label>
        <div class="feature-description">Assign permissions to Google Groups (Viewer, Commenter, Contributor, etc.)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="permissions" data-feature="apply-permissions" checked>
          <strong>Apply Permissions to Folder</strong>
        </label>
        <div class="feature-description">Apply permissions to a specific folder in all projects</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="permissions" data-feature="apply-to-all" checked>
          <strong>Apply Protection to All Projects</strong>
        </label>
        <div class="feature-description">Apply limited access protection to all existing projects</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="permissions" data-feature="test-permissions" checked>
          <strong>Test Folder Permissions</strong>
        </label>
        <div class="feature-description">Test and view permissions for a specific folder</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="permissions" data-feature="access-policy">
          <strong>Access Policy Management</strong>
        </label>
        <div class="feature-description">Manage access policies for groups (legacy feature)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="permissions" data-feature="domain-sharing" checked>
          <strong>Domain Sharing</strong>
        </label>
        <div class="feature-description">Share folders with domain (make visible to all users)</div>
      </div>
    </div>

    <!-- Groups & Members -->
    <div class="feature-section">
      <h3><i class="bi bi-people"></i> Groups & Members</h3>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="groups" data-feature="list-users" checked>
          <strong>List All Domain Users</strong>
        </label>
        <div class="feature-description">View all users in the domain (getAllDomainUsers)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="groups" data-feature="users-with-groups" checked>
          <strong>Users with Groups</strong>
        </label>
        <div class="feature-description">View all users with their group memberships (getAllUsersWithGroups)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="groups" data-feature="manage-members" checked>
          <strong>Manage Group Members</strong>
        </label>
        <div class="feature-description">Add/remove users from Google Groups</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="groups" data-feature="list-groups" checked>
          <strong>List All Groups</strong>
        </label>
        <div class="feature-description">View all Google Groups in the domain (getGroupsMap)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="groups" data-feature="group-roles">
          <strong>Group Roles Management</strong>
        </label>
        <div class="feature-description">Assign default roles to groups (legacy feature)</div>
      </div>
    </div>

    <!-- File Restrictions -->
    <div class="feature-section">
      <h3><i class="bi bi-file-earmark-x"></i> File Restrictions</h3>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="files" data-feature="block-files" checked>
          <strong>Block File Types</strong>
        </label>
        <div class="feature-description">Block specific file extensions (e.g., EXE, BAT, REG)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="files" data-feature="allow-files" checked>
          <strong>Allow File Types (Whitelist)</strong>
        </label>
        <div class="feature-description">Allow only specific file extensions (whitelist mode)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="files" data-feature="file-monitoring" checked>
          <strong>File Monitoring</strong>
        </label>
        <div class="feature-description">Automatically monitor and delete blocked files</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="files" data-feature="monitoring-trigger" checked>
          <strong>Monitoring Trigger Setup</strong>
        </label>
        <div class="feature-description">Set up time-based trigger for file monitoring</div>
      </div>
    </div>

    <!-- Logging -->
    <div class="feature-section">
      <h3><i class="bi bi-journal-text"></i> Logging</h3>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="logging" data-feature="log-system" checked>
          <strong>Log System</strong>
        </label>
        <div class="feature-description">Log all operations to Google Spreadsheet (logRow function)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="logging" data-feature="view-logs" checked>
          <strong>View Recent Logs</strong>
        </label>
        <div class="feature-description">View and filter recent logs in the UI (getLogs, getRecentLogs)</div>
      </div>
    </div>

    <!-- Email -->
    <div class="feature-section">
      <h3><i class="bi bi-envelope"></i> Email</h3>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="email" data-feature="approval-email" checked>
          <strong>Approval Email</strong>
        </label>
        <div class="feature-description">Send approval request emails (sendApprovalEmail)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="email" data-feature="email-recipients" checked>
          <strong>Email Recipients Management</strong>
        </label>
        <div class="feature-description">Manage approval email recipients list</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="email" data-feature="email-templates" checked>
          <strong>Email Templates</strong>
        </label>
        <div class="feature-description">Email template rendering (renderHtmlFileToString, EmailTemplate.html)</div>
      </div>
    </div>

    <!-- Utilities -->
    <div class="feature-section">
      <h3><i class="bi bi-tools"></i> Utilities</h3>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="utils" data-feature="scan-duplicates" checked>
          <strong>Scan for Duplicates</strong>
        </label>
        <div class="feature-description">Scan and find duplicate project folders</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="utils" data-feature="update-names" checked>
          <strong>Update Folder Names</strong>
        </label>
        <div class="feature-description">Update existing folder names to new format (e.g., PD â†’ Project Delivery)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="utils" data-feature="sync-recent">
          <strong>Sync Recent Projects</strong>
        </label>
        <div class="feature-description">Apply permissions to recently created projects only (cronSyncRecent)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="utils" data-feature="audit-all">
          <strong>Audit All Projects</strong>
        </label>
        <div class="feature-description">Reapply permissions to all projects (cronAuditAll - may be slow)</div>
      </div>
      <div class="feature-item">
        <label>
          <input type="checkbox" data-category="utils" data-feature="test-mapping">
          <strong>Test Tree Mapping</strong>
        </label>
        <div class="feature-description">Test template-to-drive folder mapping (debugging tool)</div>
      </div>
    </div>
  </div>

  <!-- Log Output -->
  <div id="logOutputSection" style="display:none;">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-file-text"></i> Removal Log</h5>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> <strong>Instructions:</strong> Copy this log and send it to the developer. They will remove the unused code based on this log.
        </div>
        <div class="log-output" id="removalLog"></div>
        <button class="btn btn-primary mt-3" onclick="copyLogToClipboard()">
          <i class="bi bi-clipboard"></i> Copy Log to Clipboard
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Feature Selector Functions
function featureUpdateStats() {
  const checkboxes = document.querySelectorAll('#featureSelectorTab input[type="checkbox"][data-feature]');
  const total = checkboxes.length;
  const selected = Array.from(checkboxes).filter(cb => cb.checked).length;
  const unselected = total - selected;

  const totalEl = document.getElementById('totalFeatures');
  const selectedEl = document.getElementById('selectedFeatures');
  const unselectedEl = document.getElementById('unselectedFeatures');
  
  if (totalEl) totalEl.textContent = total;
  if (selectedEl) selectedEl.textContent = selected;
  if (unselectedEl) unselectedEl.textContent = unselected;
}

function featureSelectAll() {
  document.querySelectorAll('#featureSelectorTab input[type="checkbox"][data-feature]').forEach(cb => cb.checked = true);
  featureUpdateStats();
}

function featureDeselectAll() {
  document.querySelectorAll('#featureSelectorTab input[type="checkbox"][data-feature]').forEach(cb => cb.checked = false);
  featureUpdateStats();
}

function featureSelectEssential() {
  featureDeselectAll();
  const essential = [
    'create-rfp', 'create-pd', 'approval-system', 'pr-number',
    'folder-template', 'add-folder', 'remove-folder', 'rename-folder', 'save-template',
    'limited-access', 'group-permissions', 'apply-permissions', 'apply-to-all', 'domain-sharing',
    'list-users', 'users-with-groups', 'manage-members', 'list-groups',
    'log-system', 'view-logs',
    'approval-email', 'email-recipients', 'email-templates'
  ];
  essential.forEach(feature => {
    const cb = document.querySelector(`#featureSelectorTab input[data-feature="${feature}"]`);
    if (cb) cb.checked = true;
  });
  featureUpdateStats();
}

function featureExportSelection() {
  const selection = {};
  document.querySelectorAll('#featureSelectorTab input[type="checkbox"][data-feature]').forEach(cb => {
    selection[cb.dataset.feature] = cb.checked;
  });
  const dataStr = JSON.stringify(selection, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'feature-selection.json';
  link.click();
}

function featureGenerateLog() {
  const selected = [];
  const unselected = [];
  
  document.querySelectorAll('#featureSelectorTab input[type="checkbox"][data-feature]').forEach(cb => {
    if (cb.checked) {
      selected.push(cb.dataset.feature);
    } else {
      unselected.push(cb.dataset.feature);
    }
  });

  if (unselected.length === 0) {
    showModal('No features selected for removal. All features are kept.');
    return;
  }

  // Call backend to generate log
  google.script.run
    .withSuccessHandler(function(log) {
      document.getElementById('removalLog').textContent = log;
      document.getElementById('logOutputSection').style.display = 'block';
      // Scroll to log
      document.getElementById('logOutputSection').scrollIntoView({ behavior: 'smooth' });
    })
    .withFailureHandler(function(error) {
      showModal('Error generating log: ' + error.message);
    })
    .generateFeatureRemovalLog(selected);
}

function copyLogToClipboard() {
  const logText = document.getElementById('removalLog').textContent;
  navigator.clipboard.writeText(logText).then(function() {
    showModal('Log copied to clipboard!');
  }, function(err) {
    showModal('Failed to copy: ' + err);
  });
}

// Initialize when tab is shown
document.addEventListener('DOMContentLoaded', function() {
  // Watch for tab changes
  const featureTab = document.querySelector('button[data-bs-target="#featureSelectorTab"]');
  if (featureTab) {
    featureTab.addEventListener('shown.bs.tab', function() {
      setTimeout(featureUpdateStats, 100);
      // Add event listeners to checkboxes
      document.querySelectorAll('#featureSelectorTab input[type="checkbox"][data-feature]').forEach(cb => {
        cb.addEventListener('change', featureUpdateStats);
      });
    });
  }
});
</script>

